<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Estoque - Indústria de Calçados</title>
  <!-- Ícone da página -->
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABgcAAAYHCAYAAABPN6iqAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAGhHSURBVHhe7N2/qmXnmefxo4ZyX8AkloMGJRO6kxIFShT4AnwBnY1hJmsY8GUYDMpkkDNfgC/AgRKBwYmGjpw0KJA7aF+ApEATlKvO2f/O2Xvt9a71vL/n84GC7tWNqlTa6/3zfLVLH7x5/fGPDwAAAAAAQBsfvHn98Y9//stPjp8DAAAAAACB3rz+/uGfjh8CAAAAAADZxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACA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AADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAAzxL//6z8ePgCLEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAABaefXZR8ePoB1xAAAAAAAAmhEHAAAAAACgGXEAAAAAAACaEQcAAAAAAKAZcQAAAAAAAJoRBwAAAAAAoBlxAAAAAAAAmhEHAAAAAACgGXEAAAAAAACaEQcAAAAAAKAZcQAAAAAAAJoRBwAAAAAAoBlxAAAAAAAAmhEHAAAAAACgGXEAAAAAAACaEQcAAAAAAKAZcQAAAAAAAJoRBwAAAAAAoBlxAAAAAAAAmhEHAAAAAACgGXEAAAAAABjmX/71n48fAQWIAwAAAAAA0Iw4AAAAAAAAzYgDAAAAAADQjDgAAAAAAADNiAMAAAAAANCMOAAAAAAAAM2IAwAAAAAA0Iw4AAAATfz9tz8/fgQAADQlDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAAAU8OqTT48fwTDiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gAAAAAAADQjDgAAAAAAQDPiAAAAAAAANCMOAAAAAABAM+IAAAAAAAA0Iw4AAAAAAEAz4gBQ1t9+9bMXfwAAAAC1ffP1d8ePgALEAaCUWwf/YgEAAAAA3E4cAHa35nBfLAAAAACAl4kDwK5GD/CFAgAAAAA4JQ4Au9l6YC8UAAAAAMBb4gCwuQoDeqEAAAAAgM7EAaA9kQAAAACAbsQBYFOVh/C+TQAAAABAF+IAsJmZhu5CAQAAAADJxAFgEzMP2YUCAAAAANKIAwA3EAkAAAAASCAOACzg2wQAAHB4Lr70AwCoSRwAhku/ELj4AADQxZLB/y3/vwDAdsQBgBUtuSwBAEBla51v1/hrAADrEQcABlrrIgUAAFsaeY4d9dcFAG4jDgBsZOQFCwAA7rX1eXWrnwcAOE8cAIZy4D9v64sXAACcs/e5dK+fFwAQBwB29/RC5nIEAMBo1c6eVX4dANCNOABQTLXLGgAA83PGBACOiQMAhbnEAQCw1ExnyRl+jQCQRhwAmMRMlzsAAPYx85lxxl8zAMxMHACG+vCLb48fsYKZL30AAKzL2RAAWEIcAJicyyAAQD+pZ8C0vx8AqEwcAAiSekkEAMBZDwBYlzgAEMrFEQBgfh2DQKe/VwDYkzgADOe/O7CvjhdKAIDZOb8BAKOJAwCNuGQCANTlX+oAALYkDgCb8O2BWlw6AQBqEAQAgL2IA8BmBIJ6XEQBALYnCLzM7w0AjCcOAJsSCGpyOQUAGEsQAACqEQeAzQkEdbmwAgCsRxAAACoTB4BdCAS1ucQCACwjCAAAsxAHgN0IBPW51AIAvEwQGMPvJwCMJQ4AuxII6nMpAwA4JQgAALMTB4DdffjFtyJBcS6+AACCAACQRRwAyhAJ6nMRBgC6EQQAgFTiAFCOSFCbizEAkE4QAAA6EAeAsgSCulyUAYA0ggAA0I04AJT27lsEQgEAACMIAgBAV+IAMA2RoBaXaABgVr4lAAAgDgATEgkAALiVIAAAcEgcAKbljxzan8s1AFCZIAAAcJk4AEQQCQAAeBAEAACuJg4AUZ5+m0AsAADoQRAAALidOABEEwoAADIJAgAA9xEHgDaEAgCAuQkCAADrEQeAloQCAIA5CAIAAGOIA0B7QsF9XNQBgLUJAgAA44kDAE8IBQAA+xAEAAC2JQ4AXCAUXMfvDwCwlCAAALAfcQDgCkIBAMA6BAEAgBrEAYAbPQ0FYgEAwMsEAQCAesQBgDsJBQAA5wkCAAB1iQMAKxIKAIDufEsAAGAO4gDAIB1CQfLfGwBwPUEAAGA+4gDABtIjAQDQjyAAADA3cQBgQ0nfJkj4ewAAbiMIZPnTb375/gcA0I84ALCTpFAAAOQSBPIIAgDAgzgAUMNskWCmXysAcDtBII9vCQAAx8QBgEJm+DZB5V8bALCcIJAnIQj4PALAOOIAQFEVQ0GlXwsAcD9BIE9CEAAAtiEOAEygQijY8+cGANYjCOQRBACAJcQBgMnsEQq2/LkAgPUJAnkEAQDgXuIAwMRGh4KRf20AYCxBII8gAACsSRwACPE0FNwz0F/jrwEA7EMQyCMIAACjfPDm9cc//vkvPzl+DtN79cmnx4/KMHRlb+8GBj6LAOv6/j/++/hRKX//7c+PH5VgP7qfGJBljxDwi1//8fhRGdYImNs3X393/KiEV599dPyojB+++vL4EazuzevvfXMAoCPfDACAuT39hoAwkME3BM5zZgWAccQBAACACYgBeQQBAGBP4gAAAEBRgkAeQQAAqEIcAAAAKEQQyCMIAAAViQMAAAA7EwTyCAIAQHXiAAAAwA4EgTyCAAAwE3EAAABgI4JAHkEAAJiVOAAAADCQIJBHEAAAEogDAAAAKxME8ggCAEAacQAAAGAlgkAWQQAASCYOAAAA3EkUyCEIAABdiAMAAAALiQIZBAEAoCNxAAAAYAFRYG6CAADQnTgAAABwI2FgToIAAMAjcQAAAOBK/hih+QgCAADniQMAAABEEQQAAF4mDgAAAFzBNwZqEwQAAG4jDgAAALxAGKhJEAAAWE4cAAAAeIYwUIsgAACwDnGAWD989eXxIwAAYEKCAADA+sQBAACAC3xrYD+CAMD8vvn6u+NHQCHiAAAAACUIAgAA2xEHAAAAzvCtgW0IAgAA+xAHYAd/+9XP3v8AAIBuBAEAgP2JA7AzkQAAgA4EAW714RffHj8CWMWrzz46flTGD199efwIhhEHoAiRAACANIIA93A/Atb06rOP3v8A3hIHoBh/5BAAwP6cxZYTBACoQhCA54kDUJhIAADALAQBACoQBOB64gBMQCQAAKAi3xIAoAJBAJYRB2Ai/sghAAD2JggAUIEgAPcTB2BSQgEAAFsRBADY29MYIAjAOsQBCCAUAACsx5nqLUEAgHt88/V3x49uJgbAWOIAhBEKAABYShAAYG+CAGxHHIBgQgEAAC8RBADYmyAA+xAHoAmhAACAdwQBAPYmCMD+xAFoSCgAAOhHEABgb4IA1CIOQHNCAQBALkEAgD08/Y8RCwJQlzgAvCcUAADMTxAAYA9PZwqCAMxBHADOEgoAAOYhCACwB7MDmJs4ALzo6WZvwwcAqEEQAGAP5gPj/PDVl8ePYChxALiZgwAAwD4EAQD2YA4AmcQB4C4OCAAAAJDHfR/yiQNE83WsbTk4AAAAwLzc6/djhsUexAFgCAcKAGBGlc8u/ighAEZwf4e+xAFgOAcNAAAAqMM9HXgQB+jA17JqcQABAACA7bmP12V2xV7EAVqwyNbkYAIAAABjuXcDl4gDtCEQ1CYUAADAtn7x6z++/wFkcceeh3kVexIHaMWCOweHGAAAGEMQgFzu0vMxp2Jv4gDtWHjn4nADAAD3EQQglzvzvMynqEAcoCUL8JwcegAA4DqCAORyN56fuRRViAO0ZSGem8MQAAAcEgQglzswMII4QGs/fPWlSBDAAQkAgK4EAcglCOQxh6IacQB8iyCGgxMAAB0IApDLvTaX2RMVffDm9cc//vkvPzl+Dm29+uTT40dM7sMvvj1+BABDfP8f/338qJS///bnx49KqLRXVx7G/Ok3vzx+RCNdQ0Cl9QFGqbz3cD9RgKrevP5eHIBLRIJMLhcAjCQOLFNpf648oBEH+ukaBN6ptDbA2irvN6xHGKAycQCuIBLkctkAYG3iwDKV9uTKwxpxoIfuQeCpSmsDrKHyHsN6BAFmIQ7ADUSCbC4eAKxBHFim0j5ceXAjDuQSBM6rtDbAUpX3FdYlCjAbcQAWEAnyuYQAsJQ4sEylvbfyEEccyCIIvKzS2gC3qryfsB5BgJmJA3AnoSCfCwkAtxAHlqm031Ye5ogD8xMEblNpbYBrVN5DWI8gQApxAFYkFORzOQHgJeLAMpX22MqDHXFgToLAcpXWBrik8r7BukQB0ogDMIhQkM9FBYBzxIFlKu2rlYc84sA8BIF1VFob4KnKewXrEQNIJw7ABoSCbC4sADwlDixTaT+tPPARB2oTBNZXaW2AyvsD6xEE6EQcgI0JBdlcXgAQB5aptIdWHv6IA/UIAuNUWhfoq/KewHoEAboSB2BHQkE2lxmAnsSBZSrtm5UHQeJADYLANiqtC/RSeR9gHWIAvCUOQBFCQTYXG4A+xIFlKu2VlYdC4sB+BIFtVVoT6KHy2s86BAE4JQ5AQUJBNhcdgGziwDKV9sfKAyJxYFuCwH4qrQnkqrzesw5BAJ4nDkBxQkE2lx6APOLAMpX2xMrDInFgPEGghkprAlkqr/GsQxCA64kDMBGhIJsLEEAGcWCZSvtg5cGRODCGIFBLpfWADJXXddYhCMAy4gBMSijI5kIEMC9xYJlKe1/lIZI4sB5BoKZKawFzq7yWsw5BAO4nDkAAoSCbCxLAXMSBZSrtd5UHSuLAfQSB2iqtA8yp8vrNOgQBWJc4AGGEgmwuTAD1iQPLVNrjKg+XxIHbCQLzqLQOMJfK6zbrEAVgDHEAggkFuVycAOoSB5aptLdVHjKJA9cRBOZTaQ1gDpXXatYhCMB44gA0IRTkcpECqEUcWKbSflZ54CQOPE8UmE+ld5/6Kq/PrEMQgG2JA9CQUJDL5Qpgf+LAMtX2sKoDKHHglCAwr2rvPTVVXY9ZjyAA+xEHoDmhIJfLFsA+xIFlqu1bVYdR4sBbgsD8qr3z1FJ1DWY9ggDUIA4A7wkFuVy+ALYjDixTba+qOpjqHAcEgQzV3nXqqLrush5BAOoRB4CzhIJcLmQAY4kDy1Tbn6oOqbrFAUEgR7V3nBqqrrWsRxCA2sQB4EVCQS6XNID1iQPLVNuTqg6sOsQBQSBLtXeb/VVdX1mPIADzEAeAmwgFuVzcANYhDixTbR+qOrxKjQOCQJ5q7zT7qrqmsh5BAOYkDgCLiATZXOYAlhMHlqm291QdZCXFAUEgU7V3mf1UXUdZjyAA8xMHgLsJBblc7gBuJw4sU23PqTrUmj0OCAKZqr2/7Kfq2sl6BAHIIg4AqxIKcrn0AVxHHFim2j5TdcA1YxwQBHJVe2/ZR9X1kvUIApBLHACGEQpyuQgCXCYOLFNtb6k67JolDggCuaq9q+yn6jrJOgQB6EEcADYhFORyQQQ4JA4sU20/qTr0qhwHBIFc1d5P9lN1bWQdggD0Iw4AmxMKcrk4AogDS1XbQ6oOwKrFAUEgV7V3kv1UXQ9ZhyAAvYkDwK6EglwulEBX4sAy1faNqsOwCnFAEMhV7T1kP1XXQNYjCgAP4gBQiVCQy0UT6EQcWKbaXlF1MLZXHBAEclV799hP1XWP9QgCwDFxAChJKMjlAgqkEweWqbY/VB2SbRkHBIFc1d439lN1rWM9ggDwHHEAKE8oyORSCqQSB5apti9UHZiNjgOCQK5q7xj7qbq+sR5BALiWOABMRSjI5LIKJBEHlqm2F1Qdno2IA4JArmrvFfupuqaxHkEAWEIcAKYlFGRyiQVmJw4sU239rzpIWysOCAK5qr1L7KfqOsZ6BAHgXuIAMD2RIJfLLTAjcWCZamt+1aHaPXFAEMhV7f1hP1XXLtYjCABrEgeAKEJBLpdeYBbiwDLV1vmqA7Zb44AgkKvaO8N+qq5XrEcQAEYRB4BYQkEul2GgMnFgmWpre9Vh2zVxQBDIVe09YT9V1yjWJQoAo4kDQAtCQS6XZKAacWCZaut51cHbpTggCOSq9m6wn6rrEusSBIAtiQNAO0JBLpdnoAJxYJlqa3jVIdzTOCAI5Kr2PrCvqusR6xEEgL2IA0BrQkEul2pgL+LAMtXWbcM4tlbtHWBf1qB8ggBQgTgA8A9CQSYXbWBr4sAy1dZrgzlGq/aZZ3/WnXyCAFCNOABwhlCQySUc2II4sEy1NdqQjhGqfc7Zn7UmnyAAVCYOALxAKMjkcg6MIg4sU21dNrBjLdU+2+zP+pJPEABmIQ4A3EAoyOTSDqxJHFim2lpseMc9qn2e2Z81JZ8gAMxIHABYSCjI5DIP3EscWKba+muQx62qfYbZn3UknyAAzE4cAFiBUJDJJR9YQhxYptqaa6jHNap9btmftaMHUQBIIQ4ArEwoyOTyD1xLHFim2jprwMcl1T6r7M960YMgACQSBwAGEQlyGQoAzxEHlqm2thr2cazaZ5R9WSN6EASAdOIAwAaEglwGBcAxcWCZauupwR8PBT+X7Mu60IMgAHQiDgBsTCjIZHgAvCMOLFNtHTUE7KvaZ5F9WQt6EASArsQBgB0JBZkMFaA3cWCZamungWAv1T5/7Mv734MgACAOAJQhFGQybIB+xIFlqq2XhoP5qn3m2J/3Pp8gAHBIHAAoSCjIZAgBPYgDy1RbIw0JM1X7nLE/73o+QQDgMnEAoDihIJPhBOQSB5apti4aGOao9tlif97vfIIAwHXEAYCJCAWZDC0giziwTLW10PBwbtU+T+zPO92DKABwG3EAYFJCQSbDDJifOLBMtfXPIHE+1T5D7M973IMgALCcOAAQQCjIZMgBcxIHlqm25hkqzqHa54b9eXd7EAQA1iEOAIQRCjIZfsA8xIFlqq1zBox1VfussD/vaw+CAMD6xAGAYEJBJkMRqE0cWKba2mbYWE+1zwj78o72IAgA/P/27h05sq2Komgigw5AMzBFqF00sZxqAEEzaIHKAAOeSqXSJ3Pn/eyz1xgRZSDv5T3nGmtGJvsSBwACiAQzGUmgJ3Ggpts7zfDYQ7dzwbncywyCAMBxxAGAMELBTMYT6EMcqOn2HjNCnqfbWeBc7mIGQQDgHOIAQDChYCajCpxLHKjp+O4ySh6r4xngHO5eBkEA4HziAACXi1AwlqEFjicO1HR8Xxko99fxuXMO9y2DIADQizgAwG+EgpkMMHAMcaCm4zvKWLmfjs+bc7hnGUQBgJ7EAQA+JRTMZJSB/YgDNR3fS0bLbXV8xpzD3cogCAD0Jw4AcDWhYCZjDWxLHKjp+C4yYN6v43PlHO5TBkEAYC3iAAAlQsFMRhy4nzhQ0/H9Y8ys6/g8OZ47lEEQAFiXOADA3YSCmQw7UCMO1HR85xg2b9PxGXI89yaDIAAwgzgAwKaEgpkMPnA9caCm43vGyPm1js+N47krGQQBgHnEAQB2IxTMYwSCr4kDNV3fL0bP93V9XhzH3cggCADMJg4AcAihYB7DELxPHKjp+k4xgP7U9RlxHPchgyAAkEMcAOBwQsE8BiP4SRyo6foeSR9Duz4XjpN+B1IIAgCZxAEATiMSzGRIIp04UNP53ZE4jnZ+Huwv8cwnEgQAEAcAaEEomMm4RCJxoKbz+yJlKO38DNhfyjlPJwgA8Jo4AEA7QsFMRidSiAM13d8RU4fT7p87+5p6rvmdKADAe8QBAFoTCmYyRjGZOFDT/b0wZUTt/jmzvylnma8JAgB8RRwAYBlCwUyGKqYRB2pWeBesOqqu8Nmyv1XPL7cRBAC4hTgAwJKEgpkMWEwgDtSscP9XGldX+DzZ30pnljpBAIAqcQCA5QkFMxm2WJU4ULPKne88tq7yGbKvzmeU7QgCAGxBHABgFKFgJoMXKxEHala6553G15U+N/bT6UyyH0EAgK2JAwCMJRTMYwRjBeJAzYr3+6xBdsXPiu2ddf44liAAwJ7EAQAiCAXzGMfoShyoWfVOHzXQrvr5sK2jzhvnEgQAOIo4AEAcoWAeoxmdiAM1q9/jPUbb1T8TtrHH2aIfQQCAM4gDAEQTCuYxpnE2caBm0t2tjLmT/vu5X+UMsR5BAICziQMAIBKMZWzjDOJAjftKOkEggyAAQCfiAAC8IRTMZHjkKOJAjTtKIkEggyAAQFfiAAB8QiiYyQjJnsSBGveSFIJABkEAgBWIAwBwJaFgJoMkWxMHatxFJhMEMggCAKxGHACAAqFgJuMkWxAHatw/JhIF5hMEAFiZOAAAdxIKZjJUUiUO1LhzTCEIzCcIADCFOAAAGxIKZjJacgtxoMY9Y2WCQAZRAIBpxAEA2IlQMJMBk6+IAzXuFqsRBDIIAgBMJg4AwAGEgpmMmbxHHKhxn1iBIJBBEAAghTgAAAcTCuYxavKaOFDjHtGVIJBBEAAgkTgAACcSCuYxcCIO1Lg7dCIIZBAEAEgnDgBAE0LBPMbOTOJAjfvC2QSBDIIAAPwkDgBAMyLBTIbPHOJAjTvCGQSBDIIAALxPHACAxoSCmYygs4kDNe4FRxEEMggCAPA1cQAAFiEUzGQQnUccqHEX2JMgkEEQAIDbiAMAsCChYCbj6AziQI3zz9YEgQyCAADUiQMAsDihYCZD6brEgRpnni0IAhkEAQDYhjgAAIMIBTMZTdciDtQ459xDFJhPEACA7YkDADCUUDCTAbU/caDG2eZWgsB8ggAA7EscAIAAQsFMxtSexIEa55lrCALzCQIAcBxxAADCCAUzGVb7EAdqnGE+IgjMJwgAwDnEAQAIJhTMZGQ9lzhQ49zymiAwnyAAAOcTBwCAy0UoGMvgejxxoMZZRRCYTxAAgF7EAQDgN0LBTMbXY4gDNc5nJkFgPkEAAPoSBwCATwkFMxli9yMO1DiTOQSB+QQBAFiDOAAAXEUkmMsouy1xoMY5nE0QmE8QAID1iAMAwM2EgrkMtPcTB2qcvXkEgfkEAQBYmzgAANxFKJjLWFsjDtQ4bzMIAvMJAgAwhzgAAGxGKJjLcHs9caDGGVuXIDCfIAAAM4kDAMAuhIK5jLifEwdqnKv1iAKzCQIAMJ84AADsTiiYy6D7O3GgxllagyAwmyAAAFnEAQDgUELBXMbd/xEHapyfvgSB2QQBAMglDgAApxEK5koeesWBmuQz05EgMJ8oAACIAwBAC0LBXGmjrzhQk3ZOOhIE5hMEAIDXxAEAoB2hYK6EAVgcqEk4Gx0JAvMJAgDAR8QBAKA1oWCuqWOwOFAz9Tx0JAjMJwgAANcQBwCAZQgFc00ahsWBmklnoCNBYD5BAAC4lTgAACxHJJht9ZFYHKhZ/bl3JAjMJwgAAPcQBwCApQkFs604GIsDNSs+644EgfkEAQBgK+IAADCGUDDbKuOxOFCzyvPtSBCYTxAAAPYgDgAAIwkFs3UeksWBms7PtCNBYD5BAADYmzgAAIwnFMzXaVgWB2o6PcOuBIH5BAEA4EjiAAAQRSiY7+yRWRyoOfu5dSYKzCcKAABnEAcAgFhCwXxnDM7iQM0Zz6ozQWA+QQAAOJs4AAAgFEQ4anwWB2qOej6dCQLzCQIAQCfiAADAG0LBfHsO0eJAzZ7PpDNBYD5BAADoShwAAPiEUJBhy2FaHKjZ8hl0JwjMJwgAACsQBwAAriQU5LhnqBYHau75zFcgCMwnCAAAqxEHAAAKhIIstwzX4kDNLZ/xKgSB+QQBAGBl4gAAwB1EgjxfjdjiQM1Xn+sqBIH5BAEAYIqnx+fLw9s/AgBwnR/fv738I8Pzv/798g8u/w8Cf/xjLu96AGAi3xwAANiYbxTM95d//POX//3nv/31cvHNgbLVvjkgBGQQAwCAyfysEADAzoSCud4GghWIA3WCQAZBAABIIQ4AABxIKJhntUAgDtxGEMggCAAAicQBAICTCAWzrBIJxIGvCQIZBAEAIJ04AADQgFAwR/dIIA58TBSYTxAAAPhJHAAAaEYomKFrJBAHfiUIzCcIAAC8TxwAAGhMKJihUygQBwSBFKIAAMDnxAEAgEUIBTOcHQpS44AgkEEQAAC4njgAALAgoWCOo2NBUhwQBDIIAgAANeIAAMDihII5jggF0+OAIJBBEAAAuJ84AAAwiFAwx16hYGIcEAQyCAIAANsSBwAABhIJZtkyFEyJA4JABkEAAGA/4gAAwHBCwSz3hoKV44AgkEEQAAA4hjgAABBEKJijGglWiwOCQAZBAADgeOIAAEAooWCWa2PBCnFAEMghCgAAnEccAABAKBjoo1jQNQ6QQxAAAOhBHAAA4BdCwUx/xAJxgDMIAgAA/YgDAAB8SCgAqgQBAIDexAEAAK4iFABfEQQAANYhDgAAcDOhAPiDIAAAsCZxAACAuwgFkEcQAABYnzgAAMBmhAKYSxAAAJjl6fH58vD2jwAAUPHj+7eXf8AM7jQAwFziAAAAmzMowrqEPgCADH5WCACAQ/jZIehLCAAAyOL/cwAAgFMIBXA+QQAAIJc4AADA6YQCOI4gAADARRwAAKAboQC2JwgAAPCWOAAAQFtCAdQJAgAAfEYcAABgCUIBfE0QAADgWuIAAADLEQrgJ0EAAIAKcQAAgKUJBSQSBAAAuJc4AADAGEIBkwkCAABs6enx+fLw9o8AALCiH9+/vfyDKZxpAAD24psDAACM5hsFrEYMAABgb35WCACAKEIBXQkCAAAcyc8KAQAQxU+00ImfwgIA4Ey+OQAAQDTfJuBIQgAAAB34WSEAAHhFKGAPggAAAN2IAwAA8AGhgHsIAgAAdCYOAADAFYQCriEIAACwCnEAAABuJBTwmiAAAMCKxAEAALiDUJBJEAAAYHXiAAAAbEQomE0QAABgEnEAAAB2IBTMIAgAADCVOAAAADsTCtYiCAAAkEAcAACAAwkFPQkCAACkeXp8vjy8/SMAALCPH9+/GaIb8TwAAEjmmwMAAHAi3yY4lhgAAAB+VggAAFoRCvYhCAAAwK/EAQAAaEoouI8gAAAAHxMHAABgAULBdQQBAAC4jjgAAACLEQp+JQgAAMDtnh6fLw9v/wgAAPT14/u3l3/JfAYAAHAf3xwAAIABEr5RIAYAAMA2/KwQAAAMNCkUCAIAALA9cQAAAIZbMRQIAgAAsC9xAAAAgnQOBYIAAAAcRxwAAIBgZ8cCQQAAAM4hDgAAAC+OiAWCAAAAnE8cAAAAPnRvLBACAACgJ3EAAAAAAADCPD0+Xx7e/hEAAAAAAJhNHAAAAAAAgDDiAAAAAAAAhBEHAAAAAAAgjDgAAAAAAABhxAEAAAAAAAgjDgAAAAAAQBhxAAAAAAAAwogDAAAAAAAQRhwAAAAAAIAw4gAAAAAAAIQRBwAAAAAAIIw4AAAAAAAAYcQBAAAAAAAIIw4AAAAAAEAYcQAAAAAAAMKIAwAAAAAAEEYcAAAAAACAMOIAAAAAAACEEQcAAAAAACCMOAAAAAAAAGHEAQAAAAAACCMOAAAAAABAGHEAAAAAAADCiAMAAAAAABBGHAAAAAAAgDDiAAAAAAAAhBEHAAAAAAAgjDgAAAAAAABhxAEAAAAAAAgjDgAAAAAAQBhxAAAAAAAAwogDAAAAAAAQRhwAAAAAAIAw4gAAAAAAAIQRBwAAAAAAIIw4AAAAAAAAYcQBAAAAAAAIIw4AAAAAAEAYcQAAAAAAAMKIAwAAAAAAEEYcAAAAAACAMOIAAAAAAACEEQcAAAAAACCMOAAAAAAAAGHEAQAAAAAACCMOAAAAAABAGHEAAAAAAADCiAMAAAAAABBGHAAAAAAAgDDiAAAAAAAAhBEHAAAAAAAgjDgAAAAAAABhxAEAAAAAAAgjDgAAAAAAQBhxAAAAAAAAwogDAAAAAAAQRhwAAAAAAIAw4gAAAAAAAIQRBwAAAAAAIIw4AAAAAAAAYcQBAAAAAAAIIw4AAAAAAEAYcQAAAAAAAMKIAwAAAAAAEEYcAAAAAACAMOIAAAAAAACEEQcAAAAAACCMOAAAAAAAAGHEAQAAAAAACCMOAAAAAABAGHEAAAAAAADCiAMAAAAAABBGHAAAAAAAgDDiAAAAAAAAhBEHAAAAAAAgjDgAAAAAAABhxAEAAAAAAAgjDgAAAAAAQBhxAAAAAAAAwogDAAAAAAAQRhwAAAAAAIAw4gAAAAAAAIQRBwAAAAAAIIw4AAAAAAAAYcQBAAAAAAAIIw4AAAAAAEAYcQAAAAAAAMKIAwAAAAAAEEYcAAAAAACAMOIAAAAAAACEEQcAAAAAACCMOAAAAAAAAGHEAQAAAAAACCMOAAAAAABAGHEAAAAAAADCiAMAAAAAABBGHAAAAAAAgDDiAAAAAAAAhBEHAAAAAAAgjDgAAAAAAABhxAEAAAAAAAgjDgAAAAAAQBhxAAAAAAAAwogDAAAAAAAQRhwAAAAAAIAw4gAAAAAAAIQRBwAAAAAAIIw4AAAAAAAAYcQBAAAAAAAIIw4AAAAAAEAYcQAAAAAAAMKIAwAAAAAAEEYcAAAAAACAMOIAAAAAAACEEQcAAAAAACCMOAAAAAAAAGHEAQAAAAAACCMOAAAAAABAGHEAAAAAAADCiAMAAAAAABBGHAAAAAAAgDDiAAAAAAAAhBEHAAAAAAAgjDgAAAAAAABhxAEAAAAAAAgjDgAAAAAAQBhxAAAAAAAAwogDAAAAAAAQRhwAAAAAAIAw4gAAAAAAAIQRBwAAAAAAIIw4AAAAAAAAYcQBAAAAAAAIIw4AAAAAAEAYcQAAAAAAAMKIAwAAAAAAEEYcAAAAAACAMOIAAAAAAACEEQcAAAAAACCMOAAAAAAAAGHEAQAAAAAACCMOAAAAAABAGHEAAAAAAADCiAMAAAAAABBGHAAAAAAAgDDiAAAAAAAAhBEHAAAAAAAgjDgAAAAAAABhxAEAAAAAAAgjDgAAAAAAQBhxAAAAAAAAwvzp6fHv/3n7RwAAAAAAYK7/Asd4o5a49xSfAAAAAElFTkSuQmCC">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Scanner QR -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Gerador de QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .menu-item.active { background-color: #1d4ed8; color: white; }
    .modal-backdrop { background-color: rgba(0,0,0,0.5); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    select:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .map-card-position { transition: all 0.2s ease-in-out; }

    .login-hero {
      background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.12), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(99, 102, 241, 0.15), transparent 30%),
                  linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
    }
    .login-badge {
      background: rgba(59, 130, 246, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    .login-card {
      box-shadow: 0 20px 50px -24px rgba(59, 130, 246, 0.4);
    }

    /* Estilos para o novo modo de movimentação */
    .move-mode-active .map-card-position {
        background-color: #cceeff;
        cursor: copy;
        animation: pulse-blue 1.5s infinite;
    }
     .move-mode-active .map-card-position.move-source {
        background-color: #fdd835;
        opacity: 1;
        cursor: not-allowed;
    }

    @keyframes pulse-blue {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }

    /* Estilo para a área de leitura do QR Code */
    #reader {
        position: relative;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    #reader__scan_region {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #reader__scan_region::after {
        content: '';
        position: absolute;
        width: 250px;
        height: 250px;
        border: 4px solid rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        box-shadow: 0 0 0 4000px rgba(0,0,0,0.4);
        animation: scan-glow 2s infinite ease-in-out;
    }
    @keyframes scan-glow {
        0%, 100% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.4), 0 0 10px 2px #4ade80; }
        50% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.4), 0 0 10px 2px #16a34a; }
    }
    
    @media print {
      body * {
        visibility: hidden;
      }
      #printable-area, #printable-area * {
        visibility: visible;
      }
      #printable-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      nav, aside, header, .modal-backdrop > div:not(#printable-area-container) {
          display: none !important;
      }
      .modal-backdrop {
        background-color: white !important;
        justify-content: flex-start;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body class="antialiased text-gray-800">

  <div id="login-page" class="login-hero min-h-screen flex items-center justify-center px-4 py-10">
    <div class="max-w-5xl w-full grid md:grid-cols-2 gap-8 items-center">
      <div class="space-y-4">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-blue-700 text-xs font-semibold uppercase tracking-wide login-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check w-4 h-4">
            <path d="M9 12.75 11.25 15 15 9.75"/><path d="M6.75 3.75 12 2.25l5.25 1.5v5.25c0 4.5-2.25 6.75-5.25 8.25-3-1.5-5.25-3.75-5.25-8.25z"/>
          </svg>
          Acesso seguro
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Entre para usar o painel</h1>
        <p class="text-gray-600 text-base">Use as credenciais secretas definidas no Cloudflare Pages. O mesmo login libera o sistema inteiro.</p>
        <div class="grid gap-3 text-sm text-gray-700">
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-4 h-4 mt-0.5"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></svg>
            Sessões válidas por até <strong class="font-semibold">24h</strong> (token guardado em KV com expiração automática).
          </div>
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock w-4 h-4 mt-0.5"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Aceita login somente com senha ou com usuário + senha (defina <code class="px-1 py-0.5 bg-blue-50 border border-blue-100 rounded text-xs">ADMIN_USERNAME</code> se quiser exigir usuário).
          </div>
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud w-4 h-4 mt-0.5"><path d="M17.5 19a4.5 4.5 0 0 0 .5-8.96A7 7 0 0 0 5.5 6.6"/><path d="M17.5 19H9a5 5 0 0 1-1-9.9"/></svg>
            Todas as credenciais ficam em variáveis de segredo do Cloudflare (nunca expostas no código).        
          </div>
        </div>
      </div>
      <div class="bg-white border border-gray-100 rounded-2xl p-6 md:p-8 login-card">
        <form id="login-form" class="space-y-5">
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-800" for="login-username">Usuário (opcional)</label>
            <input id="login-username" name="username" type="text" autocomplete="username" placeholder="Configure ADMIN_USERNAME para exigir" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
            <p class="text-xs text-gray-500">Deixe em branco se quiser autenticar apenas com senha.</p>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-800" for="login-password">Senha</label>
            <input id="login-password" name="password" type="password" required autocomplete="current-password" placeholder="Variável secreta ADMIN_PASSWORD" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
          </div>
          <div class="flex items-center justify-between gap-3 text-sm text-gray-600">
            <label class="flex items-center gap-2">
              <input id="login-remember" type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked />
              Manter sessão nesta máquina por 24h
            </label>
            <span class="text-xs text-gray-500">A senha é verificada no Cloudflare.</span>
          </div>
          <p id="login-error" class="text-sm text-red-600 hidden"></p>
          <button id="login-submit" type="submit" class="w-full inline-flex justify-center items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-3 rounded-lg shadow-md transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in w-5 h-5"><path d="m15 3 3 3-3 3"/><path d="M4 12v-1a7 7 0 0 1 7-7h7"/><path d="M22 12H12"/><path d="M7 12l-3 3 3 3"/><path d="M15 21h-1a7 7 0 0 1-7-7"/></svg>
            Entrar
          </button>
          <p class="text-xs text-gray-500 text-center">Autenticação única libera todas as páginas do sistema.</p>
        </form>
      </div>
    </div>
  </div>

  <div id="app-shell" class="hidden flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar (desktop) -->
    <aside class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
      <div class="flex items-center justify-center h-16 border-b border-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
        <span class="ml-2 text-lg font-bold">Estoque Calçados</span>
      </div>
      <nav class="flex-1 px-2 py-4 space-y-2">
        <a href="#home" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard h-5 w-5 mr-3"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          Dashboard
        </a>
        <a href="#entrada" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-square h-5 w-5 mr-3 text-green-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          Entrada
        </a>
        <a href="#saida" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-square h-5 w-5 mr-3 text-red-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          Saída
        </a>
        <a href="#separacao-listas" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-route h-5 w-5 mr-3 text-indigo-300"><path d="M6 3h10"/><path d="M6 8h10"/><path d="M6 13h10"/><path d="M6 18h10"/><circle cx="6" cy="18" r="2"/><circle cx="18" cy="13" r="2"/><circle cx="6" cy="8" r="2"/></svg>
          Separação
        </a>
        <a href="#mapa" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map h-5 w-5 mr-3"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          Mapa do Estoque
        </a>
        <a href="#relatorios" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text h-5 w-5 mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          Relatórios
        </a>
        <a href="#historico" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history h-5 w-5 mr-3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
          Histórico
        </a>
        <a href="#admin" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check h-5 w-5 mr-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <div class="flex-1 flex flex-col">
      <!-- Mobile Header -->
      <header class="md:hidden flex items-center justify-between bg-gray-800 text-white p-4 shadow-md sticky top-0 z-10">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
          <span id="header-title" class="ml-2 text-lg font-bold">Dashboard</span>
        </div>
        <a href="#admin" class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-white text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </header>

      <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="page-home" class="page"></div>
        <div id="page-entrada" class="page hidden"></div>
        <div id="page-saida" class="page hidden"></div>
        <div id="page-separacao" class="page hidden"></div>
        <div id="page-mapa" class="page hidden"></div>
        <div id="page-produtos" class="page hidden"></div>
        <div id="page-relatorios" class="page hidden"></div>
        <div id="page-etiquetas" class="page hidden"></div>
        <div id="page-historico" class="page hidden"></div>
        <div id="page-admin" class="page hidden"></div>
      </main>

      <!-- Bottom Nav (mobile) -->
      <nav class="md:hidden grid grid-cols-6 gap-1 p-2 bg-gray-800 text-white border-t border-gray-700 sticky bottom-0">
        <a href="#home" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard h-6 w-6 mb-1"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          <span class="text-xs">Dashboard</span>
        </a>
        <a href="#entrada" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-square h-6 w-6 mb-1 text-green-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          <span class="text-xs">Entrada</span>
        </a>
        <a href="#saida" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-square h-6 w-6 mb-1 text-red-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          <span class="text-xs">Saída</span>
        </a>
        <a href="#separacao-listas" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-route h-6 w-6 mb-1 text-indigo-300"><path d="M6 3h10"/><path d="M6 8h10"/><path d="M6 13h10"/><path d="M6 18h10"/><circle cx="6" cy="18" r="2"/><circle cx="18" cy="13" r="2"/><circle cx="6" cy="8" r="2"/></svg>
          <span class="text-xs">Separação</span>
        </a>
        <a href="#mapa" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map h-6 w-6 mb-1"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          <span class="text-xs">Mapa</span>
        </a>
        <a href="#relatorios" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text h-6 w-6 mb-1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          <span class="text-xs">Relatórios</span>
        </a>
      </nav>
    </div>
  </div>

  <!-- Modals -->
  <div id="modal-container" class="hidden"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {

    // --- DADOS DO SISTEMA ---
    let productList = [];
    let inventory = [];
    let history = [];
    let isSyncing = false;
    let separationLists = [];
    let separationDetails = {};
    let separationDraft = { name: '', items: [] };
    let separationTab = 'listas';
    let currentSeparationListId = null;
    let activeRouteExecution = null;
    let optimizationResult = null;
    let separationLoading = { lists: false, detail: false, action: false };
    let optimizationFilters = { windowDays: 7, maxMoves: 10, threshold: 10, hotOnly: false };
    let separationPicker = { modelos: [], grades: [], materiais: [], variacoes: [], selections: [] };
    let separationSearchTerm = '';

    const LABELS_PER_PAGE = 12;

    const defaultLabelTemplates = [
      {
        id: 'std-100x25',
        name: 'Etiqueta padrão 100×25 mm',
        description: 'Arte vetorial neutra em 300 DPI (1181×295 px).',
        artPath: '/assets/templates/etiqueta-padrao-100x25.svg',
        canvas: { width: 1181, height: 295 },
        fields: [
          {
            id: 'modelo',
            label: 'Modelo',
            type: 'text',
            source: 'modelo',
            valueTemplate: '{{modelo}}',
            x: 160,
            y: 70,
            font: '700 64px "Inter", sans-serif',
            color: '#111827',
            align: 'left',
            baseline: 'alphabetic'
          },
          {
            id: 'variacao',
            label: 'Variação',
            type: 'text',
            source: 'variacao',
            valueTemplate: '{{variacao}}',
            x: 160,
            y: 135,
            font: '500 48px "Inter", sans-serif',
            color: '#111827',
            align: 'left',
            baseline: 'alphabetic'
          },
          {
            id: 'material',
            label: 'Material',
            type: 'text',
            source: 'material',
            valueTemplate: '{{material}}',
            x: 160,
            y: 200,
            font: '500 36px "Inter", sans-serif',
            color: '#374151',
            align: 'left',
            baseline: 'alphabetic'
          },
          {
            id: 'grade',
            label: 'Grade',
            type: 'text',
            source: 'gradeTipo',
            valueTemplate: 'Grade {{gradeTipo}}',
            x: 160,
            y: 260,
            font: '600 32px "Inter", sans-serif',
            color: '#1f2937',
            align: 'left',
            baseline: 'alphabetic'
          },
          {
            id: 'sku',
            label: 'SKU abreviado',
            type: 'text',
            source: 'skuCurto',
            valueTemplate: '{{skuCurto}}',
            x: 920,
            y: 260,
            font: '600 40px "Inter", sans-serif',
            color: '#111827',
            align: 'right',
            baseline: 'alphabetic'
          },
          {
            id: 'tamanho',
            label: 'Numeração',
            type: 'text',
            source: 'tamanho',
            valueTemplate: '{{tamanho}}',
            x: 980,
            y: 170,
            font: '700 140px "Inter", sans-serif',
            color: '#111827',
            align: 'center',
            baseline: 'middle'
          }
        ],
        qrCodes: [
          {
            id: 'principal',
            label: 'QR Code principal',
            size: 220,
            x: 900,
            y: 30,
            dataTemplate: 'SKU={{skuCompleto}};SIZE={{tamanho}};GRADE={{gradeTipo}};COR={{variacao}}',
            correctionLevel: 'H'
          }
        ]
      }
    ];

    let labelTemplatesCatalog = JSON.parse(JSON.stringify(defaultLabelTemplates));
    const labelTemplateImageCache = new Map();
    const labelGradePresets = {
      baixa: {
        label: 'Grade baixa (33 a 44)',
        sequence: ['33','34','35','36','37','38','39','40','41','42','43','44']
      },
      alta: {
        label: 'Grade alta (35 a 46)',
        sequence: ['35','36','37','38','39','40','41','42','43','44','45','46']
      },
      infantil: {
        label: 'Grade infantil (25 a 36)',
        sequence: ['25','26','27','28','29','30','31','32','33','34','35','36']
      },
      especial: {
        label: 'Grade especial (numeração combinada)',
        sequence: ['34/35','35/36','36/37','37/38','38/39','39/40','40/41','41/42','42/43','43/44','44/45','45/46']
      }
    };

    const labelDesignerState = {
      sequence: [],
      gradeType: 'baixa',
      pairsPerSize: 1,
      extraLabels: 0,
      productId: null,
      templateId: null
    };

    const labelPreviewState = {
      canvases: [],
      template: null,
      product: null
    };

    const deepClone = (value) => JSON.parse(JSON.stringify(value));
    const encodeInputValue = (value = '') => String(value ?? '').replace(/"/g, '&quot;');

    const normalizeProductsPayload = (payload) => {
      if (Array.isArray(payload)) {
        return { products: payload, labelTemplates: deepClone(defaultLabelTemplates) };
      }
      if (payload && typeof payload === 'object') {
        const products = Array.isArray(payload.products) ? payload.products : [];
        const labelTemplates = Array.isArray(payload.labelTemplates) && payload.labelTemplates.length
          ? payload.labelTemplates
          : deepClone(defaultLabelTemplates);
        return { products, labelTemplates };
      }
      return { products: [], labelTemplates: deepClone(defaultLabelTemplates) };
    };

    const buildShortSku = (product = {}) => {
      const base = (product.sku || product.codigo || `${product.modelo || ''}-${product.variacao || ''}-${product.grade || ''}`)
        .toString()
        .replace(/[^A-Za-z0-9]/g, '')
        .toUpperCase();
      return base.slice(-8);
    };

    const resolveTemplateString = (template = '', context = {}) =>
      template.replace(/{{\s*([^}]+)\s*}}/g, (_, key) => {
        const value = context[key.trim()];
        return value === undefined || value === null ? '' : String(value);
      });

    const buildSequenceFromPreset = (presetKey, quantity = 1) => {
      const preset = labelGradePresets[presetKey];
      if (!preset) return [];
      return preset.sequence.map(size => ({ size, quantity }));
    };

    const loadTemplateImage = (path) => {
      if (!path) {
        return Promise.reject(new Error('Template sem arte de fundo definida.'));
      }
      if (!labelTemplateImageCache.has(path)) {
        const promise = new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error(`Não foi possível carregar ${path}`));
          img.src = path;
        });
        labelTemplateImageCache.set(path, promise);
      }
      return labelTemplateImageCache.get(path);
    };

    const createQRCodeCanvas = (text, size = 128, correctionLevel = 'M') => {
      if (typeof QRCode === 'undefined') {
        return Promise.reject(new Error('Biblioteca de QR Code não carregada.'));
      }
      return new Promise((resolve, reject) => {
        const temp = document.createElement('div');
        temp.style.position = 'absolute';
        temp.style.left = '-9999px';
        temp.style.top = '0';
        document.body.appendChild(temp);
        const levelKey = correctionLevel?.toUpperCase?.() || 'M';
        try {
          // eslint-disable-next-line no-new
          new QRCode(temp, {
            text,
            width: size,
            height: size,
            correctLevel: QRCode.CorrectLevel[levelKey] || QRCode.CorrectLevel.M
          });
        } catch (err) {
          document.body.removeChild(temp);
          reject(err);
          return;
        }
        setTimeout(() => {
          const canvas = temp.querySelector('canvas');
          if (!canvas) {
            document.body.removeChild(temp);
            reject(new Error('Falha ao gerar QR Code.'));
            return;
          }
          const clone = document.createElement('canvas');
          clone.width = size;
          clone.height = size;
          const ctx = clone.getContext('2d');
          ctx.drawImage(canvas, 0, 0, size, size);
          document.body.removeChild(temp);
          resolve(clone);
        }, 0);
      });
    };

    const drawLabelFromTemplate = async (template, product, entry, gradeType, cachedImage = null) => {
      const width = template?.canvas?.width || template?.sizePx?.width || 1181;
      const height = template?.canvas?.height || template?.sizePx?.height || 295;
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      const image = cachedImage || await loadTemplateImage(template.artPath);
      ctx.drawImage(image, 0, 0, width, height);

      const contextData = {
        ...product,
        modelo: product?.modelo || product?.nome || '',
        grade: product?.grade || '',
        material: product?.material || '',
        variacao: product?.variacao || product?.cor || '',
        cor: product?.variacao || product?.cor || '',
        sku: product?.sku || product?.codigo || '',
        skuCompleto: product?.sku || product?.codigo || `${product?.modelo || ''}-${product?.variacao || ''}`,
        skuCurto: buildShortSku(product),
        tamanho: entry.size,
        tamanhoDisplay: entry.size,
        gradeTipo: gradeType,
        quantidadeAtual: entry.pairIndex,
        quantidadePorTamanho: entry.quantityForSize,
        etiquetaExtra: entry.isExtra ? 'EXTRA' : '',
        produtoId: product?.id
      };

      (template.fields || []).forEach((field) => {
        if (field.type !== 'text') return;
        const templateString = field.valueTemplate || (field.source ? `{{${field.source}}}` : '');
        const textValue = resolveTemplateString(templateString, contextData).trim();
        if (!textValue) return;
        ctx.save();
        ctx.font = field.font || '600 40px "Inter", sans-serif';
        ctx.fillStyle = field.color || '#111827';
        ctx.textAlign = field.align || 'left';
        ctx.textBaseline = field.baseline || 'alphabetic';
        const maxWidth = field.maxWidth || undefined;
        ctx.fillText(textValue, field.x ?? 0, field.y ?? 0, maxWidth);
        ctx.restore();
      });

      if (Array.isArray(template.qrCodes)) {
        for (const code of template.qrCodes) {
          const qrTemplate = code.dataTemplate || '';
          const qrValue = resolveTemplateString(qrTemplate, contextData).trim();
          if (!qrValue) continue;
          try {
            const qrCanvas = await createQRCodeCanvas(qrValue, code.size || 128, code.correctionLevel || 'M');
            ctx.drawImage(qrCanvas, code.x ?? 0, code.y ?? 0, code.size || 128, code.size || 128);
          } catch (qrError) {
            console.warn('Falha ao desenhar QR Code da etiqueta:', qrError);
          }
        }
      }

      return canvas;
    };

    const downloadCanvasAsPng = (canvas, filename) => {
      if (!canvas) return;
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    const downloadSingleLabel = (index) => {
      const canvas = labelPreviewState.canvases[index];
      if (!canvas) {
        showToast('Gere a prévia das etiquetas antes de baixar.', 'error');
        return;
      }
      const productSlug = (labelPreviewState.product?.modelo || 'produto')
        .toString()
        .trim()
        .replace(/\s+/g, '-');
      downloadCanvasAsPng(canvas, `${productSlug}-etiqueta-${String(index + 1).padStart(2, '0')}.png`);
    };

    const exportLabelPreviewToPDF = async () => {
      if (!labelPreviewState.canvases.length) {
        showToast('Gere a prévia antes de exportar.', 'error');
        return;
      }
      if (!window.jspdf?.jsPDF) {
        showToast('Biblioteca jsPDF não carregada.', 'error');
        return;
      }
      const { jsPDF } = window.jspdf;
      const template = labelPreviewState.template;
      const width = template?.canvas?.width || labelPreviewState.canvases[0].width;
      const height = template?.canvas?.height || labelPreviewState.canvases[0].height;
      const orientation = width >= height ? 'landscape' : 'portrait';
      const pdf = new jsPDF({ orientation, unit: 'pt', format: [width, height] });
      labelPreviewState.canvases.forEach((canvas, idx) => {
        if (idx !== 0) pdf.addPage();
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, width, height);
      });
      const productSlug = (labelPreviewState.product?.modelo || 'produto')
        .toString()
        .trim()
        .replace(/\s+/g, '-');
      pdf.save(`etiquetas-${productSlug}-${Date.now()}.pdf`);
    };

    const downloadAllLabelPNGs = () => {
      if (!labelPreviewState.canvases.length) {
        showToast('Gere a prévia antes de baixar as imagens.', 'error');
        return;
      }
      const productSlug = (labelPreviewState.product?.modelo || 'produto')
        .toString()
        .trim()
        .replace(/\s+/g, '-');
      labelPreviewState.canvases.forEach((canvas, index) => {
        downloadCanvasAsPng(canvas, `${productSlug}-etiqueta-${String(index + 1).padStart(2, '0')}.png`);
      });
    };

    // --- LÓGICA DE DADOS E SINCRONIZAÇÃO ---
    async function loadAllDataFromServer() {
        if (isSyncing || !adminAuthenticated || !adminToken) return;
        isSyncing = true;
        const authHeaders = getAuthHeaders();
        try {
            const [estoqueRes, produtosRes, separacaoRes] = await Promise.all([
                fetch('/api/estoque', { headers: authHeaders }),
                fetch('/api/produtos', { headers: authHeaders }),
                fetch('/api/separacao/listas', { headers: authHeaders }).catch(() => null)
            ]);

            const responses = [estoqueRes, produtosRes, separacaoRes].filter(Boolean);
            if (responses.some(r => r.status === 401)) { handleUnauthorized(); return; }

            if (!estoqueRes.ok) throw new Error(`HTTP error! status: ${estoqueRes.status}`);
            if (!produtosRes.ok) throw new Error(`HTTP error! status: ${produtosRes.status}`);

            const estoqueData = await estoqueRes.json();
            const produtosData = await produtosRes.json();
            const separacaoData = separacaoRes && separacaoRes.ok ? await separacaoRes.json() : separationLists;

            const serverInventory = Array.isArray(estoqueData.inventory) ? estoqueData.inventory : [];
            const serverHistory = Array.isArray(estoqueData.history) ? estoqueData.history : [];
            const produtosPayload = normalizeProductsPayload(produtosData);
            const serverProducts = produtosPayload.products.map(p => ({ ...p, nomeCompleto: `${p.modelo} ${p.grade} ${p.material} ${p.variacao}` }));
            const serverTemplates = produtosPayload.labelTemplates?.length ? produtosPayload.labelTemplates : deepClone(defaultLabelTemplates);

            const listsChanged = JSON.stringify(separationLists) !== JSON.stringify(separacaoData);

            if (JSON.stringify(inventory) !== JSON.stringify(serverInventory) ||
                JSON.stringify(history) !== JSON.stringify(serverHistory) ||
                JSON.stringify(productList) !== JSON.stringify(serverProducts) ||
                JSON.stringify(labelTemplatesCatalog) !== JSON.stringify(serverTemplates) ||
                listsChanged) {

                inventory = serverInventory;
                history = serverHistory;
                productList = serverProducts;
                labelTemplatesCatalog = serverTemplates;
                if (listsChanged) separationLists = Array.isArray(separacaoData) ? separacaoData : [];

                rerenderCurrentPage();
            }
        } catch (error) {
            console.error("Falha ao buscar dados do servidor:", error);
            showToast('Erro de conexão ao buscar dados.', 'error');
        } finally {
            isSyncing = false;
        }
    }

    async function persistInventory() {
      if (!ensureAdminSession()) return false;
      try {
        const isReset = inventory.length === 0 && history[0]?.type === 'RESET';
        const authHeaders = getAuthHeaders();
        if (isReset) {
            const r = await fetch('/api/estoque?op=reset', { method: 'POST', headers: { ...authHeaders } });
            if (r.status === 401) { handleUnauthorized(); return false; }
            if (!r.ok) throw new Error('Falha ao resetar o estoque no servidor.');
            const d = await r.json();
            history = d.history || history;
            return true;
        }

        const res = await fetch('/api/estoque', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders },
          body: JSON.stringify({ inventory, history }),
        });
        if (res.status === 401) { handleUnauthorized(); return false; }
        if (!res.ok) throw new Error('Falha ao persistir inventário no servidor.');
        return true;
      } catch (error) {
        console.error("Falha ao persistir inventário:", error);
        showToast('Erro de conexão ao salvar inventário.', 'error');
        return false;
      }
    }

    async function persistProducts() {
        if (!ensureAdminSession()) return false;
        try {
            const payload = {
                products: productList.map(({nomeCompleto, ...rest}) => rest),
                labelTemplates: labelTemplatesCatalog
            };
            const res = await fetch('/api/produtos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                body: JSON.stringify(payload)
            });
            if (res.status === 401) { handleUnauthorized(); return false; }
            if (!res.ok) throw new Error('Falha ao salvar produtos no servidor.');
            return true;
        } catch (error) {
            console.error("Falha ao persistir produtos:", error);
            showToast('Erro de conexão ao salvar produtos.', 'error');
            return false;
        }
    }

    const mapLayout = { locations: ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'], positions: ['FUNDO','MEIO','FRENTE'] };

    const loginPage = document.getElementById('login-page');
    const appShell = document.getElementById('app-shell');
    const loginForm = document.getElementById('login-form');
    const loginUsername = document.getElementById('login-username');
    const loginPassword = document.getElementById('login-password');
    const loginRemember = document.getElementById('login-remember');
    const loginError = document.getElementById('login-error');
    const loginSubmit = document.getElementById('login-submit');

    const toggleAuthShell = (isAuthenticated) => {
      if (isAuthenticated) {
        loginPage?.classList.add('hidden');
        appShell?.classList.remove('hidden');
      } else {
        appShell?.classList.add('hidden');
        loginPage?.classList.remove('hidden');
      }
    };

    const ADMIN_TOKEN_KEY = 'estoque-admin-token';
    let adminToken = sessionStorage.getItem(ADMIN_TOKEN_KEY) || localStorage.getItem(ADMIN_TOKEN_KEY) || null;
    if (adminToken && !sessionStorage.getItem(ADMIN_TOKEN_KEY)) {
      sessionStorage.setItem(ADMIN_TOKEN_KEY, adminToken);
    }
    let adminAuthenticated = Boolean(adminToken);
    let lastVisitedHash = '#home';

    const persistAdminToken = (token, remember = false) => {
      adminToken = token;
      adminAuthenticated = Boolean(token);
      if (token) {
        sessionStorage.setItem(ADMIN_TOKEN_KEY, token);
        if (remember) {
          localStorage.setItem(ADMIN_TOKEN_KEY, token);
        } else {
          localStorage.removeItem(ADMIN_TOKEN_KEY);
        }
      } else {
        sessionStorage.removeItem(ADMIN_TOKEN_KEY);
        localStorage.removeItem(ADMIN_TOKEN_KEY);
      }
      toggleAuthShell(adminAuthenticated);
    };

    loginForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (loginError) loginError.classList.add('hidden');
      const username = loginUsername?.value?.trim();
      const password = loginPassword?.value?.trim();
      if (!password) {
        showToast('Informe a senha para continuar.', 'error');
        loginPassword?.focus();
        return;
      }

      if (loginSubmit) {
        loginSubmit.disabled = true;
        loginSubmit.textContent = 'Entrando...';
      }

      try {
        const payload = { password };
        if (username) payload.username = username;
        const res = await fetch('/api/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.token) {
          throw new Error(data?.error || 'Falha ao autenticar.');
        }

        const remember = Boolean(loginRemember?.checked);
        persistAdminToken(data.token, remember);
        showToast('Sessão liberada por até 24h.', 'success');
        await loadAllDataFromServer();
        goTo(lastVisitedHash || '#home');
        navigate();
      } catch (error) {
        console.error('Falha no login administrativo:', error);
        if (loginError) {
          loginError.textContent = error?.message || 'Usuário ou senha incorretos.';
          loginError.classList.remove('hidden');
        }
        showToast('Não foi possível autenticar.', 'error');
      } finally {
        if (loginSubmit) {
          loginSubmit.disabled = false;
          loginSubmit.textContent = 'Entrar';
        }
      }
    });

    const ensureAdminSession = () => {
      if (!adminToken) {
        showToast('Faça login para continuar.', 'error');
        showAdminLoginModal();
        window.location.hash = '#login';
        return false;
      }
      return true;
    };

    const getAuthHeaders = () => (adminToken ? { Authorization: `Bearer ${adminToken}` } : {});

    let moveOperation = null; 

    const pages = document.querySelectorAll('.page');
    const menuItems = document.querySelectorAll('.menu-item');
    const headerTitle = document.getElementById('header-title');

    // ======= SCANNER / QR =======
    let preselectedLocation = null;
    let activeScanner = null;

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === 'suspended') { ctx.resume(); }
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime + 0.02);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.15);
      } catch (e) { console.error("Erro no 'beep':", e); }
    }

    function parseScannedPayload(text) {
      try {
        const j = JSON.parse(text);
        if(j.type === 'location' && j.location) return { type: 'location', location: j.location };
        if(j.productId) return { type: 'product', productId: j.productId };
      } catch(_) {
        const n = Number(text.trim());
        if (!Number.isNaN(n)) return { type: 'product', productId: n };
      }
      return { type: 'unknown' };
    }

    async function stopActiveScanner() {
        if (activeScanner && activeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
            try { await activeScanner.stop(); } catch (err) { /* ignore */ }
        }
        activeScanner = null;
    }

    async function showGenericScanner(title, onSuccess) {
        const content = `
            <div class="p-4 relative">
            <button id="scan-close" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h3 class="text-lg font-bold mb-3 text-center">${title}</h3>
            <div id="reader" class="w-full"></div>
            <div id="scan-feedback" class="hidden mt-3 px-3 py-2 rounded-md bg-green-100 text-green-800 text-sm font-medium">Código lido! Processando...</div>
            <p class="text-xs text-gray-500 mt-3 text-center">Se solicitado, permita o acesso à câmera.</p>
            </div>`;
        showModal(content);

        let isHandlingScan = false;
        const onScanSuccessWrapper = (decodedText) => {
            if (isHandlingScan) return;
            isHandlingScan = true;
            document.getElementById('scan-feedback')?.classList.remove('hidden');
            beep();
            setTimeout(async () => {
                await stopActiveScanner();
                onSuccess(decodedText);
            }, 1500);
        };
        
        document.getElementById('scan-close').onclick = async () => {
            await stopActiveScanner();
            closeModal();
        };

        const html5Qrcode = new Html5Qrcode("reader");
        activeScanner = html5Qrcode;
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        try {
            const devices = await Html5Qrcode.getCameras();
            if (devices && devices.length) {
                const cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id;
                await html5Qrcode.start(
                    cameraId,
                    config,
                    onScanSuccessWrapper,
                    (errorMessage) => { /* ignore errors during scan */ }
                );
            } else {
                showToast('Nenhuma câmera encontrada.', 'error');
                closeModal();
            }
        } catch (err) {
            showToast(`Erro ao iniciar a câmera: ${err.message}`, 'error');
            console.error("Erro ao iniciar a câmera:", err);
            closeModal();
        }
    }

    // ======= FIM SCANNER =======

    // ======= SEPARAÇÃO / ROTAS =======
    const getProductLabel = (productId) => {
      const p = productList.find((prod) => String(prod.id) === String(productId));
      if (!p) return `SKU ${productId}`;
      return `${p.modelo || p.nome || 'Produto'} ${p.variacao ? `- ${p.variacao}` : ''}`.trim();
    };

    const formatSeparationStatus = (status) => {
      switch ((status || '').toLowerCase()) {
        case 'draft': return 'Rascunho';
        case 'pending': return 'Pendente';
        case 'in_progress':
        case 'running': return 'Em andamento';
        case 'done':
        case 'completed': return 'Concluída';
        case 'canceled': return 'Cancelada';
        default: return status || '-';
      }
    };

    const resetSeparationEditor = () => {
      separationDraft = { name: '', items: [] };
      separationSearchTerm = '';
      currentSeparationListId = null;
      activeRouteExecution = null;
      optimizationResult = null;
      separationPicker = { modelos: [], grades: [], materiais: [], variacoes: [], selections: [] };
    };

    const filterProductsByTerm = (term) => {
      const t = term.trim().toLowerCase();
      if (!t) return productList.slice(0, 30);
      return productList.filter((p) => {
        return (
          String(p.id).includes(t) ||
          (p.modelo && p.modelo.toLowerCase().includes(t)) ||
          (p.variacao && p.variacao.toLowerCase().includes(t)) ||
          (p.sku && p.sku.toLowerCase().includes(t)) ||
          (p.nome && p.nome.toLowerCase().includes(t))
        );
      }).slice(0, 30);
    };

    const setSeparationTab = (tab) => {
      separationTab = tab === 'otimizacao' ? 'otimizacao' : 'listas';
      window.location.hash = separationTab === 'otimizacao' ? '#separacao-otimizacao' : '#separacao-listas';
    };

    const attachScanToSearch = () => {
      const btn = document.getElementById('sep-scan-btn');
      if (!btn) return;
      btn.onclick = () => startScanner((payload) => {
        if (payload?.productId) {
          separationSearchTerm = String(payload.productId);
          showToast('Produto identificado via QR.', 'success');
          rerenderCurrentPage();
        } else {
          showToast('QR não identificado como produto.', 'error');
        }
      }, null, 'Aproxime o QR do produto para adicionar na lista');
    };

    const getSeparationPickerOptions = () => {
      let listForGrades = productList;
      if (separationPicker.modelos.length) listForGrades = listForGrades.filter(p => separationPicker.modelos.includes(p.modelo));
      const availableGrades = [...new Set(listForGrades.map(p => p.grade))].sort();

      let listForMateriais = listForGrades;
      if (separationPicker.grades.length) listForMateriais = listForMateriais.filter(p => separationPicker.grades.includes(p.grade));
      const availableMateriais = [...new Set(listForMateriais.map(p => p.material))].sort();

      let listForVariacoes = listForMateriais;
      if (separationPicker.materiais.length) listForVariacoes = listForVariacoes.filter(p => separationPicker.materiais.includes(p.material));
      const availableVariacoes = [...new Set(listForVariacoes.map(p => p.variacao))].sort();

      const availableModelos = [...new Set(productList.map(p => p.modelo))].sort();

      return { availableModelos, availableGrades, availableMateriais, availableVariacoes };
    };

    const clampSeparationPickerState = () => {
      const { availableModelos, availableGrades, availableMateriais, availableVariacoes } = getSeparationPickerOptions();
      separationPicker.modelos = separationPicker.modelos.filter(v => availableModelos.includes(v));
      separationPicker.grades = separationPicker.grades.filter(v => availableGrades.includes(v));
      separationPicker.materiais = separationPicker.materiais.filter(v => availableMateriais.includes(v));
      separationPicker.variacoes = separationPicker.variacoes.filter(v => availableVariacoes.includes(v));
      separationPicker.selections = separationPicker.selections.filter(sel => productList.some(p => String(p.id) === String(sel.productId)));
    };

    const getSeparationPickerMatches = () => {
      return productList.filter((p) => (
        (!separationPicker.modelos.length || separationPicker.modelos.includes(p.modelo)) &&
        (!separationPicker.grades.length || separationPicker.grades.includes(p.grade)) &&
        (!separationPicker.materiais.length || separationPicker.materiais.includes(p.material)) &&
        (!separationPicker.variacoes.length || separationPicker.variacoes.includes(p.variacao))
      ));
    };

    const applySeparationPickerSelection = () => {
      clampSeparationPickerState();
      const matches = getSeparationPickerMatches();
      const qtyById = separationPicker.selections.reduce((acc, sel) => {
        acc[String(sel.productId)] = sel.quantity || 1;
        return acc;
      }, {});
      separationPicker.selections = matches.map((p) => ({
        productId: p.id,
        quantity: qtyById[String(p.id)] || 1,
      }));
      showToast(`${separationPicker.selections.length} produtos selecionados para a lista.`, 'success');
    };

    const buildPickerChipGroup = (id, label, options, selectedValues, disabled = false) => {
      const chips = options.map(opt => {
        const active = selectedValues.includes(opt);
        const baseClasses = 'px-3 py-1 rounded-full border text-sm';
        const activeClasses = 'bg-indigo-600 border-indigo-600 text-white';
        const inactiveClasses = 'bg-white border-gray-300 text-gray-700 hover:border-indigo-400';
        return `<button type=\"button\" data-picker-toggle=\"${id}\" data-value=\"${opt}\" class=\"${baseClasses} ${active ? activeClasses : inactiveClasses}\" ${disabled ? 'disabled' : ''}>${opt}</button>`;
      }).join('');
      return `
        <div class=\"space-y-2\">
          <p class=\"text-sm font-medium text-gray-700\">${label}</p>
          <div class=\"flex flex-wrap gap-2\">${chips || '<span class="text-xs text-gray-400">Nenhuma opção</span>'}</div>
        </div>
      `;
    };

    const mergePickerIntoDraft = () => {
      if (!separationPicker.selections.length) {
        showToast('Nenhuma seleção para incluir.', 'error');
        return;
      }
      separationPicker.selections.forEach((sel) => {
        const existing = separationDraft.items.find((it) => String(it.productId || it.product_id) === String(sel.productId));
        if (existing) {
          const currentQty = existing.requested_qty ?? existing.requestedQty ?? existing.quantity ?? 0;
          existing.requestedQty = currentQty + (Number(sel.quantity) || 1);
        } else {
          separationDraft.items.push({ productId: sel.productId, requestedQty: Number(sel.quantity) || 1, separatedQty: 0, status: 'pending' });
        }
      });
      showToast('Seleções adicionadas ao editor de lista.', 'success');
    };

    const ensureSeparationDetail = async (listId, silent = false) => {
      if (!listId) return null;
      if (separationDetails[listId]) return separationDetails[listId];
      try {
        separationLoading.detail = true;
        if (!silent) rerenderCurrentPage();
        const res = await fetch(`/api/separacao/listas/${listId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Falha ao abrir lista');
        separationDetails[listId] = data;
        return data;
      } catch (err) {
        console.error('Erro ao carregar lista de separação:', err);
        showToast(err?.message || 'Erro ao carregar lista.', 'error');
        return null;
      } finally {
        separationLoading.detail = false;
      }
    };

    const refreshSeparationLists = async () => {
      try {
        separationLoading.lists = true;
        rerenderCurrentPage();
        const res = await fetch('/api/separacao/listas');
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Falha ao buscar listas');
        separationLists = Array.isArray(data) ? data : [];
      } catch (err) {
        console.error('Erro ao atualizar listas de separação:', err);
        showToast(err?.message || 'Erro ao buscar listas.', 'error');
      } finally {
        separationLoading.lists = false;
      }
    };

    const saveSeparationDraft = async (generateRoute = false) => {
      if (!separationDraft.name.trim()) {
        showToast('Informe o nome da lista.', 'error');
        return null;
      }
      if (!separationDraft.items.length) {
        showToast('Adicione ao menos um item.', 'error');
        return null;
      }
      try {
        separationLoading.action = true;
        rerenderCurrentPage();
        const res = await fetch('/api/separacao/listas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: separationDraft.name.trim(), items: separationDraft.items }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Falha ao salvar rascunho');
        showToast('Lista salva!', 'success');
        separationDraft = { name: '', items: [] };
        separationLists = [data, ...separationLists.filter((l) => l.id !== data.id)];
        separationDetails[data.id] = data;
        currentSeparationListId = data.id;
        if (generateRoute) {
          await generateRouteForList(data.id);
        }
        return data;
      } catch (err) {
        console.error('Erro ao salvar lista:', err);
        showToast(err?.message || 'Erro ao salvar rascunho.', 'error');
        return null;
      } finally {
        separationLoading.action = false;
      }
    };

    const generateRouteForList = async (listId) => {
      const id = listId || currentSeparationListId;
      if (!id) {
        const created = await saveSeparationDraft(true);
        return created?.routes?.[0] || null;
      }
      try {
        separationLoading.action = true;
        rerenderCurrentPage();
        const res = await fetch(`/api/separacao/listas/${id}/gerar-rota`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Falha ao gerar rota');
        const listData = data?.list || data;
        if (listData?.id) {
          separationDetails[listData.id] = listData;
          separationLists = separationLists.map((l) => (l.id === listData.id ? { ...l, status: listData.status, items: listData.items } : l));
          currentSeparationListId = listData.id;
        }
        const route = data?.route || listData?.routes?.slice(-1)?.[0];
        if (route) {
          activeRouteExecution = { source: 'separation', route };
        }
        showToast('Rota criada!', 'success');
        return route;
      } catch (err) {
        console.error('Erro ao gerar rota:', err);
        showToast(err?.message || 'Erro ao gerar rota.', 'error');
        return null;
      } finally {
        separationLoading.action = false;
      }
    };

    const confirmRouteSteps = async (routeId, payload = {}) => {
      if (!routeId) return null;
      try {
        separationLoading.action = true;
        rerenderCurrentPage();
        const res = await fetch(`/api/separacao/rotas/${routeId}/confirmar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Falha ao confirmar passos');
        const updatedRoute = data?.route || null;
        if (updatedRoute) {
          activeRouteExecution = { source: 'separation', route: updatedRoute };
          const listId = updatedRoute.list_id;
          if (listId) {
            await ensureSeparationDetail(listId, true);
          }
        }
        showToast(payload?.status === 'skipped' ? 'Passos pulados.' : 'Passos concluídos.', 'success');
        return data;
      } catch (err) {
        console.error('Erro ao confirmar rota:', err);
        showToast(err?.message || 'Erro ao confirmar passos.', 'error');
        return null;
      } finally {
        separationLoading.action = false;
      }
    };

    const runOptimizationRoute = async () => {
      try {
        separationLoading.action = true;
        rerenderCurrentPage();
        const res = await fetch('/api/otimizacao/gerar-rota', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({
            windowDays: optimizationFilters.windowDays,
            maxMoves: optimizationFilters.maxMoves,
            threshold: optimizationFilters.threshold,
          }),
        });
        if (res.status === 401) { handleUnauthorized(); throw new Error('Token administrativo inválido ou ausente.'); }
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Falha ao gerar rota de otimização');
        const filteredSteps = optimizationFilters.hotOnly
          ? (data.steps || []).filter((s) => s.temperature === 'hot')
          : data.steps || [];
        const pseudoRoute = {
          id: data.routeId,
          name: 'Rota sugerida de otimização',
          status: 'pending',
          steps: filteredSteps.map((s, idx) => ({
            id: `${data.routeId}-${idx + 1}`,
            route_id: data.routeId,
            product_id: s.productId,
            quantity: s.quantity,
            action: 'MOVE_OPT',
            from_location: s.from,
            to_location: s.to,
            status: 'pending',
            temperature: s.temperature,
            step_order: idx + 1,
          })),
        };
        optimizationResult = { ...data, steps: filteredSteps };
        activeRouteExecution = { source: 'optimization', route: pseudoRoute };
        showToast('Rota sugerida gerada.', 'success');
      } catch (err) {
        console.error('Erro na otimização:', err);
        showToast(err?.message || 'Erro ao gerar rota otimizada.', 'error');
      } finally {
        separationLoading.action = false;
      }
    };

    const renderDashboard = () => {
      document.body.classList.remove('move-mode-active'); 
      moveOperation = null;
      const container = document.getElementById('page-home');
      const totalBoxes = inventory.reduce((s, i) => s + i.quantity, 0);
      const occupiedSlots = new Set(inventory.map(i => i.locationId)).size;
      const totalSlots = mapLayout.locations.length * mapLayout.positions.length;

      const productCounts = inventory.reduce((acc, i) => {
        const p = productList.find(pp => pp.id === i.productId);
        if (p) acc[p.modelo] = (acc[p.modelo] || 0) + i.quantity;
        return acc;
      }, {});
      const topProduct = Object.entries(productCounts).sort((a,b)=>b[1]-a[1])[0];

      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Caixas em Estoque</h3><p class="text-3xl font-bold mt-2">${totalBoxes.toLocaleString('pt-BR')}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Posições Ocupadas</h3><p class="text-3xl font-bold mt-2">${occupiedSlots} / ${totalSlots}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Modelo com Mais Estoque</h3><p class="text-2xl font-bold mt-2 truncate">${topProduct ? topProduct[0] : 'N/A'}</p><p class="text-gray-500">${topProduct ? `${topProduct[1].toLocaleString('pt-BR')} caixas` : ''}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Produtos Cadastrados</h3><p class="text-3xl font-bold mt-2">${productList.length}</p></div>
        </div>
        <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
          <h3 class="text-xl font-bold mb-4">Movimentações Recentes</h3>
          <ul class="space-y-3">
            ${history.slice(0,5).map(h=>`
              <li class="flex items-start">
                <span class="text-sm text-gray-500 w-28">${new Date(h.date).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
                <span class="font-semibold ${h.type==='ENTRADA'?'text-green-600':h.type==='SAÍDA'?'text-red-600':h.type === 'MOVIMENTAÇÃO' ? 'text-blue-600':'text-yellow-500'}">${h.type}</span>
                <span class="ml-4 text-gray-700">${h.details}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    };

    const renderEntrada = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-entrada');
      const modelos = [...new Set(productList.map(p => p.modelo))].sort();
      
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6 text-green-700">Registrar Entrada</h1>
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="space-y-4">
                 <button type="button" id="entrada-scan-process-btn" class="w-full bg-gray-700 text-white hover:bg-gray-800 px-4 py-3 rounded-md text-lg font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-line"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                    Iniciar Entrada por Leitura
                </button>
                <div class="text-center text-gray-500">ou preencha manualmente:</div>
            </div>
            <form id="entrada-form" class="mt-4 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700">1. Modelo</label>
                <select id="entrada-modelo" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                <option value="" disabled selected>Selecione o modelo</option>
                ${modelos.map(m=>`<option value="${m}">${m}</option>`).join('')}
                </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">2. Grade</label>
                <select id="entrada-grade" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">3. Material</label>
                <select id="entrada-material" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">4. Variação / Cor</label>
                <select id="entrada-variacao" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">5. Quantidade</label>
                <input type="number" id="entrada-quantidade" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div><label class="block text-sm font-medium text-gray-700">6. Localização</label>
                <select id="entrada-location" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option value="" disabled selected>Selecione a posição</option>
                    ${mapLayout.locations.flatMap(loc => mapLayout.positions.map(pos => `${loc}-${pos}`)).map(l => `<option value="${l}">${l}</option>`).join('')}
                </select>
                </div>
            </div>
            <button type="submit" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 font-bold text-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle h-6 w-6 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                Confirmar Entrada Manual
            </button>
            </form>
        </div>
      `;
      setupEntradaFormListeners();
    };

    const renderSaida = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-saida');
      if (!inventory.length) {
        container.innerHTML = `
          <h1 class="text-3xl font-bold mb-6 text-red-700">Registrar Saída</h1>
          <div class="bg-white p-6 rounded-lg shadow-md text-center"><p class="text-gray-600">Não há itens no estoque para registrar saída.</p></div>
        `;
        return;
      }
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6 text-red-700">Registrar Saída</h1>
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="space-y-4">
                 <button type="button" id="saida-scan-process-btn" class="w-full bg-gray-700 text-white hover:bg-gray-800 px-4 py-3 rounded-md text-lg font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-line"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                    Iniciar Saída por Leitura
                </button>
                <div class="text-center text-gray-500">ou preencha manualmente:</div>
            </div>
            <form id="saida-form" class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">1. Item em Estoque</label>
                <select id="saida-item" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                  <option value="" disabled selected>Selecione um item para dar baixa</option>
                  ${
                    inventory.map((it, idx) => {
                      const p = productList.find(pp=>pp.id===it.productId);
                      return { idx, locationId: it.locationId, label: `(${it.locationId}) ${p?.nomeCompleto || 'Produto desconhecido'} - ${it.quantity} caixas` };
                    })
                    .sort((a,b)=>a.locationId.localeCompare(b.locationId))
                    .map(r=>`<option value="${r.idx}">${r.label}</option>`).join('')
                  }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">2. Quantidade a Retirar</label>
                <input type="number" id="saida-quantidade" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Máx: 0">
              </div>
              <button type="submit" class="w-full bg-red-600 text-white px-4 py-3 rounded-md hover:bg-red-700 font-bold text-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 mr-2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>
                Confirmar Saída Manual
              </button>
            </form>
        </div>
      `;
      setupSaidaFormListeners();
    };

    const renderRouteExecutionBlock = () => {
      const state = activeRouteExecution;
      if (!state?.route) {
        return `
          <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
            <p class="text-gray-600">Selecione uma rota de separação ou gere uma rota de otimização para ver os passos.</p>
          </div>
        `;
      }

      const { route, source } = state;
      const steps = [...(route.steps || [])].sort((a, b) => (a.step_order || a.stepOrder || 0) - (b.step_order || b.stepOrder || 0));
      const total = steps.length || 1;
      const completed = steps.filter((s) => s.status === 'done' || s.status === 'skipped').length;
      const progress = Math.round((completed / total) * 100);
      const hasPending = steps.some((s) => s.status === 'pending');
      const disableActions = source === 'optimization' || separationLoading.action;

      const cards = steps.map((step) => {
        const statusColors = {
          pending: 'bg-yellow-100 text-yellow-700',
          done: 'bg-green-100 text-green-700',
          skipped: 'bg-gray-200 text-gray-700'
        };
        const badge = statusColors[step.status] || 'bg-gray-100 text-gray-700';
        const actionLabel = step.action || 'PASSO';
        const origin = step.from_location || '-';
        const destination = step.to_location || '-';
        const temperature = step.temperature === 'hot' ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">Quente</span>' :
          step.temperature === 'cold' ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">Frio</span>' : '';

        return `
          <div class="border rounded-lg p-4 shadow-sm bg-white flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-sm font-semibold text-indigo-700">#${step.step_order || step.stepOrder || 0}</span>
                <span class="text-sm font-semibold">${actionLabel}</span>
                ${temperature}
              </div>
              <span class="text-xs px-2 py-1 rounded ${badge}">${formatSeparationStatus(step.status)}</span>
            </div>
            <div class="text-sm text-gray-700">
              <div class="flex items-center gap-2"><span class="font-semibold">Produto:</span> ${getProductLabel(step.product_id)}</div>
              <div class="flex items-center gap-2"><span class="font-semibold">Quantidade:</span> ${step.quantity}</div>
              <div class="flex items-center gap-2"><span class="font-semibold">Origem:</span> ${origin}</div>
              <div class="flex items-center gap-2"><span class="font-semibold">Destino:</span> ${destination}</div>
            </div>
            <div class="flex gap-2">
              <button data-step-id="${step.id}" class="route-step-done flex-1 px-3 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50" ${disableActions || step.status !== 'pending' ? 'disabled' : ''}>Concluir</button>
              <button data-step-id="${step.id}" data-skip="1" class="route-step-skip flex-1 px-3 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 disabled:opacity-50" ${disableActions || step.status !== 'pending' ? 'disabled' : ''}>Pular</button>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-xl font-bold">Execução da rota</h3>
              <p class="text-sm text-gray-500">${route.name || 'Rota'} · ${steps.length} passos</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-40">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-2 bg-indigo-500" style="width:${progress}%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-1">${completed} de ${total} concluídos (${progress}%)</p>
              </div>
              <button id="route-complete-all" class="px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50" ${disableActions || !hasPending ? 'disabled' : ''}>Concluir tudo</button>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">${cards}</div>
          ${source === 'optimization' ? '<p class="text-xs text-gray-500 mt-4">Rota sugerida para otimização (apenas simulação).</p>' : ''}
        </div>
      `;
    };

    const renderSeparation = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-separacao');
      const hash = window.location.hash || '#separacao-listas';
      separationTab = hash.includes('otimizacao') ? 'otimizacao' : 'listas';

      const tabSwitcher = `
        <div class="flex flex-wrap gap-3 mb-6">
          <button class="px-4 py-2 rounded-md ${separationTab === 'listas' ? 'bg-indigo-600 text-white' : 'bg-white border'}" id="tab-listas">Listas</button>
          <button class="px-4 py-2 rounded-md ${separationTab === 'otimizacao' ? 'bg-indigo-600 text-white' : 'bg-white border'}" id="tab-otimizacao">Otimização</button>
        </div>`;

      const buildListsTab = () => {
        const listRows = separationLists.map((list) => {
          const itemsCount = list.items?.length || 0;
          const created = list.created_at ? new Date(list.created_at).toLocaleString('pt-BR') : '-';
          const detail = separationDetails[list.id];
          const lastRoute = detail?.routes?.slice(-1)?.[0];
          const routeStatus = lastRoute ? formatSeparationStatus(lastRoute.status) : 'Sem rota';
          return `
            <tr class="border-t">
              <td class="px-3 py-2 font-semibold">${list.name}</td>
              <td class="px-3 py-2 text-sm text-gray-700">${formatSeparationStatus(list.status)}</td>
              <td class="px-3 py-2 text-sm text-gray-700">${itemsCount}</td>
              <td class="px-3 py-2 text-sm text-gray-700">${created}</td>
              <td class="px-3 py-2 text-sm text-gray-700">${routeStatus}</td>
              <td class="px-3 py-2 text-sm text-right space-x-2">
                <button data-open-list="${list.id}" class="px-3 py-1 rounded-md bg-white border hover:bg-gray-50">Abrir</button>
                <button data-generate-route="${list.id}" class="px-3 py-1 rounded-md bg-indigo-600 text-white hover:bg-indigo-700">Gerar rota</button>
                <button data-view-route="${list.id}" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300" ${lastRoute ? '' : 'disabled'}>Ver rota</button>
              </td>
            </tr>
          `;
        }).join('') || '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">Nenhuma lista criada.</td></tr>';

        const current = currentSeparationListId ? separationDetails[currentSeparationListId] : separationDraft;
        const isSaved = Boolean(currentSeparationListId);
        const items = isSaved ? (current?.items || []) : separationDraft.items;
        const productOptions = filterProductsByTerm(separationSearchTerm);
        const selectedProduct = productOptions[0]?.id || '';
        clampSeparationPickerState();
        const pickerOptions = getSeparationPickerOptions();
        const pickerMatches = getSeparationPickerMatches();
        const pickerSelectionRows = separationPicker.selections.map((sel) => {
          const prod = productList.find(p => String(p.id) === String(sel.productId));
          if (!prod) return '';
          const label = `${prod.modelo} ${prod.grade} ${prod.material} ${prod.variacao}`;
          return `
            <tr class="border-t">
              <td class="px-2 py-1 text-sm">${label}</td>
              <td class="px-2 py-1 text-sm">${prod.id}</td>
              <td class="px-2 py-1 text-sm">
                <input type="number" min="1" value="${sel.quantity || 1}" data-selection-qty="${sel.productId}" class="w-24 border rounded px-2 py-1" ${isSaved ? 'disabled' : ''} />
              </td>
              <td class="px-2 py-1 text-sm text-right">
                <button data-remove-selection="${sel.productId}" class="text-red-600 hover:underline" ${isSaved ? 'disabled' : ''}>Remover</button>
              </td>
            </tr>
          `;
        }).join('') || '<tr><td colspan="4" class="px-2 py-3 text-center text-gray-500">Nenhuma seleção aplicada.</td></tr>';
        const routesHtml = (current?.routes || []).map((route) => `
          <div class="border rounded-md p-3 flex items-center justify-between">
            <div>
              <p class="font-semibold">${route.name}</p>
              <p class="text-xs text-gray-500">${formatSeparationStatus(route.status)} · ${route.steps?.length || 0} passos</p>
            </div>
            <button data-open-route="${route.id}" class="px-3 py-1 rounded-md bg-indigo-100 text-indigo-800 hover:bg-indigo-200">Executar</button>
          </div>
        `).join('') || '<p class="text-sm text-gray-500">Nenhuma rota gerada ainda.</p>';

        const itemsRows = items.map((item, idx) => {
          const requested = item.requested_qty ?? item.requestedQty ?? item.quantity ?? 0;
          const separated = item.separated_qty ?? item.separatedQty ?? 0;
          const status = formatSeparationStatus(item.status || 'pending');
          const removeBtn = !isSaved ? `<button data-remove-item="${idx}" class="text-red-600 hover:underline">Remover</button>` : '';
          return `
            <tr class="border-t">
              <td class="px-2 py-1 text-sm">${getProductLabel(item.product_id || item.productId)}</td>
              <td class="px-2 py-1 text-sm">${requested}</td>
              <td class="px-2 py-1 text-sm">${separated}</td>
              <td class="px-2 py-1 text-sm">${status}</td>
              <td class="px-2 py-1 text-sm text-right">${removeBtn}</td>
            </tr>`;
        }).join('') || '<tr><td colspan="5" class="px-2 py-3 text-center text-gray-500">Nenhum item adicionado.</td></tr>';

        return `
          <div class="space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-bold">Listas de separação</h2>
                <p class="text-sm text-gray-600">Crie e acompanhe listas com itens para picking.</p>
              </div>
              <div class="flex gap-2">
                <button id="sep-refresh" class="px-4 py-2 rounded-md bg-white border hover:bg-gray-50 ${separationLoading.lists ? 'opacity-50' : ''}" ${separationLoading.lists ? 'disabled' : ''}>Atualizar</button>
                <button id="sep-new-list" class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700">Nova lista</button>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-x-auto">
              <table class="min-w-full text-left text-sm">
                <thead class="bg-gray-50">
                  <tr><th class="px-3 py-2">Nome</th><th class="px-3 py-2">Status</th><th class="px-3 py-2">Itens</th><th class="px-3 py-2">Criada</th><th class="px-3 py-2">Rota</th><th class="px-3 py-2 text-right">Ações</th></tr>
                </thead>
                <tbody>${listRows}</tbody>
              </table>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="text-lg font-bold">Editor de lista</h3>
                    <p class="text-xs text-gray-500">Busca/QR para incluir itens e salvar como rascunho.</p>
                  </div>
                  ${isSaved ? `<span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700">${formatSeparationStatus(current.status)}</span>` : ''}
                </div>
                <div class="space-y-3">
                  <div class="p-3 rounded-lg border border-indigo-100 bg-indigo-50">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                      <div>
                        <p class="text-sm font-semibold text-indigo-900">Selecione variáveis como no menu de entrada</p>
                        <p class="text-xs text-indigo-800">Escolha múltiplos valores por etapa (modelo, grade, material e variação) e confirme para montar a lista.</p>
                      </div>
                      <div class="text-xs font-semibold text-indigo-800 bg-white px-3 py-1 rounded-full border border-indigo-200">${pickerMatches.length} produtos encontrados</div>
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                      ${buildPickerChipGroup('modelos', 'Modelos', pickerOptions.availableModelos, separationPicker.modelos, isSaved)}
                      ${buildPickerChipGroup('grades', 'Grades', pickerOptions.availableGrades, separationPicker.grades, isSaved)}
                      ${buildPickerChipGroup('materiais', 'Materiais', pickerOptions.availableMateriais, separationPicker.materiais, isSaved)}
                      ${buildPickerChipGroup('variacoes', 'Variações', pickerOptions.availableVariacoes, separationPicker.variacoes, isSaved)}
                    </div>
                    <div class="mt-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                      <p class="text-xs text-indigo-900">Confirme para carregar todas as combinações escolhidas e ajuste quantidades antes de enviar para a lista.</p>
                      <div class="flex gap-2 flex-wrap">
                        <button id="sep-apply-picker" class="px-3 py-2 rounded-md bg-white border border-indigo-200 text-indigo-800 hover:bg-indigo-100 disabled:opacity-50" ${isSaved ? 'disabled' : ''}>Confirmar escolhas</button>
                        <button id="sep-merge-picker" class="px-3 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50" ${isSaved ? 'disabled' : ''}>Enviar seleções para a lista</button>
                      </div>
                    </div>
                    <div class="mt-3 overflow-x-auto bg-white rounded-md border border-indigo-100">
                      <table class="min-w-full text-sm">
                        <thead class="bg-indigo-50 text-indigo-900"><tr><th class="px-2 py-1 text-left">Produto</th><th class="px-2 py-1 text-left">SKU</th><th class="px-2 py-1 text-left">Qtd</th><th class="px-2 py-1 text-right">Ações</th></tr></thead>
                        <tbody>${pickerSelectionRows}</tbody>
                      </table>
                    </div>
                  </div>
                  <label class="block text-sm font-medium text-gray-700">Nome da lista</label>
                  <input id="sep-name" type="text" value="${isSaved ? (current?.name || '') : (separationDraft.name || '')}" class="w-full border rounded-md px-3 py-2" ${isSaved ? 'disabled' : ''} />
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium text-gray-700">Buscar SKU/Modelo</label>
                      <div class="flex gap-2">
                        <input id="sep-search" type="text" value="${separationSearchTerm}" placeholder="Digite ou escaneie" class="flex-1 border rounded-md px-3 py-2" ${isSaved ? 'disabled' : ''}/>
                        <button id="sep-scan-btn" class="px-3 py-2 rounded-md bg-gray-200 hover:bg-gray-300" ${isSaved ? 'disabled' : ''}>QR</button>
                      </div>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700">Produto</label>
                      <select id="sep-product-select" class="w-full border rounded-md px-3 py-2" ${isSaved ? 'disabled' : ''}>
                        ${productOptions.map((p) => `<option value="${p.id}" ${String(p.id) === String(selectedProduct) ? 'selected' : ''}>${p.modelo || p.nome} ${p.variacao || ''} (${p.id})</option>`).join('')}
                      </select>
                    </div>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium text-gray-700">Quantidade</label>
                      <input id="sep-quantity" type="number" min="1" value="1" class="w-full border rounded-md px-3 py-2" ${isSaved ? 'disabled' : ''}/>
                    </div>
                    <div class="flex items-end">
                      <button id="sep-add-item" class="w-full px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50" ${isSaved ? 'disabled' : ''}>Adicionar item</button>
                    </div>
                  </div>

                  <div class="mt-2 overflow-x-auto">
                    <table class="min-w-full text-sm">
                      <thead class="bg-gray-50"><tr><th class="px-2 py-1">Produto</th><th class="px-2 py-1">Solicitado</th><th class="px-2 py-1">Separado</th><th class="px-2 py-1">Status</th><th class="px-2 py-1"></th></tr></thead>
                      <tbody>${itemsRows}</tbody>
                    </table>
                  </div>

                  <div class="flex gap-3">
                    <button id="sep-save-draft" class="flex-1 px-4 py-2 rounded-md bg-white border hover:bg-gray-50 disabled:opacity-50" ${isSaved || separationLoading.action ? 'disabled' : ''}>Salvar rascunho</button>
                    <button id="sep-generate-route" class="flex-1 px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50" ${separationLoading.action ? 'disabled' : ''}>Gerar rota</button>
                  </div>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="text-lg font-bold">Rotas da lista</h3>
                    <p class="text-xs text-gray-500">Selecione uma rota para executar.</p>
                  </div>
                </div>
                <div class="space-y-2">${routesHtml}</div>
              </div>
            </div>

            ${renderRouteExecutionBlock()}
          </div>
        `;
      };

      const buildOptimizationTab = () => {
        return `
          <div class="space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-bold">Otimização</h2>
                <p class="text-sm text-gray-600">Ajuste filtros e gere uma rota sugerida para reduzir espalhamento.</p>
              </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
              <div class="grid md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">Janela (dias)</label>
                  <input id="opt-window" type="number" min="1" value="${optimizationFilters.windowDays}" class="w-full border rounded-md px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">maxMoves</label>
                  <input id="opt-max" type="number" min="1" value="${optimizationFilters.maxMoves}" class="w-full border rounded-md px-3 py-2" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">threshold</label>
                  <input id="opt-threshold" type="number" min="1" value="${optimizationFilters.threshold}" class="w-full border rounded-md px-3 py-2" />
                </div>
                <div class="flex items-center gap-2 pt-6">
                  <input id="opt-hot" type="checkbox" ${optimizationFilters.hotOnly ? 'checked' : ''} class="h-4 w-4" />
                  <label for="opt-hot" class="text-sm text-gray-700">Somente quentes</label>
                </div>
              </div>
              <div class="mt-4 flex justify-end">
                <button id="opt-generate" class="px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50" ${separationLoading.action ? 'disabled' : ''}>Gerar rota</button>
              </div>
            </div>
            ${renderRouteExecutionBlock()}
          </div>
        `;
      };

      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-4">Separação</h1>
        ${tabSwitcher}
        ${separationTab === 'listas' ? buildListsTab() : buildOptimizationTab()}
      `;

      document.getElementById('tab-listas')?.addEventListener('click', () => setSeparationTab('listas'));
      document.getElementById('tab-otimizacao')?.addEventListener('click', () => setSeparationTab('otimizacao'));

      document.getElementById('sep-new-list')?.addEventListener('click', () => { resetSeparationEditor(); rerenderCurrentPage(); });
      document.getElementById('sep-refresh')?.addEventListener('click', async () => { await refreshSeparationLists(); rerenderCurrentPage(); });

      document.querySelectorAll('[data-open-list]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const listId = btn.getAttribute('data-open-list');
          const detail = await ensureSeparationDetail(listId);
          if (detail) {
            currentSeparationListId = listId;
            rerenderCurrentPage();
          }
        });
      });

      document.querySelectorAll('[data-view-route]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const listId = btn.getAttribute('data-view-route');
          const detail = await ensureSeparationDetail(listId);
          const route = detail?.routes?.slice(-1)?.[0];
          if (route) {
            activeRouteExecution = { source: 'separation', route };
            currentSeparationListId = listId;
            rerenderCurrentPage();
          }
        });
      });

      document.querySelectorAll('[data-generate-route]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const listId = btn.getAttribute('data-generate-route');
          await ensureSeparationDetail(listId);
          currentSeparationListId = listId;
          await generateRouteForList(listId);
          rerenderCurrentPage();
        });
      });

      document.querySelectorAll('[data-open-route]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const routeId = btn.getAttribute('data-open-route');
          const detail = currentSeparationListId ? separationDetails[currentSeparationListId] : null;
          const route = detail?.routes?.find((r) => String(r.id) === String(routeId));
          if (route) {
            activeRouteExecution = { source: 'separation', route };
            rerenderCurrentPage();
          }
        });
      });

      const nameInput = document.getElementById('sep-name');
      if (nameInput && !nameInput.disabled) {
        nameInput.addEventListener('input', (e) => {
          separationDraft.name = e.target.value;
        });
      }

      const searchInput = document.getElementById('sep-search');
      if (searchInput && !searchInput.disabled) {
        searchInput.addEventListener('input', (e) => {
          separationSearchTerm = e.target.value;
          rerenderCurrentPage();
        });
      }
      attachScanToSearch();

      document.querySelectorAll('[data-remove-item]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-remove-item'));
          separationDraft.items.splice(idx, 1);
          rerenderCurrentPage();
        });
      });

      document.querySelectorAll('[data-picker-toggle]').forEach((btn) => {
        if (btn.disabled) return;
        btn.addEventListener('click', () => {
          const field = btn.getAttribute('data-picker-toggle');
          const value = btn.getAttribute('data-value');
          if (!field || !value || !separationPicker[field]) return;
          const exists = separationPicker[field].includes(value);
          separationPicker[field] = exists
            ? separationPicker[field].filter((v) => v !== value)
            : [...separationPicker[field], value];
          rerenderCurrentPage();
        });
      });

      document.getElementById('sep-apply-picker')?.addEventListener('click', () => {
        applySeparationPickerSelection();
        rerenderCurrentPage();
      });

      document.getElementById('sep-merge-picker')?.addEventListener('click', () => {
        mergePickerIntoDraft();
        rerenderCurrentPage();
      });

      document.querySelectorAll('[data-selection-qty]').forEach((input) => {
        input.addEventListener('input', (e) => {
          const id = input.getAttribute('data-selection-qty');
          const qty = Math.max(1, Number(e.target.value) || 1);
          const target = separationPicker.selections.find((sel) => String(sel.productId) === String(id));
          if (target) target.quantity = qty;
        });
      });

      document.querySelectorAll('[data-remove-selection]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-remove-selection');
          separationPicker.selections = separationPicker.selections.filter((sel) => String(sel.productId) !== String(id));
          rerenderCurrentPage();
        });
      });

      const addBtn = document.getElementById('sep-add-item');
      if (addBtn && !addBtn.disabled) {
        addBtn.addEventListener('click', () => {
          const productId = document.getElementById('sep-product-select')?.value;
          const quantity = Number(document.getElementById('sep-quantity')?.value || 0);
          if (!productId || quantity <= 0) {
            showToast('Selecione o produto e quantidade.', 'error');
            return;
          }
          separationDraft.items.push({ productId: Number(productId), requestedQty: quantity, separatedQty: 0, status: 'pending' });
          showToast('Item adicionado ao rascunho.', 'success');
          rerenderCurrentPage();
        });
      }

      document.getElementById('sep-save-draft')?.addEventListener('click', async () => {
        await saveSeparationDraft(false);
        rerenderCurrentPage();
      });

      document.getElementById('sep-generate-route')?.addEventListener('click', async () => {
        if (currentSeparationListId) {
          await generateRouteForList(currentSeparationListId);
        } else {
          const created = await saveSeparationDraft(true);
          if (created?.routes?.length) {
            activeRouteExecution = { source: 'separation', route: created.routes[created.routes.length - 1] };
          }
        }
        rerenderCurrentPage();
      });

      document.getElementById('opt-window')?.addEventListener('input', (e) => {
        optimizationFilters.windowDays = Number(e.target.value) || optimizationFilters.windowDays;
      });
      document.getElementById('opt-max')?.addEventListener('input', (e) => {
        optimizationFilters.maxMoves = Number(e.target.value) || optimizationFilters.maxMoves;
      });
      document.getElementById('opt-threshold')?.addEventListener('input', (e) => {
        optimizationFilters.threshold = Number(e.target.value) || optimizationFilters.threshold;
      });
      document.getElementById('opt-hot')?.addEventListener('change', (e) => {
        optimizationFilters.hotOnly = Boolean(e.target.checked);
      });
      document.getElementById('opt-generate')?.addEventListener('click', async () => {
        await runOptimizationRoute();
        rerenderCurrentPage();
      });

      document.querySelectorAll('.route-step-done').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const stepId = btn.getAttribute('data-step-id');
          await confirmRouteSteps(activeRouteExecution?.route?.id, { stepId });
          rerenderCurrentPage();
        });
      });
      document.querySelectorAll('.route-step-skip').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const stepId = btn.getAttribute('data-step-id');
          await confirmRouteSteps(activeRouteExecution?.route?.id, { stepId, status: 'skipped' });
          rerenderCurrentPage();
        });
      });
      document.getElementById('route-complete-all')?.addEventListener('click', async () => {
        await confirmRouteSteps(activeRouteExecution?.route?.id, {});
        rerenderCurrentPage();
      });
    };

    const renderMap = () => {
      const container = document.getElementById('page-mapa');
      const locationsHtml = mapLayout.locations.map(loc => {
        const positionsHtml = mapLayout.positions.map(pos => {
          const positionId = `${loc}-${pos}`;
          const itemsInPosition = inventory.filter(i => i.locationId === positionId);
          const qtyInPosition = itemsInPosition.reduce((sum, item) => sum + item.quantity, 0);
          const hasItems = qtyInPosition > 0;
          let positionClass = hasItems ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
          
          return `
            <div id="map-cell-${positionId}" data-location-id="${positionId}" class="map-card-position cursor-pointer p-3 rounded-md font-semibold ${positionClass}">
              ${pos} ${qtyInPosition > 0 ? `(${qtyInPosition})` : ''}
            </div>
          `;
        }).join('');
    
        return `
          <div class="bg-white rounded-lg shadow-md p-2 flex flex-col gap-2 text-center select-none">
            <div class="font-bold text-gray-700 border-b pb-1 text-lg">${loc}</div>
            ${positionsHtml}
          </div>
        `;
      }).join('');
    
      container.innerHTML = `
          <h1 class="text-3xl font-bold mb-2">Mapa do Estoque</h1>
          <p class="text-gray-600 mb-6">Clique em uma posição para ver detalhes ou use a busca para encontrar um produto.</p>
          <div class="mb-4">
               <input type="text" id="map-search" placeholder="Buscar produto no mapa..." class="w-full max-w-md p-2 border rounded-md">
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
              ${locationsHtml}
          </div>
      `;
      document.querySelectorAll('.map-card-position').forEach(cell => {
          cell.addEventListener('click', () => {
              const locationId = cell.dataset.locationId;
              
              if(moveOperation) {
                  handleMoveSelection(locationId);
              } else {
                  const items = inventory.filter(i => i.locationId === locationId);
                  showMapCellModal(locationId, items);
              }
          });
      });
      document.getElementById('map-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('.map-card-position').forEach(cell => {
              cell.parentElement.classList.remove('opacity-25');
              cell.classList.remove('ring-4', 'ring-yellow-400');
              
              const parentCard = cell.parentElement;
              const hasMatchInCard = Array.from(parentCard.querySelectorAll('.map-card-position')).some(pos => {
                  const locationId = pos.dataset.locationId;
                  const itemsInPos = inventory.filter(i => i.locationId === locationId);
                  return itemsInPos.some(item => {
                    const product = productList.find(p => p.id === item.productId);
                    return product && product.nomeCompleto.toLowerCase().includes(searchTerm);
                  });
              });
    
              if (searchTerm && !hasMatchInCard) {
                  parentCard.classList.add('opacity-25');
              } else if (searchTerm && hasMatchInCard) {
                  const locationId = cell.dataset.locationId;
                  const items = inventory.filter(i => i.locationId === locationId);
                  const cellHasMatch = items.some(item => {
                      const product = productList.find(p => p.id === item.productId);
                      return product && product.nomeCompleto.toLowerCase().includes(searchTerm);
                  });
                  if (cellHasMatch) {
                    cell.classList.add('ring-4', 'ring-yellow-400');
                  }
              }
          });
      });
    };
     
    const renderProdutos = () => {
        const container = document.getElementById('page-produtos');
        container.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold">Gestão de Produtos</h1>
                <div class="flex gap-2 flex-wrap">
                    <button id="print-products-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 font-semibold flex items-center gap-2 disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                        Imprimir/Baixar
                    </button>
                    <button id="bulk-add-products-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 font-semibold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layers"><path d="m12.59 3.17 8.16 4.07a1 1 0 0 1 0 1.78l-8.16 4.07a1 1 0 0 1-.86 0L3.57 9.02a1 1 0 0 1 0-1.78l8.16-4.07a1 1 0 0 1 .86 0Z"/><path d="m3.6 10.44 8.16 4.07a1 1 0 0 0 .86 0l8.16-4.07"/><path d="m3.6 15.44 8.16 4.07a1 1 0 0 0 .86 0l8.16-4.07"/></svg>
                        Cadastro em massa
                    </button>
                    <button id="add-product-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                        Novo Produto
                    </button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left"><input type="checkbox" id="select-all-products"></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variação/Cor</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${productList.sort((a,b) => a.id - b.id).map(p => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap"><input type="checkbox" class="product-checkbox" data-product-id="${p.id}"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.id}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.modelo}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.grade}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.material}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.variacao}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        document.getElementById('add-product-btn').addEventListener('click', showAddProductModal);
        document.getElementById('bulk-add-products-btn').addEventListener('click', showBulkAddProductsModal);
        
        const printBtn = document.getElementById('print-products-btn');
        const selectAllCheckbox = document.getElementById('select-all-products');
        const checkboxes = document.querySelectorAll('.product-checkbox');

        const togglePrintButton = () => {
            const anyChecked = [...checkboxes].some(c => c.checked);
            printBtn.disabled = !anyChecked;
        };

        selectAllCheckbox.addEventListener('change', (e) => {
            checkboxes.forEach(c => c.checked = e.target.checked);
            togglePrintButton();
        });

        checkboxes.forEach(c => c.addEventListener('change', togglePrintButton));
        
        printBtn.addEventListener('click', () => {
            const selectedIds = [...checkboxes].filter(c => c.checked).map(c => parseInt(c.dataset.productId));
            const selectedProducts = productList.filter(p => selectedIds.includes(p.id));
            showPrintProductsModal(selectedProducts);
        });
    };

    const populateSelect = (elementId, options, selectedValues) => {
      const select = document.getElementById(elementId);
      select.innerHTML = options.map(opt => 
        `<option value="${opt}" ${selectedValues.includes(opt) ? 'selected' : ''}>${opt}</option>`
      ).join('');
    };

    const updateReportFilters = () => {
      const getSelectedValues = (id) => Array.from(document.getElementById(id).selectedOptions).map(opt => opt.value);

      const selectedModelos = getSelectedValues('filter-modelo');
      const selectedGrades = getSelectedValues('filter-grade');
      const selectedMateriais = getSelectedValues('filter-material');
      const selectedVariacoes = getSelectedValues('filter-variacao');

      let listForGrades = productList;
      if(selectedModelos.length) listForGrades = listForGrades.filter(p => selectedModelos.includes(p.modelo));
      const availableGrades = [...new Set(listForGrades.map(p => p.grade))].sort();

      let listForMateriais = listForGrades;
      if(selectedGrades.length) listForMateriais = listForMateriais.filter(p => selectedGrades.includes(p.grade));
      const availableMateriais = [...new Set(listForMateriais.map(p => p.material))].sort();

      let listForVariacoes = listForMateriais;
      if(selectedMateriais.length) listForVariacoes = listForVariacoes.filter(p => selectedMateriais.includes(p.material));
      const availableVariacoes = [...new Set(listForVariacoes.map(p => p.variacao))].sort();
      
      const availableModelos = [...new Set(productList.map(p => p.modelo))].sort();

      populateSelect('filter-modelo', availableModelos, selectedModelos);
      populateSelect('filter-grade', availableGrades, selectedGrades);
      populateSelect('filter-material', availableMateriais, selectedMateriais);
      populateSelect('filter-variacao', availableVariacoes, selectedVariacoes);
    };

    const getFilteredReportRows = () => {
      const getSelectedValues = (elementId) => Array.from(document.getElementById(elementId).selectedOptions).map(option => option.value);
      const modelosSel = getSelectedValues('filter-modelo');
      const gradesSel = getSelectedValues('filter-grade');
      const materiaisSel = getSelectedValues('filter-material');
      const variacoesSel = getSelectedValues('filter-variacao');
      
      let rows = inventory.map(i => ({ ...i, product: productList.find(p => p.id === i.productId) }));
      
      if (modelosSel.length > 0) rows = rows.filter(r => r.product && modelosSel.includes(r.product.modelo));
      if (gradesSel.length > 0) rows = rows.filter(r => r.product && gradesSel.includes(r.product.grade));
      if (materiaisSel.length > 0) rows = rows.filter(r => r.product && materiaisSel.includes(r.product.material));
      if (variacoesSel.length > 0) rows = rows.filter(r => r.product && variacoesSel.includes(r.product.variacao));

      return rows.filter(r => r.product);
    };

    const generateSummaryReport = () => {
      const rows = getFilteredReportRows();
      const result = document.getElementById('report-result');
      const printBtn = document.getElementById('print-report-btn');
      const exportBtn = document.getElementById('export-csv-btn');

      if (!rows.length) {
        result.innerHTML = `<p class="text-gray-600 mt-4">Nenhum item encontrado com os filtros selecionados.</p>`;
        printBtn.disabled = true;
        exportBtn.disabled = true;
        return;
      }

      const summary = rows.reduce((acc, item) => {
        if (!acc[item.productId]) {
          acc[item.productId] = {
            product: item.product,
            totalQuantity: 0,
          };
        }
        acc[item.productId].totalQuantity += item.quantity;
        return acc;
      }, {});

      const summaryRows = Object.values(summary).sort((a, b) => a.product.nomeCompleto.localeCompare(b.product.nomeCompleto));

      result.innerHTML = `
        <h3 class="text-xl font-semibold mb-2">Relatório Quantitativo</h3>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full divide-y divide-gray-200" id="report-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade Total</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${summaryRows.map(r => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${r.product.nomeCompleto}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${r.totalQuantity} caixas</td>
                  </tr>`).join('')
              }
            </tbody>
          </table>
        </div>
      `;
      printBtn.disabled = false;
      exportBtn.disabled = false;
    };

    const generateDetailedReport = () => {
      const rows = getFilteredReportRows();
      const result = document.getElementById('report-result');
      const printBtn = document.getElementById('print-report-btn');
      const exportBtn = document.getElementById('export-csv-btn');
      
      if (!rows.length) {
        result.innerHTML = `<p class="text-gray-600 mt-4">Nenhum item encontrado com os filtros selecionados.</p>`;
        printBtn.disabled = true;
        exportBtn.disabled = true;
        return;
      }

      result.innerHTML = `
        <h3 class="text-xl font-semibold mb-2">Relatório Detalhado</h3>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full divide-y divide-gray-200" id="report-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localização</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${rows.sort((a,b)=>a.product.nomeCompleto.localeCompare(b.product.nomeCompleto)).map(r=>`
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${r.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.locationId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${r.product.nomeCompleto}</td>
                  </tr>`).join('')
              }
            </tbody>
          </table>
        </div>
      `;
      printBtn.disabled = false;
      exportBtn.disabled = false;
    };

    const renderReports = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-relatorios');

      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Gerador de Relatórios</h1>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> 
            <div>
                <label class="block text-sm font-medium text-gray-700">Modelo</label>
                <select id="filter-modelo" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                <p class="text-xs text-gray-500 mt-1">Use Ctrl/Cmd para múltiplos.</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Grade</label>
                <select id="filter-grade" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Material</label>
                <select id="filter-material" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Variação / Cor</label>
                <select id="filter-variacao" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
            </div>
          </div>
          <div class="flex flex-col md:flex-row gap-3">
            <button id="generate-summary-report-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold">Gerar Quantitativo</button>
            <button id="generate-detailed-report-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 font-semibold">Gerar Detalhado (com Local)</button>
            <button id="print-report-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed font-semibold" disabled>Imprimir</button>
            <button id="export-csv-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed font-semibold" disabled>Exportar CSV</button>
          </div>
          <div id="report-result" class="mt-6"></div>
        </div>
      `;

      document.getElementById('filter-modelo').addEventListener('change', updateReportFilters);
      document.getElementById('filter-grade').addEventListener('change', updateReportFilters);
      document.getElementById('filter-material').addEventListener('change', updateReportFilters);
      document.getElementById('filter-variacao').addEventListener('change', updateReportFilters);

      document.getElementById('generate-summary-report-btn').addEventListener('click', generateSummaryReport);
      document.getElementById('generate-detailed-report-btn').addEventListener('click', generateDetailedReport);
      document.getElementById('print-report-btn').addEventListener('click', handlePrintReport);
      document.getElementById('export-csv-btn').addEventListener('click', handleExportCSV);
      
      updateReportFilters();
    };

    const renderEtiquetas = () => {
        document.body.classList.remove('move-mode-active');
        moveOperation = null;
        const container = document.getElementById('page-etiquetas');

        if (!productList.length) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-8 text-center">
                    <h1 class="text-3xl font-bold mb-4">Etiquetas de Produto</h1>
                    <p class="text-gray-600">Cadastre pelo menos um produto para habilitar o gerador de etiquetas.</p>
                </div>
            `;
            return;
        }

        if (!labelTemplatesCatalog.length) {
            labelTemplatesCatalog = deepClone(defaultLabelTemplates);
        }

        if (!labelDesignerState.productId || !productList.some(p => String(p.id) === String(labelDesignerState.productId))) {
            labelDesignerState.productId = productList[0]?.id ?? null;
        }

        if (!labelDesignerState.templateId || !labelTemplatesCatalog.some(t => t.id === labelDesignerState.templateId)) {
            labelDesignerState.templateId = labelTemplatesCatalog[0]?.id ?? null;
        }

        if (!labelDesignerState.sequence.length) {
            labelDesignerState.sequence = buildSequenceFromPreset(labelDesignerState.gradeType, labelDesignerState.pairsPerSize);
        }

        const productOptions = productList
            .slice()
            .sort((a, b) => a.nomeCompleto.localeCompare(b.nomeCompleto))
            .map(p => `<option value="${p.id}" ${String(p.id) === String(labelDesignerState.productId) ? 'selected' : ''}>${p.nomeCompleto}</option>`)
            .join('');

        const templateOptions = labelTemplatesCatalog
            .map(t => `<option value="${t.id}" ${t.id === labelDesignerState.templateId ? 'selected' : ''}>${t.name}</option>`)
            .join('');

        const gradeOptions = [
            ...Object.entries(labelGradePresets).map(([key, preset]) => `<option value="${key}" ${labelDesignerState.gradeType === key ? 'selected' : ''}>${preset.label}</option>`),
            `<option value="custom" ${labelDesignerState.gradeType === 'custom' ? 'selected' : ''}>Customizada</option>`
        ].join('');

        container.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md lg:w-5/12 space-y-6">
                        <div>
                            <h1 class="text-3xl font-bold mb-2">Etiquetas de Produto</h1>
                            <p class="text-gray-600 text-sm">Selecione o produto, template e a grade para gerar até 12 etiquetas por página. As etiquetas extras representam as páginas 13/14.</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Produto</label>
                                <select id="label-product-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">${productOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Template</label>
                                <select id="label-template-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">${templateOptions}</select>
                                <p class="text-xs text-gray-500 mt-1">Novos templates podem ser cadastrados via /api/produtos (veja o README).</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo de grade</label>
                                    <select id="label-grade-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">${gradeOptions}</select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Pares por tamanho</label>
                                    <input type="number" id="label-pairs-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" min="1" value="${labelDesignerState.pairsPerSize}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Extras (pág. 13/14)</label>
                                    <input type="number" id="label-extra-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" min="0" max="2" value="${labelDesignerState.extraLabels}">
                                    <p class="text-[11px] text-gray-500 mt-1">Use 0 para apenas 12 etiquetas. 1 ou 2 adicionam as páginas 13/14.</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-lg font-semibold">Sequência de tamanhos</h2>
                                <button id="label-reset-sequence" class="text-sm text-blue-600 hover:text-blue-800">Recarregar grade</button>
                            </div>
                            <p class="text-xs text-gray-500">Edite a sequência para tiragens unitárias ou grades personalizadas.</p>
                            <div class="overflow-x-auto border border-gray-200 rounded-md mt-3">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Tamanho</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Qtd. etiquetas</th>
                                            <th class="px-3 py-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="label-sequence-body" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                            <div class="flex flex-wrap gap-3 mt-3">
                                <button id="label-add-row" class="px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200 text-sm font-semibold">Adicionar linha</button>
                                <span id="label-sequence-summary" class="text-xs text-gray-500 self-center"></span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-100">
                            <button id="label-preview-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold">Gerar prévia</button>
                            <button id="download-label-pdf" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-md font-semibold disabled:opacity-60" disabled>Gerar PDF</button>
                            <button id="download-label-pngs" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-md font-semibold disabled:opacity-60" disabled>Baixar PNGs</button>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="bg-white p-6 rounded-lg shadow-md h-full flex flex-col">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-semibold">Prévia das etiquetas</h2>
                                <span id="label-preview-meta" class="text-sm text-gray-500"></span>
                            </div>
                            <div id="label-preview-pages" class="space-y-6 overflow-y-auto" style="max-height:70vh;">
                                <p class="text-gray-500 text-sm">Configure os campos ao lado e clique em "Gerar prévia".</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const productSelect = document.getElementById('label-product-select');
        const templateSelect = document.getElementById('label-template-select');
        const gradeSelect = document.getElementById('label-grade-select');
        const pairsInput = document.getElementById('label-pairs-input');
        const extraInput = document.getElementById('label-extra-input');
        const sequenceBody = document.getElementById('label-sequence-body');
        const sequenceSummary = document.getElementById('label-sequence-summary');
        const previewBtn = document.getElementById('label-preview-btn');
        const pdfBtn = document.getElementById('download-label-pdf');
        const pngBtn = document.getElementById('download-label-pngs');
        const previewPages = document.getElementById('label-preview-pages');
        const previewMeta = document.getElementById('label-preview-meta');

        const resetPreview = (message = 'Configure os campos ao lado e clique em "Gerar prévia".') => {
            labelPreviewState.canvases = [];
            labelPreviewState.product = null;
            labelPreviewState.template = null;
            previewPages.innerHTML = `<p class="text-gray-500 text-sm">${message}</p>`;
            previewMeta.textContent = '';
            pdfBtn.disabled = true;
            pngBtn.disabled = true;
        };

        const buildLabelEntries = () => {
            const entries = [];
            labelDesignerState.sequence.forEach((row, rowIndex) => {
                const size = (row.size || '').trim();
                const quantity = Math.max(0, parseInt(row.quantity, 10) || 0);
                if (!size || quantity <= 0) return;
                for (let i = 0; i < quantity; i += 1) {
                    entries.push({ size, rowIndex, quantityForSize: quantity, pairIndex: i + 1, isExtra: false });
                }
            });
            const extraLabels = Math.min(2, Math.max(0, parseInt(labelDesignerState.extraLabels, 10) || 0));
            for (let i = 0; i < extraLabels; i += 1) {
                entries.push({ size: `Extra ${13 + i}`, rowIndex: 'extra', quantityForSize: 1, pairIndex: 1, isExtra: true });
            }
            return entries;
        };

        const updateSummary = () => {
            const entries = buildLabelEntries();
            const total = entries.length;
            const pages = total ? Math.ceil(total / LABELS_PER_PAGE) : 0;
            const extrasInfo = labelDesignerState.extraLabels ? ` | Extras: páginas ${Array.from({ length: labelDesignerState.extraLabels }, (_, idx) => 13 + idx).join(' e ')}` : '';
            const pageInfo = pages ? ` (${pages} página${pages > 1 ? 's' : ''})` : '';
            sequenceSummary.textContent = `${total} etiquetas previstas${pageInfo}${extrasInfo}`;
        };

        const renderSequenceRows = () => {
            sequenceBody.innerHTML = labelDesignerState.sequence.map((row, index) => `
                <tr>
                    <td class="px-3 py-2"><input type="text" class="w-full border border-gray-200 rounded-md px-2 py-1 text-sm label-size-input" data-index="${index}" value="${encodeInputValue(row.size)}" /></td>
                    <td class="px-3 py-2"><input type="number" class="w-full border border-gray-200 rounded-md px-2 py-1 text-sm label-qty-input" data-index="${index}" min="0" value="${row.quantity}" /></td>
                    <td class="px-3 py-2 text-right"><button type="button" class="text-red-500 hover:text-red-700 text-sm label-remove-row" data-index="${index}">Remover</button></td>
                </tr>
            `).join('');
            updateSummary();
            resetPreview('Configure os campos ao lado e clique em "Gerar prévia".');
        };

        renderSequenceRows();

        productSelect.addEventListener('change', (e) => {
            labelDesignerState.productId = e.target.value;
            resetPreview();
        });

        templateSelect.addEventListener('change', (e) => {
            labelDesignerState.templateId = e.target.value;
            resetPreview();
        });

        gradeSelect.addEventListener('change', (e) => {
            labelDesignerState.gradeType = e.target.value;
            if (labelDesignerState.gradeType !== 'custom') {
                labelDesignerState.sequence = buildSequenceFromPreset(labelDesignerState.gradeType, labelDesignerState.pairsPerSize);
                renderSequenceRows();
            }
            resetPreview();
        });

        pairsInput.addEventListener('change', (e) => {
            const qty = Math.max(1, parseInt(e.target.value, 10) || 1);
            labelDesignerState.pairsPerSize = qty;
            labelDesignerState.sequence = labelDesignerState.sequence.map(row => ({ ...row, quantity: qty }));
            e.target.value = qty;
            renderSequenceRows();
        });

        extraInput.addEventListener('change', (e) => {
            labelDesignerState.extraLabels = Math.min(2, Math.max(0, parseInt(e.target.value, 10) || 0));
            e.target.value = labelDesignerState.extraLabels;
            updateSummary();
            resetPreview();
        });

        document.getElementById('label-add-row').addEventListener('click', (e) => {
            e.preventDefault();
            labelDesignerState.sequence.push({ size: '', quantity: labelDesignerState.pairsPerSize });
            renderSequenceRows();
        });

        document.getElementById('label-reset-sequence').addEventListener('click', (e) => {
            e.preventDefault();
            labelDesignerState.sequence = buildSequenceFromPreset(labelDesignerState.gradeType === 'custom' ? 'baixa' : labelDesignerState.gradeType, labelDesignerState.pairsPerSize);
            labelDesignerState.gradeType = labelDesignerState.gradeType === 'custom' ? 'baixa' : labelDesignerState.gradeType;
            gradeSelect.value = labelDesignerState.gradeType;
            renderSequenceRows();
        });

        sequenceBody.addEventListener('input', (e) => {
            const index = parseInt(e.target.dataset.index, 10);
            if (Number.isNaN(index)) return;
            if (e.target.classList.contains('label-size-input')) {
                labelDesignerState.sequence[index].size = e.target.value;
            }
            if (e.target.classList.contains('label-qty-input')) {
                labelDesignerState.sequence[index].quantity = Math.max(0, parseInt(e.target.value, 10) || 0);
            }
            updateSummary();
            resetPreview();
        });

        sequenceBody.addEventListener('click', (e) => {
            if (!e.target.classList.contains('label-remove-row')) return;
            const index = parseInt(e.target.dataset.index, 10);
            if (Number.isNaN(index)) return;
            labelDesignerState.sequence.splice(index, 1);
            renderSequenceRows();
        });

        previewBtn.addEventListener('click', async () => {
            const product = productList.find(p => String(p.id) === String(labelDesignerState.productId));
            const template = labelTemplatesCatalog.find(t => t.id === labelDesignerState.templateId);
            if (!product) {
                showToast('Selecione um produto válido.', 'error');
                return;
            }
            if (!template) {
                showToast('Template não encontrado. Verifique o cadastro.', 'error');
                return;
            }
            const entries = buildLabelEntries();
            if (!entries.length) {
                showToast('Adicione ao menos uma linha com quantidade maior que zero.', 'error');
                return;
            }
            previewBtn.disabled = true;
            const previousText = previewBtn.textContent;
            previewBtn.textContent = 'Gerando...';
            previewPages.innerHTML = '<p class="text-gray-500 text-sm">Gerando etiquetas...</p>';
            previewMeta.textContent = '';
            try {
                const templateImage = await loadTemplateImage(template.artPath);
                const canvases = [];
                previewPages.innerHTML = '';
                let canvasIndex = 0;
                for (let pageIndex = 0; pageIndex < Math.ceil(entries.length / LABELS_PER_PAGE); pageIndex += 1) {
                    const pageLabels = entries.slice(pageIndex * LABELS_PER_PAGE, (pageIndex + 1) * LABELS_PER_PAGE);
                    const pageSection = document.createElement('section');
                    pageSection.className = 'border border-dashed border-gray-300 rounded-lg p-4';
                    pageSection.innerHTML = `<div class="flex items-center justify-between mb-3"><h3 class="font-semibold">Página ${pageIndex + 1}</h3><span class="text-sm text-gray-500">${pageLabels.length} etiqueta${pageLabels.length !== 1 ? 's' : ''}</span></div>`;
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4';
                    pageSection.appendChild(grid);
                    previewPages.appendChild(pageSection);

                    for (const entry of pageLabels) {
                        const canvas = await drawLabelFromTemplate(template, product, entry, labelDesignerState.gradeType, templateImage);
                        canvases.push(canvas);
                        const wrapper = document.createElement('div');
                        wrapper.className = 'bg-gray-50 rounded-lg p-3 flex flex-col gap-2 shadow-sm';
                        canvas.classList.add('w-full');
                        canvas.style.maxWidth = '100%';
                        wrapper.appendChild(canvas);
                        const caption = document.createElement('div');
                        caption.className = 'text-xs text-gray-600 flex flex-col';
                        caption.innerHTML = `<span>Tamanho: <strong>${entry.size}</strong></span><span>Etiqueta ${entry.pairIndex}/${entry.quantityForSize}${entry.isExtra ? ' (extra)' : ''}</span>`;
                        wrapper.appendChild(caption);
                        const singleButton = document.createElement('button');
                        singleButton.type = 'button';
                        singleButton.className = 'download-single-label text-xs text-blue-600 hover:text-blue-800 font-semibold self-start';
                        singleButton.dataset.index = canvasIndex.toString();
                        singleButton.textContent = 'Baixar esta etiqueta';
                        wrapper.appendChild(singleButton);
                        grid.appendChild(wrapper);
                        canvasIndex += 1;
                    }
                }
                labelPreviewState.canvases = canvases;
                labelPreviewState.template = template;
                labelPreviewState.product = product;
                previewMeta.textContent = `${canvases.length} etiqueta${canvases.length !== 1 ? 's' : ''} em ${Math.ceil(canvases.length / LABELS_PER_PAGE)} página${Math.ceil(canvases.length / LABELS_PER_PAGE) !== 1 ? 's' : ''}`;
                pdfBtn.disabled = !canvases.length;
                pngBtn.disabled = !canvases.length;
                if (!canvases.length) {
                    previewPages.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma etiqueta foi gerada para a configuração atual.</p>';
                }
            } catch (err) {
                console.error('Falha ao gerar etiquetas', err);
                showToast('Não foi possível gerar as etiquetas. Verifique o template.', 'error');
                resetPreview('Ocorreu um erro. Ajuste os dados e tente novamente.');
            } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = previousText;
            }
        });

        pdfBtn.addEventListener('click', (e) => {
            e.preventDefault();
            exportLabelPreviewToPDF();
        });

        pngBtn.addEventListener('click', (e) => {
            e.preventDefault();
            downloadAllLabelPNGs();
        });

        previewPages.addEventListener('click', (e) => {
            if (!e.target.classList.contains('download-single-label')) return;
            e.preventDefault();
            const index = Number(e.target.dataset.index);
            downloadSingleLabel(index);
        });
    };

    const renderHistory = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-historico');
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Histórico de Movimentações</h1>
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <ul class="divide-y divide-gray-200">
            ${history.map(h=>`
              <li class="p-4">
                <div class="flex items-center justify-between">
                   <span class="font-semibold text-lg ${h.type==='ENTRADA'?'text-green-600':h.type==='SAÍDA'?'text-red-600':h.type === 'MOVIMENTAÇÃO' ? 'text-blue-600':'text-yellow-500'}">${h.type}</span>
                  <span class="text-sm text-gray-500">${new Date(h.date).toLocaleString('pt-BR')}</span>
                </div>
                <p class="mt-2 text-gray-700">${h.details}</p>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    };
  
    const renderAdmin = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-admin');
      if (!adminAuthenticated) { 
          showAdminLoginModal(); 
          container.innerHTML = `<p class="text-center text-gray-600">Por favor, autentique-se para acessar o painel de administração.</p>`; 
          return; 
      }
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Painel de Administração</h1>
        <div class="space-y-6">

          <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <h2 class="text-xl font-bold mb-3">Gestão</h2>
            <div class="flex flex-wrap gap-3">
                <a href="#produtos" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-plus h-5 w-5"><path d="M16.5 9.4a4 4 0 1 1-8 0"/><path d="M12 15H6a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-3.5"/><path d="M15 6h6"/><path d="M18 3v6"/></svg>
                    Gerenciar Produtos
                </a>
                <a href="#etiquetas" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-qr-code h-5 w-5"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>
                    Imprimir Etiquetas de Posição
                </a>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
            <h2 class="text-xl font-bold mb-2">Ações Reversíveis</h2>
            <p class="text-gray-600 mb-4">Cuidado: afeta o histórico.</p>
            <button id="undo-last-action-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 ${history.length ? '' : 'opacity-50 cursor-not-allowed'}" ${history.length ? '' : 'disabled'}>Desfazer Última Ação</button>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
            <h2 class="text-xl font-bold mb-2">Ações Perigosas</h2>
            <p class="text-gray-600 mb-4">Irreversíveis e apagam dados permanentemente.</p>
            <button id="reset-stock-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Resetar Estoque Completo</button>
          </div>
        </div>
      `;
      document.getElementById('undo-last-action-btn')?.addEventListener('click', handleUndoLastAction);
      document.getElementById('reset-stock-btn')?.addEventListener('click', handleResetStock);
    };

    function setupEntradaFormListeners() {
      document.getElementById('entrada-scan-process-btn').addEventListener('click', () => startScanWorkflow('ENTRADA'));
      const modeloSelect = document.getElementById('entrada-modelo');
      const gradeSelect = document.getElementById('entrada-grade');
      const materialSelect = document.getElementById('entrada-material');
      const variacaoSelect = document.getElementById('entrada-variacao');
      const locationSelect = document.getElementById('entrada-location');

      if (preselectedLocation) {
        locationSelect.value = preselectedLocation;
        preselectedLocation = null;
      }
      
      const resetSelect = (el, ph='--') => { el.innerHTML = `<option value="">${ph}</option>`; el.disabled = true; };

      modeloSelect.addEventListener('change', () => {
        resetSelect(gradeSelect,'Selecione a grade'); resetSelect(materialSelect); resetSelect(variacaoSelect);
        const grades = [...new Set(productList.filter(p => p.modelo === modeloSelect.value).map(p => p.grade))];
        gradeSelect.innerHTML = `<option value="" disabled selected>Selecione a grade</option>` + grades.sort().map(g=>`<option value="${g}">${g}</option>`).join('');
        gradeSelect.disabled = false;
      });
      gradeSelect.addEventListener('change', () => {
        resetSelect(materialSelect,'Selecione o material'); resetSelect(variacaoSelect);
        const mats = [...new Set(productList.filter(p => p.modelo === modeloSelect.value && p.grade === gradeSelect.value).map(p => p.material))];
        materialSelect.innerHTML = `<option value="" disabled selected>Selecione o material</option>` + mats.sort().map(m=>`<option value="${m}">${m}</option>`).join('');
        materialSelect.disabled = false;
      });
      materialSelect.addEventListener('change', () => {
        resetSelect(variacaoSelect,'Selecione a variação');
        const vars = [...new Set(productList.filter(p => p.modelo === modeloSelect.value && p.grade === gradeSelect.value && p.material === materialSelect.value).map(p => p.variacao))];
        variacaoSelect.innerHTML = `<option value="" disabled selected>Selecione a variação</option>` + vars.sort().map(v=>`<option value="${v}">${v}</option>`).join('');
        variacaoSelect.disabled = false;
      });

      document.getElementById('entrada-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const modelo = modeloSelect.value;
        const grade = gradeSelect.value;
        const material = materialSelect.value;
        const variacao = variacaoSelect.value;
        const qty = parseInt(document.getElementById('entrada-quantidade').value);
        const location = locationSelect.value;

        const product = productList.find(p => p.modelo===modelo && p.grade===grade && p.material===material && p.variacao===variacao);
        if (!product || !qty || !location) return showToast('Preencha todos os campos.', 'error');

        await registerEntry(product, qty, location);
      });
    }

    function setupSaidaFormListeners() {
      document.getElementById('saida-scan-process-btn').addEventListener('click', () => startScanWorkflow('SAIDA'));
      const itemSelect = document.getElementById('saida-item');
      const qtdInput = document.getElementById('saida-quantidade');

      const setMax = () => {
        const idx = parseInt(itemSelect.value);
        if (Number.isNaN(idx)) { qtdInput.placeholder='Máx: 0'; qtdInput.max=0; return; }
        const it = inventory[idx]; if (it) { qtdInput.placeholder=`Máx: ${it.quantity}`; qtdInput.max=it.quantity; }
      };
      itemSelect.addEventListener('change', setMax); setMax();

      document.getElementById('saida-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await registerExit(parseInt(itemSelect.value), parseInt(qtdInput.value));
      });
    }

    const addHistory = (type, details) => {
        history.unshift({ date: new Date().toISOString(), type, details });
    };
    
       const handlePrintReport = () => {
        const tableHtml = document.getElementById('report-table')?.outerHTML;
        if (!tableHtml) return;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>Relatório de Estoque</title>
            <style>
                body { font-family: Inter, sans-serif; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                thead { background-color: #f2f2f2; }
            </style>
        </head><body>${tableHtml}</body></html>`);
        printWindow.document.close();
        printWindow.print();

    };

    const handleExportCSV = () => {
        const table = document.getElementById('report-table');
        if (!table) return;
        let csv = [];
        const rows = table.querySelectorAll('tr');
        for (const row of rows) {
            const cols = row.querySelectorAll('td, th');
            const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
            csv.push(rowData.join(','));
        }
        const csvFile = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(csvFile);
        link.download = `relatorio-estoque-${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
    };

    const handleUndoLastAction = () => {
      showCustomConfirm('Tem certeza que deseja desfazer a última ação? Esta operação não pode ser revertida.', async () => {
        if (history.length > 1) {
            history.shift();
            const saved = await persistInventory();
            if (!saved) return;
            showToast(`Última ação foi desfeita (no histórico).`);
            rerenderCurrentPage();
        }
      });
    };

   const handleResetStock = () => {
      if (!ensureAdminSession()) return;
      showCustomConfirm('ATENÇÃO! Apagar TODO o estoque é IRREVERSÍVEL.', () => {
        showCustomConfirm('CONFIRMAÇÃO FINAL: Apagar todo o estoque e histórico?', async () => {
          inventory = [];
          addHistory('RESET', 'O estoque foi completamente zerado.');
          const saved = await persistInventory();
          if (!saved) return;
          showToast('Estoque resetado com sucesso.', 'error');
          rerenderCurrentPage();
        });
      });
    };


    const showModal = (content, maxWidth = 'max-w-md') => {
      const mc = document.getElementById('modal-container');
      mc.innerHTML = `<div class="modal-backdrop fixed inset-0 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full ${maxWidth} max-h-full overflow-y-auto relative" id="modal-content">${content}</div>
      </div>`;
      mc.classList.remove('hidden');
      mc.querySelector('.modal-backdrop').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    };

    const closeModal = async () => {
        await stopActiveScanner();
        const mc = document.getElementById('modal-container');
        mc.classList.add('hidden');
        mc.innerHTML = '';
    };

    const showMapCellModal = (locationId, items) => {
        const hasItems = items && items.length > 0;

        const itemsHtml = hasItems ? `
            <ul class="divide-y divide-gray-200 -mx-6 px-6 mb-4 max-h-60 overflow-y-auto">
                ${items.map((item) => {
                    const product = productList.find(p => p.id === item.productId);
                    const inventoryIndex = inventory.findIndex(invItem => invItem.locationId === locationId && invItem.productId === item.productId);
                    return `<li class="py-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${product?.nomeCompleto || 'Produto desconhecido'}</p>
                                <p class="text-sm text-gray-600"><strong>Quantidade:</strong> ${item.quantity} caixas</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-inventory-index="${inventoryIndex}" class="exit-item-btn bg-red-100 text-red-800 hover:bg-red-200 px-3 py-1 rounded-md text-sm font-semibold">Saída</button>
                                <button data-inventory-index="${inventoryIndex}" class="move-item-btn bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md text-sm font-semibold">Mover</button>
                            </div>
                        </div>
                    </li>`;
                }).join('')}
            </ul>` : '<p class="text-gray-600 mb-4">Esta posição está livre.</p>';

        const content = `
            <div class="p-6">
                <div class="flex justify-between items-start">
                     <h2 class="text-2xl font-bold mb-4">Posição: ${locationId}</h2>
                     <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 -mt-2 -mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                     </button>
                </div>
                ${itemsHtml}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 border-t pt-4 -mx-6 px-6">
                    <button id="map-add-here" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Adicionar aqui</button>
                    <button id="map-scan-here" class="w-full bg-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-800">Ler e Adicionar</button>
                </div>
            </div>`;
        
        showModal(content);

        document.querySelectorAll('.move-item-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const inventoryIndex = parseInt(btn.dataset.inventoryIndex);
                if(inventoryIndex < 0 || inventoryIndex >= inventory.length) return;
                const itemToMove = inventory[inventoryIndex];
                enterMoveMode(itemToMove);
            });
        });

        document.querySelectorAll('.exit-item-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const inventoryIndex = parseInt(btn.dataset.inventoryIndex);
                showExitFromMapModal(inventoryIndex);
            });
        });

        document.getElementById('map-add-here')?.addEventListener('click', () => {
            preselectedLocation = locationId;
            closeModal();
            goTo('#entrada');
        });
        
        document.getElementById('map-scan-here')?.addEventListener('click', async () => {
            await closeModal();
            startScanWorkflow('ENTRADA', { location: locationId.split('-')[0] });
        });
    };

    function enterMoveMode(itemToMove) {
        moveOperation = { itemToMove };
        closeModal();
        document.body.classList.add('move-mode-active');
        document.getElementById(`map-cell-${itemToMove.locationId}`).classList.add('move-source');
        showToast('Modo de Movimentação: Selecione o destino.', 'info');
    }

    function handleMoveSelection(destinationLocationId) {
        if (!moveOperation) return;
        const { itemToMove } = moveOperation;

        if (destinationLocationId === itemToMove.locationId) {
            showToast('Origem e destino não podem ser os mesmos.', 'error');
            return;
        }
        
        const product = productList.find(p => p.id === itemToMove.productId);

        const content = `
            <div class="p-6">
                <h3 class="text-xl font-bold mb-2">Confirmar Movimentação</h3>
                <p class="text-sm text-gray-500 mb-1">De: <strong>${itemToMove.locationId}</strong></p>
                <p class="text-sm text-gray-500 mb-4">Para: <strong>${destinationLocationId}</strong></p>
                <p class="mb-4">${product?.nomeCompleto || 'Produto desconhecido'}</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade a Mover</label>
                    <input type="number" id="move-quantity" value="${itemToMove.quantity}" min="1" max="${itemToMove.quantity}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button id="move-cancel" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button id="move-confirm" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Confirmar</button>
                </div>
            </div>`;
        showModal(content);

        document.getElementById('move-confirm').onclick = async () => {
            const quantityToMove = parseInt(document.getElementById('move-quantity').value);
            await executeMove(destinationLocationId, quantityToMove);
        };
        document.getElementById('move-cancel').onclick = () => {
            document.body.classList.remove('move-mode-active');
            moveOperation = null;
            closeModal();
            rerenderCurrentPage();
        };
    }
    
    async function executeMove(destinationLocationId, quantityToMove) {
        const { itemToMove } = moveOperation;
        const product = productList.find(p => p.id === itemToMove.productId);

        if (quantityToMove <= 0 || quantityToMove > itemToMove.quantity) {
            showToast('Quantidade inválida.', 'error'); return;
        }

        const sourceItemIndex = inventory.findIndex(i => i.locationId === itemToMove.locationId && i.productId === itemToMove.productId);
        if(sourceItemIndex === -1) {
            showToast('Erro: item de origem não encontrado.', 'error'); return;
        }

        if (inventory[sourceItemIndex].quantity === quantityToMove) {
            inventory.splice(sourceItemIndex, 1);
        } else {
            inventory[sourceItemIndex].quantity -= quantityToMove;
        }

        const destItemIndex = inventory.findIndex(i => i.locationId === destinationLocationId && i.productId === itemToMove.productId);
        if (destItemIndex > -1) {
            inventory[destItemIndex].quantity += quantityToMove;
        } else {
            inventory.push({ locationId: destinationLocationId, productId: itemToMove.productId, quantity: quantityToMove });
        }

        addHistory('MOVIMENTAÇÃO', `${quantityToMove} cx de ${product?.nomeCompleto || 'Produto desconhecido'} de ${itemToMove.locationId} → ${destinationLocationId}`);
        const saved = await persistInventory();
        if (!saved) return;

        showToast('Item movido com sucesso!');
        document.body.classList.remove('move-mode-active');
        moveOperation = null;
        closeModal();
        rerenderCurrentPage();
    }

    async function registerEntry(product, quantity, locationId) {
        if (!product || !quantity || !locationId) return;
        
        const existingItemIndex = inventory.findIndex(item => item.locationId === locationId && item.productId === product.id);

        if (existingItemIndex > -1) {
            inventory[existingItemIndex].quantity += quantity;
        } else {
            inventory.push({ locationId: locationId, productId: product.id, quantity: quantity });
        }

        addHistory('ENTRADA', `+${quantity} caixas de ${product.nomeCompleto} em ${locationId}`);
        const saved = await persistInventory();
        if (!saved) return;
        showToast('Entrada registrada com sucesso!');
        preselectedLocation = null;
        if(window.location.hash !== '#mapa') goTo('#mapa');
        else rerenderCurrentPage();
    }
    
    async function registerExit(inventoryIndex, quantityToRemove) {
        if (inventoryIndex === null || isNaN(inventoryIndex) || !inventory[inventoryIndex] || isNaN(quantityToRemove) || quantityToRemove <= 0) {
            showToast('Dados de saída inválidos.', 'error');
            return;
        }

        const item = inventory[inventoryIndex];
        const product = productList.find(p => p.id === item.productId);

        if (quantityToRemove > item.quantity) {
            showToast('A quantidade de saída não pode ser maior que a em estoque.', 'error');
            return;
        }

        if (quantityToRemove === item.quantity) {
            inventory.splice(inventoryIndex, 1);
        } else {
            item.quantity -= quantityToRemove;
        }
        
        addHistory('SAÍDA', `-${quantityToRemove} caixas de ${product?.nomeCompleto || 'Produto desconhecido'} de ${item.locationId}`);
        const saved = await persistInventory();
        if (!saved) return;
        showToast('Saída registrada com sucesso!');
        goTo('#mapa');
    }

    function startScanWorkflow(operation, initialState = {}) {
        let state = {
            operation,
            product: initialState.product || null,
            location: initialState.location || null,
        };

        const processScan = (decodedText) => {
            const payload = parseScannedPayload(decodedText);
            
            if (payload.type === 'product' && !state.product) {
                const product = productList.find(p => p.id === payload.productId);
                if (product) {
                    state.product = product;
                } else {
                    showToast('Produto não encontrado.', 'error');
                }
            } else if (payload.type === 'location' && !state.location) {
                state.location = payload.location;
            } else {
                showToast('Código inválido ou já escaneado.', 'error');
            }
            runStateMachine();
        };

        const runStateMachine = () => {
            closeModal().then(() => {
                if (state.product && state.location) {
                    showFinalModal();
                } else if (!state.product) {
                    showGenericScanner('Leia o código do PRODUTO', processScan);
                } else { // Implies !state.location
                    showGenericScanner('Leia o código da POSIÇÃO (A, B...)', processScan);
                }
            });
        };

        const showFinalModal = () => {
            if (state.operation === 'ENTRADA') {
                showEntryFinalModal(state.product, state.location);
            } else if (state.operation === 'SAIDA') {
                showExitFinalModal(state.product, state.location);
            }
        };

        runStateMachine();
    }
    
    function showEntryFinalModal(product, baseLocation) {
        const content = `
            <form id="scan-final-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Confirmar Entrada</h3>
                <div class="bg-gray-100 p-3 rounded-md">
                    <p class="font-semibold">${product.nomeCompleto}</p>
                    <p class="text-sm text-gray-600">Em Posição: ${baseLocation}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Posição Detalhada</label>
                    <div id="scan-final-position-buttons" class="mt-2 grid grid-cols-3 gap-2">
                        ${mapLayout.positions.map((p, index) => `
                            <button type="button" data-position="${p}" class="position-selector-btn p-3 rounded-md border-2 font-semibold transition-colors ${index === 0 ? 'border-blue-500 bg-blue-100 text-blue-800' : 'border-gray-200 bg-gray-50 text-gray-600 hover:bg-gray-100'}">${p}</button>
                        `).join('')}
                    </div>
                    <input type="hidden" id="scan-final-position" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="scan-final-quantity" value="1" min="1" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700">Confirmar</button>
                </div>
            </form>
        `;
        showModal(content);
        
        const positionButtons = document.querySelectorAll('.position-selector-btn');
        const hiddenPositionInput = document.getElementById('scan-final-position');

        hiddenPositionInput.value = positionButtons[0].dataset.position;

        positionButtons.forEach(button => {
            button.addEventListener('click', () => {
                hiddenPositionInput.value = button.dataset.position;
                positionButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-100', 'text-blue-800');
                    btn.classList.add('border-gray-200', 'bg-gray-50', 'text-gray-600', 'hover:bg-gray-100');
                });
                button.classList.add('border-blue-500', 'bg-blue-100', 'text-blue-800');
                button.classList.remove('border-gray-200', 'bg-gray-50', 'text-gray-600', 'hover:bg-gray-100');
            });
        });

        document.getElementById('scan-final-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const position = document.getElementById('scan-final-position').value;
            const quantity = parseInt(document.getElementById('scan-final-quantity').value);
            const finalLocationId = `${baseLocation}-${position}`;
            
            await registerEntry(product, quantity, finalLocationId);
            closeModal();
        });
    }

    function showExitFinalModal(product, baseLocation) {
        const itemsInBaseLocation = inventory
            .map((item, index) => ({...item, index}))
            .filter(item => item.locationId.startsWith(`${baseLocation}-`) && item.productId === product.id);
        
        if(itemsInBaseLocation.length === 0) {
            showToast(`Produto ${product.nomeCompleto} não encontrado na posição ${baseLocation}.`, 'error');
            closeModal();
            return;
        }

        const content = `
            <form id="scan-final-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Confirmar Saída</h3>
                <div class="bg-gray-100 p-3 rounded-md">
                    <p class="font-semibold">${product.nomeCompleto}</p>
                    <p class="text-sm text-gray-600">Da Posição: ${baseLocation}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Lote Específico</label>
                    <select id="scan-final-item" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        ${itemsInBaseLocation.map(item => `<option value="${item.index}">(${item.locationId}) - ${item.quantity} caixas</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade a Retirar</label>
                    <input type="number" id="scan-final-quantity" value="1" min="1" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirmar Saída</button>
                </div>
            </form>
        `;
        showModal(content);

        const itemSelect = document.getElementById('scan-final-item');
        const quantityInput = document.getElementById('scan-final-quantity');
        const updateMax = () => {
            const selectedItem = inventory[itemSelect.value];
            if(selectedItem) quantityInput.max = selectedItem.quantity;
        };
        itemSelect.addEventListener('change', updateMax);
        updateMax();

        document.getElementById('scan-final-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inventoryIndex = parseInt(itemSelect.value);
            const quantity = parseInt(quantityInput.value);
            
            await registerExit(inventoryIndex, quantity);
            closeModal();
        });
    }

    function showExitFromMapModal(inventoryIndex) {
        const item = inventory[inventoryIndex];
        if(!item) return;
        const product = productList.find(p => p.id === item.productId);

        const content = `
            <form id="map-exit-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Registrar Saída Rápida</h3>
                 <div class="bg-gray-100 p-3 rounded-md">
                    <p class="font-semibold">${product?.nomeCompleto || 'Produto desconhecido'}</p>
                    <p class="text-sm text-gray-600">De: ${item.locationId}</p>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade a Retirar</label>
                    <input type="number" id="map-exit-quantity" value="1" min="1" max="${item.quantity}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirmar Saída</button>
                </div>
            </form>
        `;
        showModal(content);
        document.getElementById('map-exit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const quantity = parseInt(document.getElementById('map-exit-quantity').value);
            await registerExit(inventoryIndex, quantity);
            closeModal();
        });
    }

    function showBulkAddProductsModal() {
        const buildNomeCompleto = (row) => {
            return ['modelo', 'grade', 'material', 'variacao']
                .map(field => row[field].trim())
                .filter(Boolean)
                .join(' ');
        };

        const buildComboKey = (row) => {
            const values = ['modelo', 'grade', 'material', 'variacao'].map(field => (row[field] || '').trim().toLowerCase());
            if (values.some(v => !v)) return null;
            return values.join('|');
        };

        const existingProductsMap = new Map();
        productList.forEach(product => {
            const key = buildComboKey(product);
            if (key) existingProductsMap.set(key, product);
        });

        const createEmptyRow = (base = {}) => {
            const row = {
                modelo: base.modelo || '',
                grade: base.grade || '',
                material: base.material || '',
                variacao: base.variacao || '',
                nomeCompleto: base.nomeCompleto || ''
            };
            row.nomeCompleto = buildNomeCompleto(row);
            return row;
        };

        let bulkRows = [createEmptyRow()];
        let currentErrors = [];
        let duplicateConflicts = [];
        let previewRows = null;

        const validateRows = () => {
            const errors = [];
            const combos = new Map();
            bulkRows.forEach((row, index) => {
                const missingFields = ['modelo', 'grade', 'material', 'variacao'].filter(field => !row[field].trim());
                if (missingFields.length) {
                    errors.push({ index, message: 'Preencha todos os campos.' });
                }
                const key = buildComboKey(row);
                if (key && !missingFields.length) {
                    if (combos.has(key)) {
                        const firstIndex = combos.get(key);
                        errors.push({ index, message: `Combinação repetida com a linha ${firstIndex + 1}.` });
                        errors.push({ index: firstIndex, message: `Combinação repetida com a linha ${index + 1}.` });
                    } else {
                        combos.set(key, index);
                    }
                }
            });
            return errors;
        };

        const detectExistingConflicts = () => {
            const conflicts = [];
            bulkRows.forEach((row, index) => {
                const key = buildComboKey(row);
                if (!key) return;
                const existing = existingProductsMap.get(key);
                if (existing) {
                    conflicts.push({ index, message: `Combinação já cadastrada (#${existing.id}).`, product: existing });
                }
            });
            return conflicts;
        };

        const renderPreviewPanel = () => {
            const previewContainer = document.getElementById('bulk-preview');
            const duplicatesContainer = document.getElementById('bulk-duplicate-info');
            if (duplicatesContainer) {
                duplicatesContainer.textContent = duplicateConflicts.length
                    ? `⚠️ ${duplicateConflicts.length} combinação(ões) já existe(m) no cadastro. Revise antes de prosseguir.`
                    : '';
            }
            if (!previewContainer) return;
            if (!previewRows || !previewRows.length) {
                previewContainer.innerHTML = '<p class="text-sm text-gray-500">Clique em "Pré-visualizar" para ver o resumo das combinações geradas.</p>';
                return;
            }
            const conflictCount = previewRows.filter(item => item.conflictProduct).length;
            const listItems = previewRows.map((item, idx) => `
                <li class="p-2 rounded border ${item.conflictProduct ? 'border-red-200 bg-red-50 text-red-700' : 'border-green-200 bg-green-50 text-green-700'}">
                    <div class="flex justify-between items-center gap-4">
                        <span class="font-semibold text-sm">${idx + 1}. ${item.nomeCompleto}</span>
                        ${item.conflictProduct ? `<span class="text-xs font-semibold">Já cadastrado (#${item.conflictProduct.id})</span>` : '<span class="text-xs font-semibold">Novo</span>'}
                    </div>
                    <p class="text-xs mt-1 text-gray-600">${item.modelo} • ${item.grade} • ${item.material} • ${item.variacao}</p>
                </li>
            `).join('');
            previewContainer.innerHTML = `
                <p class="text-xs text-gray-500 mb-2">Total: ${previewRows.length} combinação(ões)${conflictCount ? ` • ${conflictCount} em conflito` : ''}</p>
                <ul class="space-y-2 max-h-48 overflow-y-auto pr-1">${listItems}</ul>
            `;
        };

        const renderBulkRows = () => {
            const tbody = document.getElementById('bulk-rows-body');

            const activeElement = document.activeElement;
            const isBulkInput = activeElement && activeElement.classList && activeElement.classList.contains('bulk-input');
            const focusedInputMeta = isBulkInput ? {
                index: activeElement.dataset.index,
                field: activeElement.dataset.field,
                selectionStart: activeElement.selectionStart,
                selectionEnd: activeElement.selectionEnd
            } : null;

            currentErrors = validateRows();
            duplicateConflicts = detectExistingConflicts();
            const rowsHtml = bulkRows.map((row, index) => {
                const rowErrors = [...new Set([
                    ...currentErrors.filter(err => err.index === index).map(err => err.message),
                    ...duplicateConflicts.filter(conf => conf.index === index).map(conf => conf.message)
                ])];
                return `
                    <tr class="align-top">
                        ${['modelo','grade','material','variacao'].map(field => `
                            <td class="p-2 border">
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <input type="text" class="bulk-input w-full p-2 border border-gray-300 rounded-md" data-index="${index}" data-field="${field}" value="${row[field] || ''}" />
                                        <button type="button" class="copy-below-btn text-xs text-blue-600" data-index="${index}" data-field="${field}">copiar abaixo</button>
                                    </div>
                                </div>
                            </td>
                        `).join('')}
                        <td class="p-2 border text-sm">
                            <p class="font-semibold">${row.nomeCompleto || '<span class="text-gray-500">Aguardando campos...</span>'}</p>
                            ${rowErrors.length ? `<p class="text-xs text-red-600 mt-1">${rowErrors.join(' | ')}</p>` : ''}
                        </td>
                        <td class="p-2 border w-32">
                            <div class="flex flex-col gap-2">
                                <button type="button" class="duplicate-row-btn px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs" data-index="${index}">Duplicar linha</button>
                                <button type="button" class="remove-row-btn px-2 py-1 rounded bg-red-100 text-red-700 text-xs ${bulkRows.length === 1 ? 'opacity-50 cursor-not-allowed' : ''}" data-index="${index}" ${bulkRows.length === 1 ? 'disabled' : ''}>Remover</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = rowsHtml;

            if (focusedInputMeta) {
                const selector = `.bulk-input[data-index="${focusedInputMeta.index}"][data-field="${focusedInputMeta.field}"]`;
                const replacementInput = tbody.querySelector(selector);
                if (replacementInput) {
                    replacementInput.focus();
                    if (typeof focusedInputMeta.selectionStart === 'number' && typeof focusedInputMeta.selectionEnd === 'number') {
                        replacementInput.setSelectionRange(focusedInputMeta.selectionStart, focusedInputMeta.selectionEnd);
                    }
                }
            }

            document.querySelectorAll('#bulk-rows-body .bulk-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    const field = e.target.dataset.field;
                    bulkRows[index][field] = e.target.value;
                    bulkRows[index].nomeCompleto = buildNomeCompleto(bulkRows[index]);
                    previewRows = null;
                    renderBulkRows();
                });
            });

            document.querySelectorAll('#bulk-rows-body .remove-row-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index, 10);
                    if (bulkRows.length === 1) return;
                    bulkRows.splice(index, 1);
                    previewRows = null;
                    renderBulkRows();
                });
            });

            document.querySelectorAll('#bulk-rows-body .duplicate-row-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index, 10);
                    const clone = createEmptyRow(bulkRows[index]);
                    clone.nomeCompleto = buildNomeCompleto(clone);
                    bulkRows.splice(index + 1, 0, clone);
                    previewRows = null;
                    renderBulkRows();
                });
            });

            document.querySelectorAll('#bulk-rows-body .copy-below-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index, 10);
                    const field = btn.dataset.field;
                    const value = bulkRows[index][field];
                    for (let i = index + 1; i < bulkRows.length; i++) {
                        bulkRows[i][field] = value;
                        bulkRows[i].nomeCompleto = buildNomeCompleto(bulkRows[i]);
                    }
                    previewRows = null;
                    renderBulkRows();
                });
            });

            const validationContainer = document.getElementById('bulk-validation');
            if (validationContainer) {
                const hasErrors = currentErrors.length > 0;
                validationContainer.textContent = hasErrors ? 'Resolva os campos destacados antes de continuar.' : '';
            }

            const saveBtn = document.getElementById('save-bulk-products');
            if (saveBtn) {
                const hasEmptyRows = bulkRows.some(row => !row.modelo.trim() || !row.grade.trim() || !row.material.trim() || !row.variacao.trim());
                saveBtn.disabled = currentErrors.length > 0 || duplicateConflicts.length > 0 || hasEmptyRows;
            }

            renderPreviewPanel();
        };

        const content = `
            <div class="p-6 space-y-4">
                <h3 class="text-xl font-bold">Cadastro em Massa</h3>
                <p class="text-sm text-gray-600">Preencha os dados das combinações desejadas e utilize os atalhos para acelerar o preenchimento.</p>
                <form id="bulk-add-form" class="space-y-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2 border text-left">Modelo</th>
                                    <th class="p-2 border text-left">Grade</th>
                                    <th class="p-2 border text-left">Material</th>
                                    <th class="p-2 border text-left">Variação/Cor</th>
                                    <th class="p-2 border text-left">Resumo</th>
                                    <th class="p-2 border text-left">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="bulk-rows-body"></tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center">
                        <button type="button" id="add-bulk-row" class="px-3 py-2 rounded-md bg-green-100 text-green-700 text-sm">Adicionar linha</button>
                        <p class="text-xs text-gray-500">Dica: use "copiar abaixo" para repetir valores de uma coluna rapidamente.</p>
                    </div>
                    <div class="space-y-1">
                        <div id="bulk-validation" class="text-sm text-red-600"></div>
                        <div id="bulk-duplicate-info" class="text-sm text-amber-600"></div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4 space-y-3 bg-gray-50">
                        <div class="flex items-center justify-between gap-3 flex-wrap">
                            <div>
                                <p class="text-sm font-semibold text-gray-700">Pré-visualização</p>
                                <p class="text-xs text-gray-500">Valide as combinações e confira os conflitos antes de cadastrar.</p>
                            </div>
                            <button type="button" id="preview-bulk-products" class="px-3 py-1.5 rounded-md bg-indigo-100 text-indigo-700 text-sm font-medium">Pré-visualizar</button>
                        </div>
                        <div id="bulk-preview" class="text-sm text-gray-700"></div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300" id="cancel-bulk-btn">Cancelar</button>
                        <button type="submit" id="save-bulk-products" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50">Cadastrar produtos</button>
                    </div>
                </form>
            </div>
        `;

        showModal(content, 'max-w-5xl');

        document.getElementById('add-bulk-row').addEventListener('click', () => {
            bulkRows.push(createEmptyRow());
            previewRows = null;
            renderBulkRows();
        });

        document.getElementById('cancel-bulk-btn').addEventListener('click', () => closeModal());

        document.getElementById('preview-bulk-products').addEventListener('click', () => {
            currentErrors = validateRows();
            if (currentErrors.length) {
                renderBulkRows();
                showToast('Corrija os erros antes de pré-visualizar.', 'error');
                return;
            }
            previewRows = bulkRows.map((row, index) => {
                const trimmedRow = {
                    modelo: row.modelo.trim(),
                    grade: row.grade.trim(),
                    material: row.material.trim(),
                    variacao: row.variacao.trim()
                };
                const key = buildComboKey(trimmedRow);
                const conflictProduct = key ? existingProductsMap.get(key) : null;
                return {
                    ...trimmedRow,
                    nomeCompleto: buildNomeCompleto(trimmedRow),
                    conflictProduct,
                    index
                };
            });
            renderPreviewPanel();
        });

        document.getElementById('bulk-add-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            currentErrors = validateRows();
            if (currentErrors.length) {
                renderBulkRows();
                showToast('Corrija os erros antes de salvar.', 'error');
                return;
            }

            duplicateConflicts = detectExistingConflicts();
            if (duplicateConflicts.length) {
                renderBulkRows();
                showToast('Resolva as duplicidades antes de cadastrar.', 'error');
                return;
            }

            const newProducts = bulkRows.map(row => {
                const trimmedRow = {
                    modelo: row.modelo.trim(),
                    grade: row.grade.trim(),
                    material: row.material.trim(),
                    variacao: row.variacao.trim()
                };
                return { ...trimmedRow, nomeCompleto: buildNomeCompleto(trimmedRow) };
            });

            let nextId = productList.length ? Math.max(...productList.map(p => p.id)) + 1 : 1;
            const productsWithId = newProducts.map(product => ({ id: nextId++, ...product }));

            productList.push(...productsWithId);
            const saved = await persistProducts();
            if (!saved) return;
            showToast(`${productsWithId.length} produto(s) cadastrados com sucesso!`);
            closeModal();
            rerenderCurrentPage();
        });

        renderBulkRows();
    }

    function showAddProductModal() {
        const content = `
            <form id="add-product-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Cadastrar Novo Produto</h3>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Modelo</label>
                    <input type="text" id="new-prod-modelo" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Grade</label>
                    <input type="text" id="new-prod-grade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Material</label>
                    <input type="text" id="new-prod-material" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Variação / Cor</label>
                    <input type="text" id="new-prod-variacao" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="add-prod-cancel" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Salvar Produto</button>
                </div>
            </form>
        `;
        showModal(content);
        document.getElementById('add-prod-cancel').onclick = closeModal;
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProduct = {
                id: productList.length ? Math.max(...productList.map(p => p.id)) + 1 : 1,
                modelo: document.getElementById('new-prod-modelo').value.trim(),
                grade: document.getElementById('new-prod-grade').value.trim(),
                material: document.getElementById('new-prod-material').value.trim(),
                variacao: document.getElementById('new-prod-variacao').value.trim(),
            };
            
            if(!newProduct.modelo || !newProduct.grade || !newProduct.material || !newProduct.variacao) {
                showToast('Todos os campos são obrigatórios.', 'error');
                return;
            }

            productList.push({ ...newProduct, nomeCompleto: `${newProduct.modelo} ${newProduct.grade} ${newProduct.material} ${newProduct.variacao}` });
            const saved = await persistProducts();
            if (!saved) return;
            showToast('Produto cadastrado com sucesso!');
            closeModal();
            rerenderCurrentPage();
        });
    }
    
    function showPrintProductsModal(products) {
        const labelsHtml = products.map(p => `
            <div class="p-2 border border-gray-300 rounded-lg flex flex-col items-center gap-2 break-inside-avoid">
                <div id="print-qr-${p.id}"></div>
                <p class="text-center text-xs font-semibold">${p.nomeCompleto} {productId:${p.id}}</p>
            </div>
        `).join('');

        const content = `
            <div class="p-6" id="printable-area-container">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Etiquetas de Produto</h3>
                    <div>
                         <button id="download-labels-btn" class="px-3 py-1 rounded-md bg-green-600 text-white hover:bg-green-700 text-sm mr-2">Baixar</button>
                         <button id="print-labels-btn" class="px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700 text-sm">Imprimir</button>
                    </div>
                </div>
                <div id="printable-area" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${labelsHtml}
                </div>
            </div>
        `;
        showModal(content, 'max-w-4xl');

        products.forEach(p => {
            new QRCode(document.getElementById(`print-qr-${p.id}`), {
                text: JSON.stringify({ productId: p.id }),
                width: 128,
                height: 128,
            });
        });

        document.getElementById('print-labels-btn').onclick = () => window.print();
        document.getElementById('download-labels-btn').onclick = async () => {
            for(const p of products) {
                const qrEl = document.getElementById(`print-qr-${p.id}`);
                const canvas = qrEl.querySelector('canvas');
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `produto-${p.id}-${p.modelo}-${p.variacao}.png`;
                link.href = dataUrl;
                link.click();
                await new Promise(r => setTimeout(r, 100));
            }
        };
    }

    const showAdminLoginModal = async () => {
      await closeModal();
      toggleAuthShell(false);
      window.location.hash = '#login';
      setTimeout(() => loginPassword?.focus(), 100);
    };

    const showCustomConfirm = (msg, onConfirm) => {
        const content = `
        <div class="p-6">
          <h3 class="text-lg font-bold mb-4">Confirmação Necessária</h3>
          <p class="text-gray-700 mb-6">${msg}</p>
          <div class="flex justify-end gap-3">
            <button id="confirm-cancel" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
            <button id="confirm-ok" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirmar</button>
          </div>
        </div>`;
      showModal(content);
      document.getElementById('confirm-ok').onclick = () => { closeModal(); onConfirm(); };
      document.getElementById('confirm-cancel').onclick = closeModal;
    };

    const handleUnauthorized = () => {
      const hadToken = Boolean(adminToken);
      persistAdminToken(null);
      toggleAuthShell(false);
      if (hadToken) {
        showToast('Sessão expirada. Faça login novamente.', 'error');
      }
      window.location.hash = '#login';
      navigate();
    };

    const showToast = (message, type='success') => {
      const toast = document.createElement('div');
      let bgColor = 'bg-green-500';
      if (type === 'error') bgColor = 'bg-red-500';
      if (type === 'info') bgColor = 'bg-blue-500';
      
      toast.className = `fixed bottom-24 md:bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg ${bgColor} z-50`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    };

    // --- NAVEGAÇÃO E INICIALIZAÇÃO ---
    const goTo = (hash) => {
        if (window.location.hash === hash) {
            rerenderCurrentPage();
        } else {
            window.location.hash = hash;
        }
    };

    const navigate = () => {
      const hash = window.location.hash || '#home';
      toggleAuthShell(adminAuthenticated);
      if (!adminAuthenticated) {
        if (hash !== '#login') {
          window.location.hash = '#login';
        }
        return;
      }

      if (hash === '#login') {
        window.location.hash = lastVisitedHash || '#home';
        return;
      }

      if (hash !== '#admin' && hash !== '#produtos' && hash !== '#etiquetas') {
          lastVisitedHash = hash;
      }

      let pageId = `page-${hash.substring(1)}`;
      if (hash.startsWith('#separacao')) {
        pageId = 'page-separacao';
      }

      pages.forEach(p => p.classList.toggle('hidden', p.id !== pageId));
      menuItems.forEach(i => {
        const href = i.getAttribute('href');
        const isSeparationLink = href?.startsWith('#separacao');
        const isActive = href === hash || (isSeparationLink && hash.startsWith('#separacao'));
        i.classList.toggle('active', isActive);
      });
      rerenderCurrentPage();
    };
    
    const rerenderCurrentPage = () => {
      const hash = window.location.hash || '#home';
      let title = 'Dashboard';
      switch (hash) {
        case '#home': renderDashboard(); break;
        case '#entrada': title='Entrada'; renderEntrada(); break;
        case '#saida': title='Saída'; renderSaida(); break;
        case '#separacao':
        case '#separacao-listas':
        case '#separacao-otimizacao':
          title='Separação'; renderSeparation(); break;
        case '#mapa': title='Mapa'; renderMap(); break;
        case '#produtos': title='Produtos'; renderProdutos(); break;
        case '#relatorios': title='Relatórios'; renderReports(); break;
        case '#etiquetas': title='Etiquetas de Posição'; renderEtiquetas(); break;
        case '#historico': title='Histórico'; renderHistory(); break;
        case '#admin': title='Admin'; renderAdmin(); break;
      }
      if (headerTitle) headerTitle.textContent = title;
    };

    window.addEventListener('hashchange', navigate);
    window.closeModal = closeModal;

    (async () => {
        toggleAuthShell(adminAuthenticated);
        if (adminAuthenticated) {
          await loadAllDataFromServer();
        } else {
          window.location.hash = '#login';
        }
        navigate();
        setInterval(loadAllDataFromServer, 5000);
    })();

  });
  </script>
</body>
</html>

