Of course. Here is the completed and fully functional HTML file. I have implemented all the application logic within the `<script>` tag as requested, including navigation, page rendering for each section (Dashboard, Entry, Exit, Stock Map, Reports, History, and Admin), QR code scanning functionality, modal pop-ups, and data persistence simulation.

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Estoque - Indústria de Calçados</title>
  <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.10/dist/html5-qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .menu-item.active { background-color: #1d4ed8; color: white; }
    .modal-backdrop { background-color: rgba(0,0,0,0.5); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    select:disabled, input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .map-card-position { transition: all 0.2s ease-in-out; }
  </style>
</head>
<body class="antialiased text-gray-800">

  <div id="app" class="flex flex-col md:flex-row min-h-screen">
        <aside class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
      <div class="flex items-center justify-center h-16 border-b border-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
        <span class="ml-2 text-lg font-bold">Estoque Calçados</span>
      </div>
      <nav class="flex-1 px-2 py-4 space-y-2">
        <a href="#home" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard h-5 w-5 mr-3"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          Dashboard
        </a>
        <a href="#entrada" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-square h-5 w-5 mr-3 text-green-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          Entrada
        </a>
        <a href="#saida" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-square h-5 w-5 mr-3 text-red-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          Saída
        </a>
        <a href="#mapa" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map h-5 w-5 mr-3"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          Mapa do Estoque
        </a>
        <a href="#relatorios" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text h-5 w-5 mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          Relatórios
        </a>
        <a href="#historico" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history h-5 w-5 mr-3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
          Histórico
        </a>
        <a href="#admin" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check h-5 w-5 mr-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </nav>
    </aside>

        <div class="flex-1 flex flex-col">
            <header class="md:hidden flex items-center justify-between bg-gray-800 text-white p-4 shadow-md sticky top-0 z-10">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
          <span id="header-title" class="ml-2 text-lg font-bold">Dashboard</span>
        </div>
                <a href="#admin" class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-white text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </header>

      <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="page-home" class="page"></div>
        <div id="page-entrada" class="page hidden"></div>
        <div id="page-saida" class="page hidden"></div>
        <div id="page-mapa" class="page hidden"></div>
        <div id="page-relatorios" class="page hidden"></div>
        <div id="page-historico" class="page hidden"></div>
        <div id="page-admin" class="page hidden"></div>
      </main>

            <nav class="md:hidden grid grid-cols-5 gap-1 p-2 bg-gray-800 text-white border-t border-gray-700 sticky bottom-0">
        <a href="#home" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard h-6 w-6 mb-1"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          <span class="text-xs">Dashboard</span>
        </a>
        <a href="#entrada" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-square h-6 w-6 mb-1 text-green-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          <span class="text-xs">Entrada</span>
        </a>
        <a href="#saida" class="menu-item flex col flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-square h-6 w-6 mb-1 text-red-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          <span class="text-xs">Saída</span>
        </a>
        <a href="#mapa" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map h-6 w-6 mb-1"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          <span class="text-xs">Mapa</span>
        </a>
        <a href="#relatorios" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text h-6 w-6 mb-1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          <span class="text-xs">Relatórios</span>
        </a>
      </nav>
    </div>
  </div>

    <div id="modal-container" class="hidden"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {

    // --- DADOS DO SISTEMA ---
    const productList = [
      { id: 1, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "BEGE" },
      { id: 2, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "BORDÔ" },
      { id: 3, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "CHUMBO" },
      { id: 4, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "CINZA" },
      { id: 5, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "OFF PRETO" },
      { id: 6, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "OFF VERDE" },
      { id: 7, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO" },
      { id: 8, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "VERDE" },
      { id: 9, modelo: "BAD BUNNY", grade: "ALTA", material: "CAMURÇA", variacao: "VERMELHO" },
      { id: 10, modelo: "BAD BUNNY", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 11, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "BEGE" },
      { id: 12, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "BORDÔ" },
      { id: 13, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "CHUMBO" },
      { id: 14, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "CINZA" },
      { id: 15, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "OFF PRETO" },
      { id: 16, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "OFF VERDE" },
      { id: 17, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO" },
      { id: 18, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "ROSA" },
      { id: 19, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "VERDE" },
      { id: 20, modelo: "BAD BUNNY", grade: "BAIXA", material: "CAMURÇA", variacao: "VERMELHO" },
      { id: 21, modelo: "BAD BUNNY", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 22, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "BEGE BRANCO" },
      { id: 23, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "BEGE CINZA" },
      { id: 24, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "BLACK" },
      { id: 25, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "CHUMBO" },
      { id: 26, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "CINZA" },
      { id: 27, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "CINZA CROMIO" },
      { id: 28, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "CINZA PRETO" },
      { id: 29, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "LARANJA" },
      { id: 30, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "MARROM BARATA" },
      { id: 31, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "MARROM CREME" },
      { id: 32, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO BRANCO" },
      { id: 33, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO CINZA" },
      { id: 34, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO COSTURA BRANCO" },
      { id: 35, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "VERDE MUSGO" },
      { id: 36, modelo: "BETA", grade: "ALTA", material: "CAMURÇA", variacao: "VERMELHO" },
      { id: 37, modelo: "BETA", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 38, modelo: "BETA", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 39, modelo: "BETA", grade: "ALTA", material: "SINTÉTICO", variacao: "PRETO BRANCO" },
      { id: 40, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "BEGE BRANCO" },
      { id: 41, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "BEGE CINZA" },
      { id: 42, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "BLACK" },
      { id: 43, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "CHUMBO" },
      { id: 44, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "CINZA" },
      { id: 45, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "CINZA CROMIO" },
      { id: 46, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "CINZA PRETO" },
      { id: 47, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "LARANJA" },
      { id: 48, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "MARROM BARATA" },
      { id: 49, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "MARROM CREME" },
      { id: 50, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO BRANCO" },
      { id: 51, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO CINZA" },
      { id: 52, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO COSTURA BRANCO" },
      { id: 53, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "VERDE MUSGO" },
      { id: 54, modelo: "BETA", grade: "BAIXA", material: "CAMURÇA", variacao: "VERMELHO" },
      { id: 55, modelo: "BETA", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 56, modelo: "BETA", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 57, modelo: "BETA", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO BRANCO" },
      { id: 58, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "AZUL" },
      { id: 59, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "BORDÔ" },
      { id: 60, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "BRANCO VERDE" },
      { id: 61, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "CHUMBO" },
      { id: 62, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "CINZA" },
      { id: 63, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "CINZA CROMIO" },
      { id: 64, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "MARROM" },
      { id: 65, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "MOSTARDA" },
      { id: 66, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "OFF PRETO" },
      { id: 67, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO" },
      { id: 68, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO PRETO" },
      { id: 69, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "VERDE BANDEIRA" },
      { id: 70, modelo: "CAMPUS", grade: "ALTA", material: "CAMURÇA", variacao: "VERMELHO" },
      { id: 71, modelo: "CAMPUS", grade: "ALTA", material: "NYLON", variacao: "GRAFITE" },
      { id: 72, modelo: "CAMPUS", grade: "ALTA", material: "NYLON", variacao: "PRETO BEGE" },
      { id: 73, modelo: "CAMPUS", grade: "ALTA", material: "NYLON", variacao: "PRETO PRETO" },
      { id: 74, modelo: "CAMPUS", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 75, modelo: "CAMPUS", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 76, modelo: "CAMPUS", grade: "ALTA", material: "SINTÉTICO", variacao: "PRETO" },
      { id: 77, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "AZUL" },
      { id: 78, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "BORDÔ" },
      { id: 79, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "BRANCO VERDE" },
      { id: 80, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "CHUMBO" },
      { id: 81, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "CINZA" },
      { id: 82, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "CINZA CROMIO" },
      { id: 83, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "GRAFITE" },
      { id: 84, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "LARANJA" },
      { id: 85, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "MARROM" },
      { id: 86, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "MOSTARDA" },
      { id: 87, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "OFF PRETO" },
      { id: 88, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO" },
      { id: 89, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO PRETO" },
      { id: 90, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "ROSA" },
      { id: 91, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "SALMÃO" },
      { id: 92, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "VERDE BANDEIRA" },
      { id: 93, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "VERDE ÁGUA" },
      { id: 94, modelo: "CAMPUS", grade: "BAIXA", material: "CAMURÇA", variacao: "VERMELHO" },
      { id: 95, modelo: "CAMPUS", grade: "BAIXA", material: "CETIM", variacao: "CAMURÇA OFF AZUL" },
      { id: 96, modelo: "CAMPUS", grade: "BAIXA", material: "CETIM", variacao: "CAMURÇA OFF ROSA" },
      { id: 97, modelo: "CAMPUS", grade: "BAIXA", material: "CETIM", variacao: "SINTÉTICO BRANCO AZUL" },
      { id: 98, modelo: "CAMPUS", grade: "BAIXA", material: "CETIM", variacao: "SINTÉTICO BRANCO ROSA" },
      { id: 99, modelo: "CAMPUS", grade: "BAIXA", material: "NYLON", variacao: "GRAFITE" },
      { id: 100, modelo: "CAMPUS", grade: "BAIXA", material: "NYLON", variacao: "PRETO BEGE" },
      { id: 101, modelo: "CAMPUS", grade: "BAIXA", material: "NYLON", variacao: "PRETO PRETO BEGE" },
      { id: 102, modelo: "CAMPUS", grade: "BAIXA", material: "SINTÉTICO", variacao: "BOBBIE GOODS" },
      { id: 103, modelo: "CAMPUS", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 104, modelo: "CAMPUS", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 105, modelo: "CAMPUS", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO" },
      { id: 106, modelo: "CAMPUS", grade: "INFANTIL", material: "BOBBIE GOODS", variacao: "BOBBIE GOODS" },
      { id: 107, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "AZUL" },
      { id: 108, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "BORDÔ" },
      { id: 109, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "BRANCO VERDE" },
      { id: 110, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "CHUMBO" },
      { id: 111, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "CINZA CROMIO" },
      { id: 112, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "CINZA" },
      { id: 113, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "OFF PRETO" },
      { id: 114, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "PRETO" },
      { id: 115, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "PRETO PRETO" },
      { id: 116, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "ROSA" },
      { id: 117, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "VERDE BANDEIRA" },
      { id: 118, modelo: "CAMPUS", grade: "INFANTIL", material: "CAMURÇA", variacao: "VERMELHO" },
      { id: 119, modelo: "CAMPUS", grade: "INFANTIL", material: "CETIM", variacao: "OFF AZUL" },
      { id: 120, modelo: "CAMPUS", grade: "INFANTIL", material: "CETIM", variacao: "OFF ROSA" },
      { id: 121, modelo: "CAMPUS", grade: "INFANTIL", material: "MESSI", variacao: "MESSI" },
      { id: 122, modelo: "CAMPUS", grade: "INFANTIL", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 123, modelo: "CAMPUS", grade: "INFANTIL", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 124, modelo: "CAMPUS", grade: "INFANTIL", material: "SINTÉTICO", variacao: "PRETO" },
      { id: 125, modelo: "FORUM", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 126, modelo: "FORUM", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 127, modelo: "FORUM", grade: "ALTA", material: "SINTÉTICO", variacao: "PRETO" },
      { id: 128, modelo: "FORUM", grade: "ALTA", material: "SINTÉTICO", variacao: "PRETO BRANCO" },
      { id: 129, modelo: "FORUM", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 130, modelo: "FORUM", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 131, modelo: "FORUM", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO" },
      { id: 132, modelo: "FORUM", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO BRANCO" },
      { id: 133, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "AZUL" },
      { id: 134, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO CINZA" },
      { id: 135, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 136, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "CHUMBO" },
      { id: 137, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "OFF MARROM" },
      { id: 138, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "ONÇA" },
      { id: 139, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO" },
      { id: 140, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO BRANCO" },
      { id: 141, modelo: "PALERMO", grade: "BAIXA", material: "SINTÉTICO", variacao: "ROSA" },
      { id: 142, modelo: "VANS", grade: "ALTA", material: "SINTÉTICO", variacao: "AZUL" },
      { id: 143, modelo: "VANS", grade: "ALTA", material: "SINTÉTICO", variacao: "BEGE" },
      { id: 144, modelo: "VANS", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 145, modelo: "VANS", grade: "ALTA", material: "SINTÉTICO", variacao: "CINZA BRANCO" },
      { id: 146, modelo: "VANS", grade: "ALTA", material: "SINTÉTICO", variacao: "PRETO BRANCO" },
      { id: 147, modelo: "VANS", grade: "ALTA", material: "SINTÉTICO", variacao: "PRETO CINZA" },
      { id: 148, modelo: "VANS", grade: "ALTA", material: "SINTÉTICO", variacao: "PRETO PRETO" },
      { id: 149, modelo: "VANS", grade: "BAIXA", material: "SINTÉTICO", variacao: "AZUL" },
      { id: 150, modelo: "VANS", grade: "BAIXA", material: "SINTÉTICO", variacao: "BEGE" },
      { id: 151, modelo: "VANS", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 152, modelo: "VANS", grade: "BAIXA", material: "SINTÉTICO", variacao: "CINZA BRANCO" },
      { id: 153, modelo: "VANS", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO BRANCO" },
      { id: 154, modelo: "VANS", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO CINZA" },
      { id: 155, modelo: "VANS", grade: "BAIXA", material: "SINTÉTICO", variacao: "PRETO PRETO" },
      { id: 156, modelo: "XL SUEDE", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO BRANCO" },
      { id: 157, modelo: "XL SUEDE", grade: "ALTA", material: "CAMURÇA", variacao: "PRETO PRETO" },
      { id: 158, modelo: "XL SUEDE", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 159, modelo: "XL SUEDE", grade: "ALTA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 160, modelo: "XL SUEDE", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO BRANCO" },
      { id: 161, modelo: "XL SUEDE", grade: "BAIXA", material: "CAMURÇA", variacao: "PRETO PRETO" },
      { id: 162, modelo: "XL SUEDE", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 163, modelo: "XL SUEDE", grade: "BAIXA", material: "SINTÉTICO", variacao: "BRANCO" },
      { id: 164, modelo: "XL SUEDE", grade: "INFANTIL", material: "CAMURÇA", variacao: "PRETO BRANCO" },
      { id: 165, modelo: "XL SUEDE", grade: "INFANTIL", material: "CAMURÇA", variacao: "PRETO PRETO" },
      { id: 166, modelo: "XL SUEDE", grade: "INFANTIL", material: "SINTÉTICO", variacao: "BRANCO PRETO" },
      { id: 167, modelo: "XL SUEDE", grade: "INFANTIL", material: "SINTÉTICO", variacao: "BRANCO" },
    ].map(p => ({ ...p, nomeCompleto: `${p.modelo} ${p.grade} ${p.material} ${p.variacao}` }));

    // Inventário e histórico (carregado via localStorage para persistência no navegador)
    let inventory = [];
    let history = [];

    function loadFromLocalStorage() {
      try {
        const savedInventory = localStorage.getItem('shoeInventory');
        const savedHistory = localStorage.getItem('shoeHistory');
        if (savedInventory) inventory = JSON.parse(savedInventory);
        if (savedHistory) history = JSON.parse(savedHistory);
      } catch (err) {
        console.error("Falha ao carregar do LocalStorage", err);
        inventory = [];
        history = [];
      }
    }

    function persist() {
      try {
        localStorage.setItem('shoeInventory', JSON.stringify(inventory));
        localStorage.setItem('shoeHistory', JSON.stringify(history));
      } catch (err) {
        console.error("Falha ao salvar no LocalStorage", err);
      }
    }

    const mapLayout = { locations: ['A','B','C','D','E','F','G','H','I','J','K','L'], positions: ['FUNDO','FRENTE'] };
    const adminPassword = '123';
    let adminAuthenticated = false;

    const pages = document.querySelectorAll('.page');
    const menuItems = document.querySelectorAll('.menu-item');
    const headerTitle = document.getElementById('header-title');
    const modalContainer = document.getElementById('modal-container');

    // --- FILTROS DO MAPA ---
    let mapFilters = { modelo: '', grade: '', variacao: '' };
    const clearMapFilters = () => { mapFilters = { modelo: '', grade: '', variacao: '' }; };
    const matchesMapFilter = (product) => {
      if (!product) return false;
      if (mapFilters.modelo && product.modelo !== mapFilters.modelo) return false;
      if (mapFilters.grade && product.grade !== mapFilters.grade) return false;
      if (mapFilters.variacao && product.variacao !== mapFilters.variacao) return false;
      return true;
    };

    // ======= SCANNER / QR (com bip + delay) =======
    let preselectedLocation = null;

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.value = 880;
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        osc.start();
        osc.stop(ctx.currentTime + 0.12);
      } catch (_) {}
    }

    function parseScannedPayload(text) {
      try {
        const j = JSON.parse(text);
        return {
          productId: j.productId ?? null,
          quantity: Number(j.quantity) || 0,
          modelo: j.modelo || null,
          grade: j.grade || null,
          material: j.material || null,
          variacao: j.variacao || null
        };
      } catch(_) {
        if (text.includes('|')) {
          const [pid, qty] = text.split('|');
          return { productId: Number(pid) || null, quantity: Number(qty) || 0 };
        }
        if (text.includes(';')) {
          const [modelo, grade, material, variacao, qty] = text.split(';').map(s=>s.trim());
          return { productId: null, quantity: Number(qty)||0, modelo, grade, material, variacao };
        }
        const n = Number(text.trim());
        if (!Number.isNaN(n)) return { productId: n, quantity: 0 };
        return { productId: null, quantity: 0 };
      }
    }

    function findProductFromScan(payload) {
      if (payload.productId) {
        return productList.find(p => p.id === payload.productId) || null;
      }
      if (payload.modelo && payload.grade && payload.material && payload.variacao) {
        return productList.find(p =>
          p.modelo === payload.modelo &&
          p.grade === payload.grade &&
          p.material === payload.material &&
          p.variacao === payload.variacao
        ) || null;
      }
      return null;
    }

    function showScanModal(onSuccess) {
      const content = `
        <div class="p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">Ler código</h3>
            <button class="text-gray-400 hover:text-gray-600" id="scan-close">✕</button>
          </div>
          <div id="reader" style="width:100%"></div>
          <div id="scan-feedback" class="hidden mt-3 px-3 py-2 rounded-md bg-green-100 text-green-800 text-sm font-medium">Código lido! Processando...</div>
          <p class="text-xs text-gray-500 mt-3">Se solicitado, permita o acesso à câmera. Suporta QR (e códigos gerados pelo sistema).</p>
        </div>`;
      showModal(content);

      const reader = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      let handled = false;
      function cleanup() {
        reader.stop().catch(()=>{}).finally(()=>reader.clear().catch(()=>{}));
        closeModal();
      }
      document.getElementById('scan-close').onclick = cleanup;

      reader.start(
        { facingMode: "environment" },
        config,
        decodedText => {
          if (handled) return;
          handled = true;
          document.getElementById('scan-feedback')?.classList.remove('hidden');
          beep();

          setTimeout(() => {
            const payload = parseScannedPayload(decodedText);
            const product = findProductFromScan(payload);
            if (onSuccess) {
                onSuccess(product, payload.quantity);
            }
            cleanup();
          }, 1500); // 1.5s delay
        },
        errorMessage => { /* ignore */ }
      ).catch(err => {
        document.getElementById('reader').innerHTML = `<p class="text-red-600 text-center">Erro ao iniciar a câmera: ${err}</p>`;
      });
    }

    // ======= SISTEMA DE MODAL =======
    function showModal(content, size = 'md') {
      const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl' };
      modalContainer.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
          <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full ${sizeClasses[size] || sizeClasses['md']}">
            ${content}
          </div>
        </div>`;
      modalContainer.classList.remove('hidden');
      const backdrop = modalContainer.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) closeModal();
        });
      }
    }

    function closeModal() {
      modalContainer.classList.add('hidden');
      modalContainer.innerHTML = '';
    }

    // ======= HELPERS =======
    const getProductById = (id) => productList.find(p => p.id === id);
    const generateLocationId = (loc, pos) => `${loc}-${pos}`;
    const parseLocationId = (id) => ({ location: id.split('-')[0], position: id.split('-')[1] });
    const getQuantityAtLocation = (productId, locationId) => {
      const item = inventory.find(i => i.productId === productId && i.locationId === locationId);
      return item ? item.quantity : 0;
    };

    // ======= RENDERIZAÇÃO DAS PÁGINAS =======

    function renderHome() {
      const totalItems = inventory.reduce((sum, item) => sum + item.quantity, 0);
      const uniqueProducts = [...new Set(inventory.map(item => item.productId))].length;
      const recentHistory = history.slice(-5).reverse();

      document.getElementById('page-home').innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-gray-500 text-sm font-medium">Total de Itens em Estoque</h2>
            <p class="text-3xl font-bold mt-2">${totalItems.toLocaleString('pt-BR')}</p>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-gray-500 text-sm font-medium">Produtos Únicos</h2>
            <p class="text-3xl font-bold mt-2">${uniqueProducts.toLocaleString('pt-BR')}</p>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-gray-500 text-sm font-medium">Movimentações</h2>
            <p class="text-3xl font-bold mt-2">${history.length.toLocaleString('pt-BR')}</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-bold mb-4">Atividade Recente</h2>
          <div class="divide-y divide-gray-200">
            ${recentHistory.length === 0 ? '<p class="text-gray-500">Nenhuma atividade registrada.</p>' :
              recentHistory.map(item => `
                <div class="py-3 flex justify-between items-center">
                  <div>
                    <p class="font-medium">${getProductById(item.productId)?.nomeCompleto || 'Produto desconhecido'}</p>
                    <p class="text-sm text-gray-500">Local: ${item.locationId} | ${new Date(item.timestamp).toLocaleString('pt-BR')}</p>
                  </div>
                  <div class="text-right">
                    <span class="font-bold text-${item.type === 'entrada' ? 'green' : 'red'}-600">
                      ${item.type === 'entrada' ? '+' : '-'}${item.quantity}
                    </span>
                  </div>
                </div>
              `).join('')
            }
          </div>
        </div>
      `;
    }

    function renderTransactionPage(type) {
      const isEntry = type === 'entrada';
      const pageId = `page-${type}`;
      const targetPage = document.getElementById(pageId);
      const title = isEntry ? 'Registrar Entrada' : 'Registrar Saída';
      const buttonText = isEntry ? 'Dar Entrada' : 'Dar Saída';
      const buttonColor = isEntry ? 'bg-blue-600 hover:bg-blue-700' : 'bg-red-600 hover:bg-red-700';

      targetPage.innerHTML = `
        <div class="max-w-xl mx-auto">
          <h1 class="text-3xl font-bold mb-6">${title}</h1>
          <div class="bg-white p-8 rounded-lg shadow-md">
            <form id="transaction-form" class="space-y-6">
              <div id="feedback-message" class="hidden p-3 rounded-md"></div>
              
                            <div>
                <label for="product" class="block text-sm font-medium text-gray-700">Produto</label>
                <div class="mt-1 flex gap-2">
                  <select id="product" name="product" required class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Selecione um produto...</option>
                    ${productList.map(p => `<option value="${p.id}">${p.nomeCompleto}</option>`).join('')}
                  </select>
                  <button type="button" id="scan-btn" class="flex-shrink-0 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-line"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                  </button>
                </div>
              </div>
              
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label for="location" class="block text-sm font-medium text-gray-700">Local (Rua)</label>
                  <select id="location" name="location" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    ${mapLayout.locations.map(l => `<option value="${l}">${l}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label for="position" class="block text-sm font-medium text-gray-700">Posição</label>
                  <select id="position" name="position" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    ${mapLayout.positions.map(p => `<option value="${p}">${p}</option>`).join('')}
                  </select>
                </div>
              </div>

                            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                <input type="number" id="quantity" name="quantity" min="1" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <p id="available-qty-msg" class="text-xs text-gray-500 mt-1"></p>
              </div>
              
              <div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ${buttonColor} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                  ${buttonText}
                </button>
              </div>
            </form>
          </div>
        </div>
      `;

      const form = targetPage.querySelector('#transaction-form');
      const productSelect = form.querySelector('#product');
      const locationSelect = form.querySelector('#location');
      const positionSelect = form.querySelector('#position');
      const quantityInput = form.querySelector('#quantity');
      const availableQtyMsg = form.querySelector('#available-qty-msg');

      // Pre-select location if coming from map
      if (preselectedLocation) {
        locationSelect.value = preselectedLocation.location;
        positionSelect.value = preselectedLocation.position;
      }

      // Update available quantity message for Saída
      const updateAvailableQty = () => {
        if (isEntry) return;
        const productId = parseInt(productSelect.value, 10);
        const locationId = generateLocationId(locationSelect.value, positionSelect.value);
        if (productId && locationId) {
          const qty = getQuantityAtLocation(productId, locationId);
          availableQtyMsg.textContent = `Disponível neste local: ${qty}`;
          quantityInput.max = qty;
        } else {
          availableQtyMsg.textContent = '';
        }
      };

      productSelect.onchange = updateAvailableQty;
      locationSelect.onchange = updateAvailableQty;
      positionSelect.onchange = updateAvailableQty;

      // Handle Scan
      targetPage.querySelector('#scan-btn').onclick = () => {
        showScanModal((product, quantity) => {
          if (product) productSelect.value = product.id;
          if (quantity > 0) quantityInput.value = quantity;
          updateAvailableQty();
        });
      };

      // Handle form submission
      form.onsubmit = (e) => {
        e.preventDefault();
        const feedback = form.querySelector('#feedback-message');
        const productId = parseInt(productSelect.value, 10);
        const quantity = parseInt(quantityInput.value, 10);
        const locationId = generateLocationId(locationSelect.value, positionSelect.value);

        if (isNaN(productId) || isNaN(quantity) || quantity <= 0) {
          feedback.textContent = 'Por favor, preencha todos os campos corretamente.';
          feedback.className = 'p-3 rounded-md bg-red-100 text-red-800';
          feedback.classList.remove('hidden');
          return;
        }

        const inventoryIndex = inventory.findIndex(i => i.productId === productId && i.locationId === locationId);

        if (isEntry) {
          if (inventoryIndex > -1) {
            inventory[inventoryIndex].quantity += quantity;
          } else {
            inventory.push({ productId, locationId, quantity });
          }
        } else { // Saída
          if (inventoryIndex === -1 || inventory[inventoryIndex].quantity < quantity) {
            feedback.textContent = 'Quantidade insuficiente no local selecionado.';
            feedback.className = 'p-3 rounded-md bg-red-100 text-red-800';
            feedback.classList.remove('hidden');
            return;
          }
          inventory[inventoryIndex].quantity -= quantity;
          if (inventory[inventoryIndex].quantity === 0) {
            inventory.splice(inventoryIndex, 1); // Remove item if quantity is zero
          }
        }

        history.push({
          type,
          productId,
          quantity,
          locationId,
          timestamp: new Date().toISOString()
        });

        persist();
        feedback.textContent = `Operação de ${type} realizada com sucesso!`;
        feedback.className = 'p-3 rounded-md bg-green-100 text-green-800';
        feedback.classList.remove('hidden');
        form.reset();
        if(preselectedLocation) { // Re-populate location if it was pre-selected
          locationSelect.value = preselectedLocation.location;
          positionSelect.value = preselectedLocation.position;
        }
        updateAvailableQty();
        setTimeout(() => feedback.classList.add('hidden'), 4000);
      };
    }

    const renderEntrada = () => renderTransactionPage('entrada');
    const renderSaida = () => renderTransactionPage('saida');

    function renderMapa() {
      const page = document.getElementById('page-mapa');
      const uniqueModels = [...new Set(productList.map(p => p.modelo))].sort();
      const uniqueGrades = [...new Set(productList.map(p => p.grade))].sort();
      const uniqueVariations = [...new Set(productList.map(p => p.variacao))].sort();

      page.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Mapa do Estoque</h1>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap gap-4 items-end">
          <div>
            <label for="filter-modelo" class="text-sm font-medium text-gray-700">Modelo</label>
            <select id="filter-modelo" class="mt-1 block w-full md:w-48 border-gray-300 rounded-md shadow-sm text-sm">
              <option value="">Todos</option>
              ${uniqueModels.map(m => `<option value="${m}" ${mapFilters.modelo === m ? 'selected' : ''}>${m}</option>`).join('')}
            </select>
          </div>
          <div>
            <label for="filter-grade" class="text-sm font-medium text-gray-700">Grade</label>
            <select id="filter-grade" class="mt-1 block w-full md:w-32 border-gray-300 rounded-md shadow-sm text-sm">
              <option value="">Todas</option>
              ${uniqueGrades.map(g => `<option value="${g}" ${mapFilters.grade === g ? 'selected' : ''}>${g}</option>`).join('')}
            </select>
          </div>
          <div>
            <label for="filter-variacao" class="text-sm font-medium text-gray-700">Variação</label>
            <select id="filter-variacao" class="mt-1 block w-full md:w-48 border-gray-300 rounded-md shadow-sm text-sm">
              <option value="">Todas</option>
              ${uniqueVariations.map(v => `<option value="${v}" ${mapFilters.variacao === v ? 'selected' : ''}>${v}</option>`).join('')}
            </select>
          </div>
          <button id="clear-filters-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">Limpar</button>
        </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-5">
          ${mapLayout.locations.map(loc => `
            <div class="bg-gray-200 rounded-lg p-3 flex flex-col gap-3 shadow">
              <div class="text-center font-bold text-lg text-gray-700 border-b-2 border-gray-400 pb-2">RUA ${loc}</div>
              ${mapLayout.positions.map(pos => {
                const locationId = generateLocationId(loc, pos);
                const itemsInLocation = inventory.filter(i => i.locationId === locationId);
                const filteredItems = itemsInLocation.filter(i => matchesMapFilter(getProductById(i.productId)));
                const totalQty = itemsInLocation.reduce((sum, i) => sum + i.quantity, 0);
                const hasFilteredItem = filteredItems.length > 0;
                const isActiveFilter = mapFilters.modelo || mapFilters.grade || mapFilters.variacao;
                const cardClass = totalQty === 0 ? 'bg-white' : (isActiveFilter ? (hasFilteredItem ? 'bg-yellow-200 ring-2 ring-yellow-500' : 'bg-white opacity-60') : 'bg-blue-100');

                return `
                <div id="map-card-${locationId}" data-location="${loc}" data-position="${pos}" class="map-card-position p-3 rounded-md shadow-sm cursor-pointer hover:shadow-lg ${cardClass}">
                  <div class="flex justify-between items-center">
                    <h4 class="font-bold text-gray-800">${pos}</h4>
                    <span class="text-sm font-semibold px-2 py-0.5 rounded-full ${totalQty > 0 ? 'bg-gray-800 text-white' : 'bg-gray-300 text-gray-600'}">${totalQty}</span>
                  </div>
                  ${hasFilteredItem ? `<p class="text-xs mt-1 text-yellow-800 font-medium">Contém item filtrado</p>` : ''}
                </div>`;
              }).join('')}
            </div>`).join('')}
        </div>
      `;
      
      // Add filter event listeners
      const applyFilters = () => {
        mapFilters.modelo = page.querySelector('#filter-modelo').value;
        mapFilters.grade = page.querySelector('#filter-grade').value;
        mapFilters.variacao = page.querySelector('#filter-variacao').value;
        renderMapa();
      };
      page.querySelector('#filter-modelo').onchange = applyFilters;
      page.querySelector('#filter-grade').onchange = applyFilters;
      page.querySelector('#filter-variacao').onchange = applyFilters;
      page.querySelector('#clear-filters-btn').onclick = () => {
        clearMapFilters();
        renderMapa();
      };

      // Add card click listener
      page.querySelectorAll('.map-card-position').forEach(card => {
        card.onclick = () => {
          const location = card.dataset.location;
          const position = card.dataset.position;
          const locationId = generateLocationId(location, position);
          const itemsInLocation = inventory.filter(i => i.locationId === locationId);

          const modalContent = `
            <div class="p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-xl font-bold">Local: ${locationId}</h3>
                  <p class="text-gray-500">Itens neste local</p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">✕</button>
              </div>
              <div class="max-h-80 overflow-y-auto pr-2">
                ${itemsInLocation.length > 0 ? itemsInLocation.map(item => `
                  <div class="flex justify-between items-center py-2 border-b">
                    <p class="text-sm">${getProductById(item.productId)?.nomeCompleto}</p>
                    <p class="font-bold">${item.quantity}</p>
                  </div>
                `).join('') : '<p class="text-center text-gray-500 py-4">Este local está vazio.</p>'}
              </div>
              <div class="flex gap-3 mt-5">
                <button id="modal-add-btn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">Adicionar</button>
                <button id="modal-remove-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm ${itemsInLocation.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${itemsInLocation.length === 0 ? 'disabled' : ''}>Remover</button>
              </div>
            </div>
          `;
          showModal(modalContent, 'lg');
          
          document.getElementById('modal-add-btn').onclick = () => {
            preselectedLocation = { location, position };
            closeModal();
            window.location.hash = '#entrada';
          };
          document.getElementById('modal-remove-btn').onclick = () => {
            preselectedLocation = { location, position };
            closeModal();
            window.location.hash = '#saida';
          };
        };
      });
    }

    function renderRelatorios() {
      const page = document.getElementById('page-relatorios');
      page.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Relatórios</h1>
        <div class="space-y-4 max-w-md">
          <div class="bg-white p-5 rounded-lg shadow-md flex justify-between items-center">
            <div>
              <h2 class="font-bold">Estoque por Produto</h2>
              <p class="text-sm text-gray-500">Total de cada produto em todos os locais.</p>
            </div>
            <button id="report-by-product" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">Gerar CSV</button>
          </div>
          <div class="bg-white p-5 rounded-lg shadow-md flex justify-between items-center">
            <div>
              <h2 class="font-bold">Estoque por Local</h2>
              <p class="text-sm text-gray-500">Lista de todos os produtos por cada local.</p>
            </div>
            <button id="report-by-location" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">Gerar CSV</button>
          </div>
        </div>`;

      const downloadCSV = (filename, csvContent) => {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      page.querySelector('#report-by-product').onclick = () => {
        const headers = "ID do Produto,Modelo,Grade,Material,Variacao,Quantidade Total";
        const stockByProduct = inventory.reduce((acc, item) => {
          acc[item.productId] = (acc[item.productId] || 0) + item.quantity;
          return acc;
        }, {});
        
        const rows = Object.entries(stockByProduct).map(([productId, quantity]) => {
          const product = getProductById(parseInt(productId, 10));
          return [
            product.id, `"${product.modelo}"`, `"${product.grade}"`, `"${product.material}"`, `"${product.variacao}"`, quantity
          ].join(',');
        });
        downloadCSV('estoque_por_produto.csv', [headers, ...rows].join('\n'));
      };
      
      page.querySelector('#report-by-location').onclick = () => {
        const headers = "Local,ID do Produto,Modelo,Grade,Material,Variacao,Quantidade";
        const rows = inventory.map(item => {
          const product = getProductById(item.productId);
          return [
            `"${item.locationId}"`, product.id, `"${product.modelo}"`, `"${product.grade}"`, `"${product.material}"`, `"${product.variacao}"`, item.quantity
          ].join(',');
        });
        downloadCSV('estoque_por_local.csv', [headers, ...rows].join('\n'));
      };
    }

    function renderHistorico() {
      const page = document.getElementById('page-historico');
      const sortedHistory = [...history].reverse();
      page.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Histórico de Movimentações</h1>
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3">Data/Hora</th>
                  <th scope="col" class="px-6 py-3">Tipo</th>
                  <th scope="col" class="px-6 py-3">Produto</th>
                  <th scope="col" class="px-6 py-3">Qtd.</th>
                  <th scope="col" class="px-6 py-3">Local</th>
                </tr>
              </thead>
              <tbody>
                ${sortedHistory.length > 0 ? sortedHistory.map(item => `
                  <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${new Date(item.timestamp).toLocaleString('pt-BR')}</td>
                    <td class="px-6 py-4">
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.type === 'entrada' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${item.type}
                      </span>
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900">${getProductById(item.productId)?.nomeCompleto || 'N/A'}</td>
                    <td class="px-6 py-4">${item.quantity}</td>
                    <td class="px-6 py-4">${item.locationId}</td>
                  </tr>
                `).join('') : `<tr><td colspan="5" class="text-center py-10">Nenhum histórico encontrado.</td></tr>`}
              </tbody>
              </table>
          </div>
        </div>
      `;
    }

    function renderAdmin() {
      const page = document.getElementById('page-admin');
      if (!adminAuthenticated) {
        page.innerHTML = `
          <div class="max-w-sm mx-auto mt-10">
            <div class="bg-white p-8 rounded-lg shadow-md">
              <h1 class="text-2xl font-bold mb-4 text-center">Acesso Admin</h1>
              <form id="admin-login-form">
                <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="password" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                <p id="admin-error" class="text-red-600 text-sm mt-1 h-4"></p>
                <button type="submit" class="mt-4 w-full bg-gray-800 text-white py-2 rounded-md hover:bg-gray-700">Entrar</button>
              </form>
            </div>
          </div>`;
        page.querySelector('#admin-login-form').onsubmit = (e) => {
          e.preventDefault();
          const pass = page.querySelector('#password').value;
          if (pass === adminPassword) {
            adminAuthenticated = true;
            renderAdmin();
          } else {
            page.querySelector('#admin-error').textContent = 'Senha incorreta.';
          }
        };
        return;
      }

      // If authenticated:
      page.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Painel Administrativo</h1>
        <div class="space-y-6 max-w-2xl">
                    <div class="bg-white p-5 rounded-lg shadow-md">
            <h2 class="font-bold text-lg mb-4">Gerenciamento de Dados</h2>
            <div class="flex flex-wrap gap-4">
              <button id="export-data" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Exportar Dados (JSON)</button>
              <button onclick="document.getElementById('import-file').click()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Importar Dados (JSON)</button>
              <input type="file" id="import-file" class="hidden" accept=".json">
            </div>
          </div>
                    <div class="bg-red-50 border-l-4 border-red-500 p-5 rounded-lg shadow-md">
            <h2 class="font-bold text-lg text-red-800 mb-4">Zona de Perigo</h2>
            <div class="flex flex-wrap gap-4">
              <button id="clear-inventory" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-800">Limpar Inventário</button>
              <button id="clear-history" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-800">Limpar Histórico</button>
            </div>
          </div>
        </div>`;

      page.querySelector('#export-data').onclick = () => {
        const dataStr = JSON.stringify({ inventory, history }, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_estoque_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      page.querySelector('#import-file').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (Array.isArray(data.inventory) && Array.isArray(data.history)) {
              if (confirm("Tem certeza que deseja substituir todos os dados atuais por este arquivo de backup?")) {
                inventory = data.inventory;
                history = data.history;
                persist();
                alert("Dados importados com sucesso!");
                navigateTo('#home');
              }
            } else {
              alert('Arquivo de backup inválido.');
            }
          } catch (err) {
            alert('Erro ao ler o arquivo JSON.');
          }
        };
        reader.readAsText(file);
      };

      page.querySelector('#clear-inventory').onclick = () => {
        if (confirm("ATENÇÃO: Isso apagará TODOS os itens do inventário. Deseja continuar?")) {
          inventory = [];
          persist();
          alert('Inventário limpo.');
        }
      };
      
      page.querySelector('#clear-history').onclick = () => {
        if (confirm("ATENÇÃO: Isso apagará TODO o histórico de movimentações. Deseja continuar?")) {
          history = [];
          persist();
          alert('Histórico limpo.');
        }
      };
    }

    // ======= NAVEGAÇÃO =======
    function navigateTo(hash) {
      hash = hash || '#home';
      if (!hash.startsWith('#')) hash = '#home';

      pages.forEach(p => p.classList.add('hidden'));
      menuItems.forEach(i => i.classList.remove('active'));

      const pageName = hash.substring(1);
      const pageId = `page-${pageName}`;
      const targetPage = document.getElementById(pageId);
      
      if (targetPage) {
        targetPage.classList.remove('hidden');
        
        if (pageName !== 'entrada' && pageName !== 'saida') preselectedLocation = null;
        if (pageName !== 'mapa') clearMapFilters();

        switch (pageName) {
          case 'home': renderHome(); break;
          case 'entrada': renderEntrada(); break;
          case 'saida': renderSaida(); break;
          case 'mapa': renderMapa(); break;
          case 'relatorios': renderRelatorios(); break;
          case 'historico': renderHistorico(); break;
          case 'admin': renderAdmin(); break;
        }

        const activeMenuItems = document.querySelectorAll(`.menu-item[href="${hash}"]`);
        activeMenuItems.forEach(item => item.classList.add('active'));
        if (activeMenuItems.length > 0) {
          headerTitle.textContent = activeMenuItems[0].textContent.trim();
        }
      } else {
        navigateTo('#home');
      }
    }

    // ======= INICIALIZAÇÃO =======
    function init() {
      loadFromLocalStorage(); // Usando localStorage em vez do servidor simulado
      navigateTo(window.location.hash);
      window.addEventListener('hashchange', () => navigateTo(window.location.hash));

      // Delegação de eventos para os links de navegação para um melhor controle
      document.body.addEventListener('click', e => {
          const menuItem = e.target.closest('a.menu-item');
          if (menuItem) {
             const hash = new URL(menuItem.href).hash;
             if (hash !== window.location.hash) {
               window.location.hash = hash;
             } else { // se já estiver na página, força a re-renderização
               navigateTo(hash);
             }
          }
      });
    }

    init();
  });
  </script>

</body>
</html>
```
