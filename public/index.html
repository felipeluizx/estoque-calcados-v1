<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Estoque - Indústria de Calçados</title>
  <!-- Ícone da página -->
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABgcAAAYHCAYAAABPN6iqAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAGhHSURBVHhe7N2/qmXnmefxo4ZyX8AkloMGJRO6kxIFShT4AnwBnY1hJmsY8GUYDMpkkDNfgC/AgRKBwYmGjpw0KJA7aF+ApEATlKvO2f/O2Xvt9a71vL/n84GC7tWNqlTa6/3zfLVLH7x5/fGPDwAAAAAAQBsfvHn98Y9//stPjp8DAAAAAACB3rz+/uGfjh8CAAAAAADZxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAgGbEAQAAAAAAaEYcAAAAAACAZsQBAAAAAABoRhwAAAAAAIBmxAEAAAAAAGhGHAAAAAAAaOXVZx8ePwAAxw==">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Scanner QR -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Gerador de QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .menu-item.active { background-color: #1d4ed8; color: white; }
    .modal-backdrop { background-color: rgba(0,0,0,0.5); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    select:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .map-card-position { transition: all 0.2s ease-in-out; }

    .move-mode-active .map-card-position { background-color: #cceeff; cursor: copy; animation: pulse-blue 1.5s infinite; }
    .move-mode-active .map-card-position.move-source { background-color: #fdd835; opacity: 1; cursor: not-allowed; }

    @keyframes pulse-blue {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }

    /* Área do leitor QR */
    #reader {
        position: relative;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        min-height: 320px;
    }
    #reader__scan_region {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #reader__scan_region::after {
        content: '';
        position: absolute;
        width: 250px;
        height: 250px;
        border: 4px solid rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        box-shadow: 0 0 0 4000px rgba(0,0,0,0.4);
        animation: scan-glow 2s infinite ease-in-out;
    }
    @keyframes scan-glow {
        0%, 100% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.4), 0 0 10px 2px #4ade80; }
        50% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.4), 0 0 10px 2px #16a34a; }
    }
    
    @media print {
      body * { visibility: hidden; }
      #printable-area, #printable-area * { visibility: visible; }
      #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
      nav, aside, header, .modal-backdrop > div:not(#printable-area-container) { display: none !important; }
      .modal-backdrop { background-color: white !important; justify-content: flex-start; align-items: flex-start; }
    }
  </style>
</head>
<body class="antialiased text-gray-800">

  <div id="app" class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar (desktop) -->
    <aside class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
      <div class="flex items-center justify-center h-16 border-b border-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
        <span class="ml-2 text-lg font-bold">Estoque Calçados</span>
      </div>
      <nav class="flex-1 px-2 py-4 space-y-2">
        <a href="#home" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          Dashboard
        </a>
        <a href="#entrada" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          Entrada
        </a>
        <a href="#saida" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          Saída
        </a>
        <a href="#mapa" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          Mapa do Estoque
        </a>
        <a href="#produtos" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
          Produtos
        </a>
        <a href="#relatorios" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          Relatórios
        </a>
        <a href="#pedidos" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/>
    <path d="M2.05 2.05h3l2.68 12.07A2 2 0 0 0 9.68 16h8.72a2 2 0 0 0 1.95-1.58l1.49-7.42H6.5"/>
  </svg>
  Pedidos
</a>

        <a href="#historico" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
          Histórico
        </a>
        <a href="#admin" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <div class="flex-1 flex flex-col">
      <!-- Mobile Header -->
      <header class="md:hidden flex items-center justify-between bg-gray-800 text-white p-4 shadow-md sticky top-0 z-10">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
          <span id="header-title" class="ml-2 text-lg font-bold">Dashboard</span>
        </div>
        <a href="#admin" class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-white text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </header>

      <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="page-home" class="page"></div>
        <div id="page-entrada" class="page hidden"></div>
        <div id="page-saida" class="page hidden"></div>
        <div id="page-mapa" class="page hidden"></div>
        <div id="page-produtos" class="page hidden"></div>
        <div id="page-relatorios" class="page hidden"></div>
        <div id="page-pedidos" class="page hidden"></div>
        <div id="page-etiquetas" class="page hidden"></div>
        <div id="page-historico" class="page hidden"></div>
        <div id="page-admin" class="page hidden"></div>
      </main>

      <!-- Bottom Nav (mobile) -->
      <nav class="md:hidden grid grid-cols-5 gap-1 p-2 bg-gray-800 text-white border-t border-gray-700 sticky bottom-0">
        <a href="#home" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          <span class="text-xs">Dashboard</span>
        </a>
        <a href="#entrada" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          <span class="text-xs">Entrada</span>
        </a>
        <a href="#saida" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          <span class="text-xs">Saída</span>
        </a>
        <a href="#mapa" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          <span class="text-xs">Mapa</span>
        </a>
        <a href="#pedidos" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/>
    <path d="M2.05 2.05h3l2.68 12.07A2 2 0 0 0 9.68 16h8.72a2 2 0 0 0 1.95-1.58l1.49-7.42H6.5"/>
  </svg>
  <span class="text-xs">Pedidos</span>
</a>

        <a href="#relatorios" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          <span class="text-xs">Relatórios</span>
        </a>
      </nav>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <!-- Modals -->
  <div id="modal-container" class="hidden"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {

    // --- DADOS DO SISTEMA ---
    let productList = JSON.parse(localStorage.getItem('products') || '[]');
    productList = productList.map(p => ({...p, nomeCompleto: p.nomeCompleto || \`\${p.modelo} \${p.grade} \${p.material} \${p.variacao}\`}));
    let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
    let history = JSON.parse(localStorage.getItem('history') || '[]');
    let isSyncing = false;

    const saveLocal = () => {
      localStorage.setItem('products', JSON.stringify(productList));
      localStorage.setItem('inventory', JSON.stringify(inventory));
      localStorage.setItem('history', JSON.stringify(history));
    };

    // --- LÓGICA DE DADOS E SINCRONIZAÇÃO ---
    async function loadAllDataFromServer() {
        if (isSyncing) return;
        isSyncing = true;
        try {
            const [estoqueRes, produtosRes] = await Promise.allSettled([
                fetch('/api/estoque'),
                fetch('/api/produtos')
            ]);

            if (estoqueRes.status === 'fulfilled' && estoqueRes.value.ok) {
              const estoqueData = await estoqueRes.value.json();
              inventory = Array.isArray(estoqueData.inventory) ? estoqueData.inventory : inventory;
              history = Array.isArray(estoqueData.history) ? estoqueData.history : history;
            }
            if (produtosRes.status === 'fulfilled' && produtosRes.value.ok) {
              const produtosData = await produtosRes.value.json();
              productList = Array.isArray(produtosData)
                ? produtosData.map(p => ({ ...p, nomeCompleto: \`\${p.modelo} \${p.grade} \${p.material} \${p.variacao}\` }))
                : productList;
            }
            saveLocal();
            rerenderCurrentPage();
            showToast('Dados sincronizados.', 'success');
        } catch (error) {
            console.error("Falha ao buscar dados do servidor:", error);
            showToast('Erro de conexão ao buscar dados.', 'error');
        } finally {
            isSyncing = false;
        }
    }

    async function persistInventory() {
      saveLocal();
      try {
        await fetch('/api/estoque', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inventory, history }),
        });
      } catch (_) { /* opcional */ }
    }

    async function persistProducts() {
      saveLocal();
      try {
        await fetch('/api/produtos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productList.map(({nomeCompleto, ...rest}) => rest)),
        });
      } catch (_) { /* opcional */ }
    }

    const mapLayout = { locations: ['A','B','C','D','E','F','G','H','I','J','K','L'], positions: ['FUNDO','MEIO','FRENTE'] };
    const adminPassword = '123';
    let adminAuthenticated = false;
    let lastVisitedHash = '#home';

    let moveOperation = null; // { fromLocationId, productId? }

    const pages = document.querySelectorAll('.page');
    const menuItems = document.querySelectorAll('.menu-item');
    const headerTitle = document.getElementById('header-title');

    // ======= SCANNER / QR =======
    let preselectedLocation = null;
    let activeScanner = null;

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === 'suspended') { ctx.resume(); }
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime + 0.02);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.15);
      } catch (e) { /* ignore */ }
    }

    function parseScannedPayload(text) {
      try {
        const j = JSON.parse(text);
        if(j.type === 'location' && j.location) return { type: 'location', location: j.location };
        if(j.productId) return { type: 'product', productId: j.productId };
      } catch(_) {
        const n = Number(text.trim());
        if (!Number.isNaN(n)) return { type: 'product', productId: n };
      }
      return { type: 'unknown' };
    }

    async function stopActiveScanner() {
      try {
        if (activeScanner) {
          await activeScanner.stop();
          activeScanner.clear();
        }
      } catch (_) {}
      activeScanner = null;
    }

    async function showGenericScanner(title, onSuccess) {
      const content = `
        <div class="p-4 relative">
          <button id="scan-close" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
          </button>
          <h3 class="text-lg font-bold mb-3 text-center">${title}</h3>
          <div id="reader" class="w-full"></div>
          <div id="scan-feedback" class="hidden mt-3 px-3 py-2 rounded-md bg-green-100 text-green-800 text-sm font-medium">Código lido! Processando...</div>
          <p class="text-xs text-gray-500 mt-3 text-center">Se solicitado, permita o acesso à câmera.</p>
        </div>`;
      showModal(content);

      let isHandlingScan = false;
      const onScanSuccessWrapper = (decodedText) => {
        if (isHandlingScan) return;
        isHandlingScan = true;
        document.getElementById('scan-feedback')?.classList.remove('hidden');
        beep();
        setTimeout(async () => {
          await stopActiveScanner();
          closeModal();
          onSuccess(decodedText);
        }, 1000);
      };
      
      document.getElementById('scan-close').onclick = async () => {
        await stopActiveScanner();
        closeModal();
      };

      const html5Qrcode = new Html5Qrcode("reader");
      activeScanner = html5Qrcode;
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    // Evita múltiplas leituras se o callback engasgar
let stopRequested = false;
const originalOnSuccess = onSuccess;
onSuccess = (txt) => { if (stopRequested) return; stopRequested = true; originalOnSuccess(txt); };


      try {
const devices = await Html5Qrcode.getCameras();
if (devices && devices.length) {
  const back = devices.find(d => /back|traseira|rear/i.test(d.label)) || devices[0];
  await html5Qrcode.start(
    back.id,
    config,
    onScanSuccessWrapper,
    () => {}
  );
} else {
  showToast('Nenhuma câmera encontrada.', 'error');
  closeModal();
}

      } catch (err) {
        showToast(`Erro ao iniciar a câmera: ${err.message}`, 'error');
        closeModal();
      }
    }

    // ======= UI Helpers =======
    function showToast(text, type='info') {
      const id = 't' + Math.random().toString(36).slice(2);
      const colors = { info: 'bg-gray-800 text-white', success: 'bg-green-600 text-white', error: 'bg-red-600 text-white', warn: 'bg-yellow-500 text-black' };
      const div = document.createElement('div');
      div.id = id;
      div.className = \`px-4 py-2 rounded shadow ${colors[type]||colors.info}\`;
      div.textContent = text;
      document.getElementById('toast-container').appendChild(div);
      setTimeout(()=>{ div.remove(); }, 3500);
    }

    function showModal(innerHtml) {
      const container = document.getElementById('modal-container');
      container.className = "fixed inset-0 z-40 modal-backdrop flex items-center justify-center p-4";
      container.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-h-[90vh] overflow-auto w-full max-w-3xl" id="printable-area-container">
          ${innerHtml}
        </div>`;
    }
    function closeModal() {
      const container = document.getElementById('modal-container');
      container.className = "hidden";
      container.innerHTML = "";
    }

    function headerFromHash(hash) {
      return ({
        '#home':'Dashboard',
        '#entrada':'Entrada',
        '#saida':'Saída',
        '#mapa':'Mapa do Estoque',
        '#produtos':'Produtos',
        '#relatorios':'Relatórios',
        '#pedidos':'Pedidos',  
        '#etiquetas':'Etiquetas',
        '#historico':'Histórico',
        '#admin':'Admin'
      })[hash] || 'Dashboard';
    }

    function setActiveMenu(hash) {
      menuItems.forEach(mi => mi.classList.remove('active'));
      document.querySelectorAll(\`a[href="${hash}"]\`).forEach(a => a.classList.add('active'));
      headerTitle.textContent = headerFromHash(hash);
    }

    function rerenderCurrentPage() {
      const h = location.hash || '#home';
      pages.forEach(p => p.classList.add('hidden'));
      setActiveMenu(h);
      switch (h) {
        case '#home': document.getElementById('page-home').classList.remove('hidden'); renderDashboard(); break;
        case '#entrada': document.getElementById('page-entrada').classList.remove('hidden'); renderEntrada(); break;
        case '#saida': document.getElementById('page-saida').classList.remove('hidden'); renderSaida(); break;
        case '#mapa': document.getElementById('page-mapa').classList.remove('hidden'); renderMap(); break;
        case '#produtos': document.getElementById('page-produtos').classList.remove('hidden'); renderProdutos(); break;
        case '#relatorios': document.getElementById('page-relatorios').classList.remove('hidden'); renderRelatorios(); break;
        case '#historico': document.getElementById('page-historico').classList.remove('hidden'); renderHistorico(); break;
        case '#admin': document.getElementById('page-admin').classList.remove('hidden'); renderAdmin(); break;
        case '#pedidos': document.getElementById('page-pedidos').classList.remove('hidden'); renderPedidos(); break;
        default: location.hash = '#home';
      }
      lastVisitedHash = h;
    }

    // ======= RENDERERS =======

    const renderDashboard = () => {
      document.body.classList.remove('move-mode-active'); 
      moveOperation = null;
      const container = document.getElementById('page-home');
      const totalBoxes = inventory.reduce((s, i) => s + i.quantity, 0);
      const occupiedSlots = new Set(inventory.map(i => i.locationId)).size;
      const totalSlots = mapLayout.locations.length * mapLayout.positions.length;

      const productCounts = inventory.reduce((acc, i) => {
        const p = productList.find(pp => pp.id === i.productId);
        if (p) acc[p.modelo] = (acc[p.modelo] || 0) + i.quantity;
        return acc;
      }, {});
      const topProduct = Object.entries(productCounts).sort((a,b)=>b[1]-a[1])[0];

      container.innerHTML = `
                                // === controle de UI do modo mover ===
const btnCancel = document.getElementById('btn-move-cancel');
if (moveOperation) {
  btnCancel.classList.remove('hidden');
  document.body.classList.add('move-mode-active');
} else {
  btnCancel.classList.add('hidden');
  document.body.classList.remove('move-mode-active');
}

        <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Caixas em Estoque</h3><p class="text-3xl font-bold mt-2">${totalBoxes.toLocaleString('pt-BR')}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Posições Ocupadas</h3><p class="text-3xl font-bold mt-2">${occupiedSlots} / ${totalSlots}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Modelo com Mais Estoque</h3><p class="text-2xl font-bold mt-2 truncate">${topProduct ? topProduct[0] : 'N/A'}</p><p class="text-gray-500">${topProduct ? `${topProduct[1].toLocaleString('pt-BR')} caixas` : ''}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Produtos Cadastrados</h3><p class="text-3xl font-bold mt-2">${productList.length}</p></div>
        </div>
        <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Movimentações Recentes</h3>
            <a href="#historico" class="text-blue-600 hover:underline text-sm">ver tudo</a>
          </div>
          <ul class="space-y-3">
            ${history.slice(0,8).map(h=>`
              <li class="flex items-start">
                <span class="text-sm text-gray-500 w-28">${new Date(h.date).toLocaleString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
                <span class="font-semibold ${h.type==='ENTRADA'?'text-green-600':h.type==='SAÍDA'?'text-red-600':h.type === 'MOVIMENTAÇÃO' ? 'text-blue-600':'text-yellow-500'}">${h.type}</span>
                <span class="ml-4 text-gray-700">${h.details}</span>
              </li>
            `).join('') || '<li class="text-gray-500">Sem movimentações ainda.</li>'}
          </ul>
        </div>
      `;
    };

    function setupEntradaFormListeners() {
      const form = document.getElementById('entrada-form');
      const selModelo = document.getElementById('entrada-modelo');
      const selGrade = document.getElementById('entrada-grade');
      const selMaterial = document.getElementById('entrada-material');
      const selVariacao = document.getElementById('entrada-variacao');
      const qty = document.getElementById('entrada-quantidade');
      const selLoc = document.getElementById('entrada-location');

      selModelo.addEventListener('change', () => {
        const modelo = selModelo.value;
        const grades = [...new Set(productList.filter(p=>p.modelo===modelo).map(p=>p.grade))].sort();
        selGrade.innerHTML = '<option value="" disabled selected>Selecione a grade</option>' + grades.map(g=>`<option>${g}</option>`).join('');
        selGrade.disabled = false; selMaterial.disabled = true; selVariacao.disabled = true;
        selMaterial.innerHTML = '<option value="">--</option>'; selVariacao.innerHTML = '<option value="">--</option>';
      });
      selGrade.addEventListener('change', () => {
        const modelo = selModelo.value; const grade = selGrade.value;
        const mats = [...new Set(productList.filter(p=>p.modelo===modelo && p.grade===grade).map(p=>p.material))].sort();
        selMaterial.innerHTML = '<option value="" disabled selected>Selecione o material</option>' + mats.map(g=>`<option>${g}</option>`).join('');
        selMaterial.disabled = false; selVariacao.disabled = true; selVariacao.innerHTML = '<option value="">--</option>';
      });
      selMaterial.addEventListener('change', () => {
        const {value:modelo} = selModelo; const {value:grade} = selGrade; const material = selMaterial.value;
        const vars = [...new Set(productList.filter(p=>p.modelo===modelo && p.grade===grade && p.material===material).map(p=>p.variacao))].sort();
        selVariacao.innerHTML = '<option value="" disabled selected>Selecione a variação/cor</option>' + vars.map(v=>`<option>${v}</option>`).join('');
        selVariacao.disabled = false;
      });

      form.addEventListener('submit', e => {
        e.preventDefault();
        const modelo = selModelo.value, grade = selGrade.value, material = selMaterial.value, variacao = selVariacao.value;
        const product = productList.find(p => p.modelo===modelo && p.grade===grade && p.material===material && p.variacao===variacao);
        if (!product) { showToast('Produto não encontrado.', 'error'); return; }
        const q = Number(qty.value);
        if (!q || q<=0) { showToast('Quantidade inválida.', 'error'); return; }
        const loc = selLoc.value;
        addToInventory(product.id, loc, q);
        history.unshift({ date: new Date().toISOString(), type:'ENTRADA', details:`+${q} caixas de ${product.nomeCompleto} em ${loc}` });
        saveLocal(); persistInventory();
        showToast('Entrada registrada!', 'success');
        rerenderCurrentPage();
      });

      document.getElementById('entrada-scan-process-btn').addEventListener('click', () => {
        preselectedLocation = null;
        showGenericScanner('1) Leia o QR da POSIÇÃO', (t1) => {
          const p1 = parseScannedPayload(t1);
          if (p1.type!=='location') { showToast('Primeiro leia o QR de posição.', 'warn'); return; }
          preselectedLocation = p1.location;
          showGenericScanner('2) Leia o QR do PRODUTO', async (t2) => {
            const p2 = parseScannedPayload(t2);
            if (p2.type!=='product') { showToast('QR de produto inválido.', 'error'); return; }
            const prod = productList.find(p => p.id == p2.productId);
            if (!prod) { showToast('Produto não cadastrado.', 'error'); return; }
            askNumber(\`Quantidade para entrada de <b>\${prod.nomeCompleto}</b> em <b>\${preselectedLocation}</b>:\`, 1, (q)=> {
              addToInventory(prod.id, preselectedLocation, q);
              history.unshift({ date:new Date().toISOString(), type:'ENTRADA', details: \`+\${q} \${prod.nomeCompleto} em \${preselectedLocation}\` });
              saveLocal(); persistInventory(); showToast('Entrada concluída.', 'success'); rerenderCurrentPage();
            });
          });
        });
      });
    }

    const renderEntrada = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-entrada');
      const modelos = [...new Set(productList.map(p => p.modelo))].sort();
      
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6 text-green-700">Registrar Entrada</h1>
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="space-y-4">
                 <button type="button" id="entrada-scan-process-btn" class="w-full bg-gray-700 text-white hover:bg-gray-800 px-4 py-3 rounded-md text-lg font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="lucide lucide-scan-line" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                    Iniciar Entrada por Leitura
                </button>
                <div class="text-center text-gray-500">ou preencha manualmente:</div>
            </div>
            <form id="entrada-form" class="mt-4 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700">1. Modelo</label>
                <select id="entrada-modelo" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                <option value="" disabled selected>Selecione o modelo</option>
                ${modelos.map(m=>`<option value="${m}">${m}</option>`).join('')}
                </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">2. Grade</label>
                <select id="entrada-grade" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">3. Material</label>
                <select id="entrada-material" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">4. Variação / Cor</label>
                <select id="entrada-variacao" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">5. Quantidade</label>
                <input type="number" id="entrada-quantidade" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div><label class="block text-sm font-medium text-gray-700">6. Localização</label>
                <select id="entrada-location" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option value="" disabled selected>Selecione a posição</option>
                    ${mapLayout.locations.flatMap(loc => mapLayout.positions.map(pos => `${loc}-${pos}`)).map(l => `<option value="${l}">${l}</option>`).join('')}
                </select>
                </div>
            </div>
            <button type="submit" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 font-bold text-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                Confirmar Entrada Manual
            </button>
            </form>
        </div>
      `;
      setupEntradaFormListeners();
    };

    function setupSaidaFormListeners() {
      const form = document.getElementById('saida-form');
      const selItem = document.getElementById('saida-item');
      const inputQty = document.getElementById('saida-quantidade');

      const updateMax = () => {
  const idx = Number(selItem.value);
  const it = inventory[idx];
  if (!it) {
    inputQty.placeholder = 'Máx: 0';
    inputQty.max = 0;
    return;
  }
  inputQty.placeholder = `Máx: ${it.quantity}`;
  inputQty.max = it.quantity;
};


      selItem.addEventListener('change', updateMax);
      updateMax();

      form.addEventListener('submit', e => {
        e.preventDefault();
        const idx = Number(selItem.value);
        if (Number.isNaN(idx)) return;
        const it = inventory[idx];
        const q = Number(inputQty.value);
        if (!q || q<=0 || q>it.quantity) { showToast('Quantidade inválida.', 'error'); return; }
        const p = productList.find(pp => pp.id === it.productId);
        it.quantity -= q;
        if (it.quantity === 0) inventory.splice(idx,1);
        history.unshift({ date:new Date().toISOString(), type:'SAÍDA', details:`-${q} caixas de ${p?.nomeCompleto||'Produto'} de ${it.locationId}` });
        saveLocal(); persistInventory();
        showToast('Saída registrada.', 'success');
        rerenderCurrentPage();
      });

      document.getElementById('saida-scan-process-btn').addEventListener('click', () => {
        showGenericScanner('Leia o QR do PRODUTO para saída', (txt) => {
          const p2 = parseScannedPayload(txt);
          if (p2.type!=='product') { showToast('QR de produto inválido.', 'error'); return; }
          const entries = inventory.filter(i => i.productId == p2.productId);
          if (entries.length === 0) { showToast('Esse produto não está em estoque.', 'warn'); return; }
          if (entries.length === 1) {
            const it = entries[0]; const product = productList.find(pp=>pp.id==p2.productId);
            askNumber(\`Quantidade para DAR BAIXA de <b>\${product?.nomeCompleto||'Produto'}</b> em <b>\${it.locationId}</b>:\`, 1, (q)=>{
              if (q>it.quantity) { showToast('Qtd maior que disponível.', 'error'); return; }
              it.quantity -= q; if (it.quantity===0) inventory = inventory.filter(x=>x!==it);
              history.unshift({ date:new Date().toISOString(), type:'SAÍDA', details:\`-\${q} \${product?.nomeCompleto||'Produto'} de \${it.locationId}\` });
              saveLocal(); persistInventory(); showToast('Saída concluída.', 'success'); rerenderCurrentPage();
            });
          } else {
            // escolher localização
            const html = `
              <div class="p-4">
                <h3 class="text-lg font-bold mb-3">Escolha a localização para dar baixa</h3>
                <div class="space-y-2">
                  ${entries.map(e => {
                    const p = productList.find(pp=>pp.id==e.productId);
                    return \`<button data-loc="\${e.locationId}" class="w-full text-left px-3 py-2 rounded-md border hover:bg-gray-50">
                      <b>\${e.locationId}</b> — \${p?.nomeCompleto||'Produto'} — <span class="text-gray-600">\${e.quantity} caixas</span>
                    </button>\`;
                  }).join('')}
                </div>
              </div>`;
            showModal(html);
            document.querySelectorAll('#modal-container [data-loc]').forEach(btn=>{
              btn.addEventListener('click', () => {
                const loc = btn.dataset.loc;
                closeModal();
                const it = inventory.find(x=>x.productId==p2.productId && x.locationId==loc);
                const product = productList.find(pp=>pp.id==p2.productId);
                askNumber(\`Quantidade para DAR BAIXA de <b>\${product?.nomeCompleto||'Produto'}</b> em <b>\${loc}</b>:\`, 1, (q)=>{
                  if (q>it.quantity) { showToast('Qtd maior que disponível.', 'error'); return; }
                  it.quantity -= q; if (it.quantity===0) inventory = inventory.filter(x=>x!==it);
                  history.unshift({ date:new Date().toISOString(), type:'SAÍDA', details:\`-\${q} \${product?.nomeCompleto||'Produto'} de \${loc}\` });
                  saveLocal(); persistInventory(); showToast('Saída concluída.', 'success'); rerenderCurrentPage();
                });
              });
            });
          }
        });
      });
    }

    const renderSaida = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-saida');
      if (!inventory.length) {
        container.innerHTML = `
          <h1 class="text-3xl font-bold mb-6 text-red-700">Registrar Saída</h1>
          <div class="bg-white p-6 rounded-lg shadow-md text-center"><p class="text-gray-600">Não há itens no estoque para registrar saída.</p></div>
        `;
        return;
      }
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6 text-red-700">Registrar Saída</h1>
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="space-y-4">
                 <button type="button" id="saida-scan-process-btn" class="w-full bg-gray-700 text-white hover:bg-gray-800 px-4 py-3 rounded-md text-lg font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="lucide lucide-scan-line" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                    Iniciar Saída por Leitura
                </button>
                <div class="text-center text-gray-500">ou preencha manualmente:</div>
            </div>
            <form id="saida-form" class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">1. Item em Estoque</label>
                <select id="saida-item" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                 <option value="" disabled selected>Selecione um item para dar baixa</option>
${
  inventory.map((it, idx) => {
    const p = productList.find(pp=>pp.id===it.productId);
    return { idx, locationId: it.locationId, label: `(${it.locationId}) ${p?.nomeCompleto || 'Produto desconhecido'} - ${it.quantity} caixas` };
  })
  .sort((a,b)=>a.locationId.localeCompare(b.locationId))
  .map(r=>`<option value="${r.idx}">${r.label}</option>`).join('')
}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">2. Quantidade a Retirar</label>
                <input type="number" id="saida-quantidade" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Máx: 0">
              </div>
              <button type="submit" class="w-full bg-red-600 text-white px-4 py-3 rounded-md hover:bg-red-700 font-bold text-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>
                Confirmar Saída Manual
              </button>
            </form>
        </div>
      `;
      setupSaidaFormListeners();
    };

    const renderMap = () => {
      const container = document.getElementById('page-mapa');
      const locationsHtml = mapLayout.locations.map(loc => {
        const positionsHtml = mapLayout.positions.map(pos => {
          const positionId = `${loc}-${pos}`;
          const itemsInPosition = inventory.filter(i => i.locationId === positionId);
          const qtyInPosition = itemsInPosition.reduce((sum, item) => sum + item.quantity, 0);
          const hasItems = qtyInPosition > 0;
          let positionClass = hasItems ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
          let extra = '';
          if (moveOperation?.fromLocationId === positionId) {
            positionClass = 'bg-yellow-400 text-black';
            extra = ' move-source';
          }
          return `
            <div id="map-cell-${positionId}" data-location-id="${positionId}" class="map-card-position${extra} cursor-pointer p-3 rounded-md font-semibold ${positionClass}">
              ${pos} ${qtyInPosition > 0 ? `(${qtyInPosition})` : ''}
            </div>
          `;
        }).join('');

        return `
          <div class="bg-white rounded-lg shadow-md p-2 flex flex-col gap-2 text-center select-none">
            <div class="font-bold text-gray-700 border-b pb-1 text-lg">${loc}</div>
            ${positionsHtml}
          </div>
        `;
      }).join('');

      container.innerHTML = `
          <div class="flex items-start justify-between mb-4 gap-3 flex-wrap">
            <div>
              <h1 class="text-3xl font-bold mb-1">Mapa do Estoque</h1>
              <p class="text-gray-600">Clique em uma posição para ver detalhes, mover itens ou imprimir etiqueta da posição.</p>
            </div>
           <div class="flex gap-2">
  <button id="btn-reorg-mode" class="bg-blue-600 text-white px-3 py-2 rounded-md font-semibold">Modo Reorganização</button>
  <button id="btn-reorg-suggest" class="bg-blue-100 text-blue-800 px-3 py-2 rounded-md font-semibold">Sugestão de Reorganização</button>
  <button id="btn-move-cancel" class="hidden bg-yellow-500 text-black px-3 py-2 rounded-md font-semibold">Cancelar mover</button>
  <button id="btn-print-pos-label" class="bg-gray-800 text-white px-3 py-2 rounded-md font-semibold">Imprimir QR de posição</button>
</div>

          </div>
          <div class="mb-4 flex gap-2 items-center">
            <input type="text" id="map-search" placeholder="Buscar produto no mapa..." class="w-full max-w-md p-2 border rounded-md">
            <button id="btn-print-location-qr" class="px-3 py-2 bg-blue-600 text-white rounded-md">Gerar QR da posição…</button>
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
              ${locationsHtml}
                    // Botão: Modo Reorganização (ativa visual e prepara movimentação rápida)
document.getElementById('btn-reorg-mode').onclick = () => {
  moveOperation = moveOperation ? null : { fromLocationId: null };
  if (moveOperation) {
    document.body.classList.add('move-mode-active');
    showToast('Modo Reorganização ativo: clique em uma posição de ORIGEM, depois DESTINO.', 'info');
  } else {
    document.body.classList.remove('move-mode-active');
    showToast('Modo Reorganização desativado.', 'warn');
  }
  rerenderCurrentPage();
};

// Botão: Sugestão de Reorganização (placeholder – abre dicas)
document.getElementById('btn-reorg-suggest').onclick = () => {
  // Exemplo simples: listar posições com muitos itens e vazias
  const byLoc = mapLayout.locations.flatMap(loc => mapLayout.positions.map(pos => `${loc}-${pos}`))
    .map(id => {
      const qty = inventory.filter(i => i.locationId === id).reduce((s,i)=>s+i.quantity,0);
      return { id, qty };
    });
  const top = byLoc.slice().sort((a,b)=>b.qty-a.qty).slice(0,3);
  const empty = byLoc.filter(x=>x.qty===0).slice(0,3);

  const html = `
    <div class="p-4">
      <h3 class="text-lg font-bold mb-3">Sugestões de Reorganização</h3>
      <div class="space-y-3">
        <div>
          <div class="font-semibold">Posições mais cheias</div>
          <ul class="list-disc pl-5 text-gray-700">
            ${top.map(t=>`<li><b>${t.id}</b> — ${t.qty} caixas</li>`).join('') || '<li>Nenhuma.</li>'}
          </ul>
        </div>
        <div>
          <div class="font-semibold mt-2">Posições vazias</div>
          <ul class="list-disc pl-5 text-gray-700">
            ${empty.map(e=>`<li><b>${e.id}</b></li>`).join('') || '<li>Nenhuma.</li>'}
          </ul>
        </div>
      </div>
      <div class="mt-4 text-sm text-gray-500">Dica: mova dos slots mais cheios para os vazios/próximos para balancear.</div>
    </div>`;
  showModal(html);
};

          </div>
      `;

      document.getElementById('btn-move-cancel').onclick = () => {
        moveOperation = null;
        document.body.classList.remove('move-mode-active');
        showToast('Movimentação cancelada.', 'warn');
        rerenderCurrentPage();
      };

      document.getElementById('btn-print-pos-label').onclick = () => {
        askText('Digite a posição (ex: A-FRENTE):', '', (locId)=>{
          if(!/^[A-L]-(FUNDO|MEIO|FRENTE)$/i.test(locId)) { showToast('Posição inválida.', 'error'); return; }
          showPrintLabels([{ type:'location', location: locId }], `Etiqueta da posição ${locId}`);
        });
      };

      document.getElementById('btn-print-location-qr').onclick = () => {
        askText('Gerar QR para qual posição? (ex: D-MEIO)', '', (locId)=>{
          if(!/^[A-L]-(FUNDO|MEIO|FRENTE)$/i.test(locId)) { showToast('Posição inválida.', 'error'); return; }
          showPrintLabels([{ type:'location', location: locId }], `Etiqueta da posição ${locId}`);
        });
      };

      document.querySelectorAll('.map-card-position').forEach(cell => {
        cell.addEventListener('click', () => {
          const locationId = cell.dataset.locationId;
          if(moveOperation) {
            handleMoveSelection(locationId);
          } else {
            const items = inventory.filter(i => i.locationId === locationId);
            showMapCellModal(locationId, items);
          }
        });
      });

     let mapSearchTid;
document.getElementById('map-search').addEventListener('input', (e) => {
  clearTimeout(mapSearchTid);
  const val = e.target.value;
  mapSearchTid = setTimeout(() => applyMapSearch(val), 180);
});

function applyMapSearch(value) {
  const searchTerm = (value || '').toLowerCase();
  document.querySelectorAll('.map-card-position').forEach(cell => {
    cell.parentElement.classList.remove('opacity-25');
    cell.classList.remove('ring-4', 'ring-yellow-400');
    const parentCard = cell.parentElement;
    const hasMatchInCard = Array.from(parentCard.querySelectorAll('.map-card-position')).some(pos => {
      const locationId = pos.dataset.locationId;
      const itemsInPos = inventory.filter(i => i.locationId === locationId);
      return itemsInPos.some(item => {
        const product = productList.find(p => p.id === item.productId);
        return product && product.nomeCompleto.toLowerCase().includes(searchTerm);
      });
    });
    if (searchTerm && !hasMatchInCard) {
      parentCard.classList.add('opacity-25');
    } else if (searchTerm && hasMatchInCard) {
      const locationId = cell.dataset.locationId;
      const items = inventory.filter(i => i.locationId === locationId);
      const cellHasMatch = items.some(item => {
        const product = productList.find(p => p.id === item.productId);
        return product && product.nomeCompleto.toLowerCase().includes(searchTerm);
      });
      if (cellHasMatch) cell.classList.add('ring-4', 'ring-yellow-400');
    }
  });
}


    const renderProdutos = () => {
      const container = document.getElementById('page-produtos');
      container.innerHTML = `
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h1 class="text-3xl font-bold">Gestão de Produtos</h1>
          <div class="flex gap-2">
            <button id="print-products-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 font-semibold flex items-center gap-2 disabled:opacity-50" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
              Imprimir/Baixar
            </button>
            <button id="add-product-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
              Novo Produto
            </button>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left"><input type="checkbox" id="select-all-products"></th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variação/Cor</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${productList.slice().sort((a,b) => a.id - b.id).map(p => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap"><input type="checkbox" class="product-checkbox" data-product-id="${p.id}"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${p.modelo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${p.grade}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${p.material}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${p.variacao}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      document.getElementById('add-product-btn').addEventListener('click', showAddProductModal);

      const printBtn = document.getElementById('print-products-btn');
      const selectAllCheckbox = document.getElementById('select-all-products');
      const checkboxes = [...document.querySelectorAll('.product-checkbox')];

      const togglePrintButton = () => {
        printBtn.disabled = !checkboxes.some(c => c.checked);
      };
      selectAllCheckbox.addEventListener('change', () => {
        checkboxes.forEach(c => c.checked = selectAllCheckbox.checked);
        togglePrintButton();
      });
      checkboxes.forEach(c => c.addEventListener('change', togglePrintButton));
      togglePrintButton();

      printBtn.addEventListener('click', () => {
        const ids = checkboxes.filter(c=>c.checked).map(c => Number(c.dataset.productId));
        const payloads = ids.map(id => ({ type:'product', productId: id }));
        showPrintLabels(payloads, 'Etiquetas de Produtos');
      });
    };

    const renderRelatorios = () => {
      const container = document.getElementById('page-relatorios');

      const byProduct = inventory.reduce((acc, it) => {
        const p = productList.find(pp=>pp.id===it.productId);
        const key = p ? p.nomeCompleto : `#${it.productId}`;
        acc[key] = (acc[key]||0) + it.quantity;
        return acc;
      }, {});
      const rows = Object.entries(byProduct).sort((a,b)=>b[1]-a[1]);

      const total = rows.reduce((s, r)=>s+r[1], 0);

      container.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">Relatórios</h1>
          <div class="flex gap-2">
            <button id="btn-export-csv" class="px-3 py-2 bg-gray-800 text-white rounded-md">Exportar CSV</button>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left px-4 py-2">Produto</th>
                <th class="text-left px-4 py-2">Caixas</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(([name, qty])=>`
                <tr class="border-t">
                  <td class="px-4 py-2">${name}</td>
                  <td class="px-4 py-2 font-bold">${qty}</td>
                </tr>
              `).join('') || `<tr><td class="px-4 py-4 text-gray-500" colspan="2">Sem dados.</td></tr>`}
            </tbody>
            <tfoot class="bg-gray-50">
              <tr>
                <td class="px-4 py-2 font-bold">Total</td>
                <td class="px-4 py-2 font-bold">${total}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;

document.getElementById('btn-export-csv').onclick = () => {
  const safe = (s) => String(s).replace(/"/g,'""').replace(/\r?\n/g,' ');
  const csv = "Produto,Caixas\n" + rows.map(([n,q])=>`"${safe(n)}",${q}`).join("\n");
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `relatorio_estoque_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
};

    };
    
    const renderPedidos = () => {
  const container = document.getElementById('page-pedidos');
  container.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold">Pedidos</h1>
      <div class="flex gap-2">
        <button id="btn-novo-pedido" class="px-3 py-2 bg-blue-600 text-white rounded-md font-semibold">Novo Pedido</button>
        <button id="btn-abertos" class="px-3 py-2 bg-gray-800 text-white rounded-md">Pedidos em Aberto</button>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-gray-600">Use os botões acima para criar ou gerenciar pedidos.</p>
    </div>
  `;

  // Handlers (placeholders – conecte aqui à sua lógica de pedidos)
  document.getElementById('btn-novo-pedido').onclick = () => {
    showToast('Novo pedido iniciado (implementar lógica).', 'info');
  };
  document.getElementById('btn-abertos').onclick = () => {
    showToast('Listando pedidos em aberto (implementar lógica).', 'info');
  };
};


    const renderHistorico = () => {
      const container = document.getElementById('page-historico');
      container.innerHTML = `
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">Histórico</h1>
          <div class="flex gap-2">
            <input id="hist-search" placeholder="Filtrar..." class="p-2 border rounded-md">
            <button id="hist-clear" class="px-3 py-2 bg-gray-800 text-white rounded-md">Limpar</button>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow-md divide-y" id="hist-list">
        </div>
      `;
      const list = document.getElementById('hist-list');
      const draw = (items) => {
        list.innerHTML = items.map(h=>`
          <div class="p-3 flex gap-3 items-start">
            <span class="text-sm text-gray-500 w-36">${new Date(h.date).toLocaleString('pt-BR')}</span>
            <span class="font-semibold ${h.type==='ENTRADA'?'text-green-600':h.type==='SAÍDA'?'text-red-600':h.type === 'MOVIMENTAÇÃO' ? 'text-blue-600':'text-yellow-500'}">${h.type}</span>
            <span class="text-gray-800">${h.details}</span>
          </div>
        `).join('') || `<div class="p-6 text-gray-500">Sem registros.</div>`;
      };
      draw(history);
      document.getElementById('hist-clear').onclick = () => { draw(history); document.getElementById('hist-search').value=''; };
      document.getElementById('hist-search').oninput = (e) => {
        const t = e.target.value.toLowerCase();
        draw(history.filter(h => (h.details||'').toLowerCase().includes(t) || (h.type||'').toLowerCase().includes(t)));
      };
    };

    const renderAdmin = () => {
      const container = document.getElementById('page-admin');
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Admin</h1>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-3">Sincronização</h3>
            <div class="flex gap-2">
              <button id="btn-sync" class="px-3 py-2 bg-blue-600 text-white rounded-md">Buscar dados do servidor</button>
              <button id="btn-push-products" class="px-3 py-2 bg-gray-800 text-white rounded-md">Enviar PRODUTOS</button>
              <button id="btn-push-inv" class="px-3 py-2 bg-gray-800 text-white rounded-md">Enviar ESTOQUE</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Usa localStorage como cache offline.</p>
          </div>

          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-3">Resetar Estoque</h3>
            <label class="block text-sm mb-2">Senha de admin</label>
            <input id="admin-pass" type="password" class="p-2 border rounded w-full" placeholder="***" />
            <button id="btn-reset" class="mt-3 px-3 py-2 bg-red-600 text-white rounded-md">Zerar inventário</button>
            <p class="text-xs text-gray-500 mt-2">Isso limpa o estoque local e registra evento no histórico.</p>
          </div>

          <div class="bg-white p-4 rounded-lg shadow md:col-span-2">
            <h3 class="font-bold text-lg mb-3">Etiquetas Rápidas</h3>
            <div class="flex gap-2 flex-wrap">
              <button id="btn-qr-loc" class="px-3 py-2 bg-gray-800 text-white rounded-md">Imprimir QR de Posição…</button>
              <button id="btn-qr-prod" class="px-3 py-2 bg-gray-800 text-white rounded-md">Imprimir QR de Produto…</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('btn-sync').onclick = loadAllDataFromServer;
      document.getElementById('btn-push-products').onclick = persistProducts;
      document.getElementById('btn-push-inv').onclick = persistInventory;

      document.getElementById('btn-reset').onclick = () => {
        const pass = (document.getElementById('admin-pass').value||'').trim();
        if (pass !== adminPassword) { showToast('Senha incorreta.', 'error'); return; }
        inventory = [];
        history.unshift({ date:new Date().toISOString(), type:'RESET', details:'Estoque zerado pelo admin.' });
        saveLocal(); persistInventory();
        showToast('Estoque zerado.', 'success');
        rerenderCurrentPage();
      };

      document.getElementById('btn-qr-loc').onclick = () => {
        askText('Posição (ex: A-FRENTE, D-MEIO):', '', (locId)=>{
          if(!/^[A-L]-(FUNDO|MEIO|FRENTE)$/i.test(locId)) { showToast('Posição inválida.', 'error'); return; }
          showPrintLabels([{ type:'location', location: locId }], `Etiqueta da posição ${locId}`);
        });
      };
      document.getElementById('btn-qr-prod').onclick = () => {
        askNumber('ID do produto para gerar QR:', 1, (pid)=>{
          const p = productList.find(pp => pp.id == pid);
          if(!p) { showToast('Produto não encontrado.', 'error'); return; }
          showPrintLabels([{ type:'product', productId: Number(pid) }], `Etiqueta do produto #${pid}`);
        }, true);
      };
    };

    // ======= HELPERS DE NEGÓCIO =======

    function addToInventory(productId, locationId, quantity) {
      const existing = inventory.find(i => i.productId === productId && i.locationId === locationId);
      if (existing) existing.quantity += quantity;
      else inventory.push({ productId, locationId, quantity });
    }

    function showMapCellModal(locationId, items) {
      const html = `
        <div class="p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold mb-3">Posição ${locationId}</h3>
            <div class="flex gap-2">
              <button id="btn-start-move" class="px-3 py-1.5 bg-yellow-500 text-black rounded-md font-semibold">Mover desta posição</button>
              <button id="btn-print-here" class="px-3 py-1.5 bg-gray-800 text-white rounded-md">Imprimir QR desta posição</button>
            </div>
          </div>
          ${items.length ? `
            <div class="space-y-2">
              ${items.map((e,i)=>{
                const p = productList.find(pp=>pp.id===e.productId);
                return `
                  <div class="border rounded-md p-3">
                    <div class="font-semibold">${p?.nomeCompleto||'#'+e.productId}</div>
                    <div class="text-sm text-gray-600">Caixas: <b>${e.quantity}</b></div>
                    <div class="flex gap-2 mt-2">
                      <button data-idx="${i}" class="btn-baixa bg-red-600 text-white px-2 py-1 rounded text-sm">Dar baixa</button>
                      <button data-idx="${i}" class="btn-mover bg-blue-600 text-white px-2 py-1 rounded text-sm">Mover</button>
                      <button data-pid="${e.productId}" class="btn-print-prod bg-gray-700 text-white px-2 py-1 rounded text-sm">Etiqueta Produto</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : `<div class="p-6 text-gray-500">Sem itens nesta posição.</div>`}
        </div>`;
      showModal(html);

      document.getElementById('btn-print-here').onclick = () => {
        showPrintLabels([{ type:'location', location: locationId }], `Etiqueta da posição ${locationId}`);
      };
      document.getElementById('btn-start-move').onclick = () => {
        moveOperation = { fromLocationId: locationId };
        closeModal();
        document.body.classList.add('move-mode-active');
        showToast('Selecione a posição de destino no mapa…', 'info');
      };

      document.querySelectorAll('.btn-baixa').forEach(btn=>{
        btn.onclick = () => {
          const idxLocal = Number(btn.dataset.idx);
          const entry = inventory.filter(i=>i.locationId===locationId)[idxLocal];
          const p = productList.find(pp=>pp.id===entry.productId);
          askNumber(`Quantidade para DAR BAIXA de <b>${p?.nomeCompleto||'#'+entry.productId}</b> em <b>${locationId}</b>:`, 1, (q)=>{
            if (q>entry.quantity) { showToast('Qtd maior que disponível.', 'error'); return; }
            entry.quantity -= q; if (entry.quantity===0) inventory = inventory.filter(x=>x!==entry);
            history.unshift({ date:new Date().toISOString(), type:'SAÍDA', details:`-${q} ${p?.nomeCompleto||'#'+entry.productId} de ${locationId}` });
            saveLocal(); persistInventory(); showToast('Saída concluída.', 'success'); closeModal(); rerenderCurrentPage();
          });
        };
      });
      document.querySelectorAll('.btn-mover').forEach(btn=>{
        btn.onclick = () => {
          moveOperation = { fromLocationId: locationId };
          closeModal();
          document.body.classList.add('move-mode-active');
          showToast('Agora clique na posição de destino…', 'info');
        };
      });
      document.querySelectorAll('.btn-print-prod').forEach(btn=>{
        btn.onclick = () => {
          const pid = Number(btn.dataset.pid);
          showPrintLabels([{ type:'product', productId: pid }], `Etiqueta produto #${pid}`);
        };
      });
    }

    function handleMoveSelection(destLocationId) {
      if (!moveOperation?.fromLocationId) return;
      const from = moveOperation.fromLocationId;
      if (from === destLocationId) {
        showToast('Selecione uma posição diferente.', 'warn'); return;
      }
      // escolher produto (se houver mais de um na origem)
      const entries = inventory.filter(i => i.locationId === from);
      if (entries.length === 0) {
        showToast('Origem vazia.', 'error'); moveOperation=null; document.body.classList.remove('move-mode-active'); rerenderCurrentPage(); return;
      }
      const pickHtml = `
        <div class="p-4">
          <h3 class="text-lg font-bold mb-3">Mover de <b>${from}</b> para <b>${destLocationId}</b></h3>
          <div class="space-y-2">
            ${entries.map(e=>{
              const p = productList.find(pp=>pp.id===e.productId);
              return `
                <div class="border rounded p-3">
                  <div class="font-semibold">${p?.nomeCompleto||'#'+e.productId}</div>
                  <div class="text-sm text-gray-600">Disponível: <b>${e.quantity}</b> caixas</div>
                  <button data-pid="${e.productId}" class="btn-pick-move mt-2 px-3 py-1.5 rounded bg-blue-600 text-white">Mover…</button>
                </div>`;
            }).join('')}
          </div>
        </div>`;
      showModal(pickHtml);
      document.querySelectorAll('.btn-pick-move').forEach(btn=>{
        btn.onclick = () => {
          const pid = Number(btn.dataset.pid);
          const entry = inventory.find(i => i.locationId===from && i.productId===pid);
          const p = productList.find(pp=>pp.id===pid);
          askNumber(`Quantidade para mover de <b>${from}</b> para <b>${destLocationId}</b> (<b>${p?.nomeCompleto||'#'+pid}</b>):`, 1, (q)=>{
            if (q>entry.quantity) { showToast('Qtd maior que disponível.', 'error'); return; }
            entry.quantity -= q;
            addToInventory(pid, destLocationId, q);
            if (entry.quantity===0) inventory = inventory.filter(x=>x!==entry);
            history.unshift({ date:new Date().toISOString(), type:'MOVIMENTAÇÃO', details:`${q} ${p?.nomeCompleto||'#'+pid} de ${from} → ${destLocationId}` });
            moveOperation = null; document.body.classList.remove('move-mode-active');
            saveLocal(); persistInventory(); showToast('Movido!', 'success'); closeModal(); rerenderCurrentPage();
          });
        };
      });
    }

    function showAddProductModal() {
      const nextId = (productList.reduce((m,p)=>Math.max(m,p.id||0),0) || 0) + 1;
      const html = `
        <div class="p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">Novo Produto</h3>
            <button onclick="document.getElementById('modal-container').className='hidden';document.getElementById('modal-container').innerHTML='';" class="text-gray-500 hover:text-gray-800">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
          </div>
          <form id="form-add-product" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div><label class="text-sm">ID</label><input id="p-id" type="number" value="${nextId}" class="mt-1 p-2 border rounded w-full"></div>
            <div><label class="text-sm">Modelo</label><input id="p-modelo" class="mt-1 p-2 border rounded w-full"></div>
            <div><label class="text-sm">Grade</label><input id="p-grade" class="mt-1 p-2 border rounded w-full"></div>
            <div><label class="text-sm">Material</label><input id="p-material" class="mt-1 p-2 border rounded w-full"></div>
            <div class="sm:col-span-2"><label class="text-sm">Variação / Cor</label><input id="p-variacao" class="mt-1 p-2 border rounded w-full"></div>
            <div class="sm:col-span-2 flex items-center gap-2 mt-2">
              <button class="px-4 py-2 bg-blue-600 text-white rounded-md" type="submit">Salvar</button>
              <button type="button" id="btn-qr-product" class="px-4 py-2 bg-gray-800 text-white rounded-md">Imprimir etiqueta</button>
            </div>
          </form>
        </div>`;
      showModal(html);

      document.getElementById('form-add-product').onsubmit = (e)=>{
        e.preventDefault();
        const id = Number(document.getElementById('p-id').value);
        const modelo = document.getElementById('p-modelo').value.trim();
        const grade = document.getElementById('p-grade').value.trim();
        const material = document.getElementById('p-material').value.trim();
        const variacao = document.getElementById('p-variacao').value.trim();
        if(!id || !modelo || !grade || !material || !variacao) { showToast('Preencha todos os campos.', 'error'); return; }
        if(productList.some(p=>p.id===id)) { showToast('ID já existe.', 'error'); return; }
        const novo = { id, modelo, grade, material, variacao, nomeCompleto: `${modelo} ${grade} ${material} ${variacao}` };
        productList.push(novo);
        saveLocal(); persistProducts();
        showToast('Produto salvo.', 'success');
        closeModal();
        rerenderCurrentPage();
      };

      document.getElementById('btn-qr-product').onclick = () => {
        const id = Number(document.getElementById('p-id').value);
        showPrintLabels([{ type:'product', productId: id }], `Etiqueta produto #${id}`);
      };
    }

    function askNumber(htmlLabel, minVal=1, onOk, allowAnyId=false) {
      const html = `
        <div class="p-4">
          <h3 class="text-lg font-bold mb-2">Informe o número</h3>
          <div class="text-sm mb-2">${htmlLabel}</div>
          <input id="ask-number-input" type="number" ${allowAnyId?'':'min="'+minVal+'"'} value="${minVal}" class="p-2 border rounded w-full mb-3">
          <div class="flex justify-end gap-2">
            <button class="px-3 py-2 rounded border" onclick="(${closeModal.toString()})()">Cancelar</button>
            <button id="ask-number-ok" class="px-3 py-2 rounded bg-blue-600 text-white">Confirmar</button>
          </div>
        </div>`;
      showModal(html);
      document.getElementById('ask-number-ok').onclick = () => {
        const v = Number(document.getElementById('ask-number-input').value);
        if (!allowAnyId && (!v || v < minVal)) { showToast('Número inválido.', 'error'); return; }
        closeModal();
        onOk(v);
      };
    }

    function askText(label, initial, onOk) {
      const html = `
        <div class="p-4">
          <h3 class="text-lg font-bold mb-2">Informe o texto</h3>
          <div class="text-sm mb-2">${label}</div>
          <input id="ask-text-input" type="text" value="${initial||''}" class="p-2 border rounded w-full mb-3">
          <div class="flex justify-end gap-2">
            <button class="px-3 py-2 rounded border" onclick="(${closeModal.toString()})()">Cancelar</button>
            <button id="ask-text-ok" class="px-3 py-2 rounded bg-blue-600 text-white">Confirmar</button>
          </div>
        </div>`;
      showModal(html);
      document.getElementById('ask-text-ok').onclick = () => {
        const v = String(document.getElementById('ask-text-input').value||'').trim();
        if (!v) { showToast('Valor vazio.', 'error'); return; }
        closeModal(); onOk(v);
      };
    }

    function showPrintLabels(payloads, title='Etiquetas') {
      const html = `
        <div class="p-4" id="printable-area">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">${title}</h3>
            <div class="flex gap-2">
              <button id="btn-download-png" class="px-3 py-1.5 rounded bg-gray-700 text-white">Baixar PNG</button>
              <button id="btn-print" class="px-3 py-1.5 rounded bg-blue-600 text-white">Imprimir</button>
            </div>
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="qr-grid"></div>
        </div>`;
      showModal(html);
      const grid = document.getElementById('qr-grid');
      grid.innerHTML = payloads.map((pl, idx) => `
        <div class="border rounded-lg p-3 flex flex-col items-center">
          <div id="qr-${idx}" class="mb-2"></div>
          <div class="text-xs text-center">${pl.type==='location' ? `POSIÇÃO: ${pl.location}` : `PRODUTO #${pl.productId}`}</div>
        </div>
      `).join('');

      payloads.forEach((pl, idx) => {
        const el = document.getElementById(`qr-${idx}`);
        const text = pl.type==='location' ? JSON.stringify({type:'location', location: pl.location}) : JSON.stringify({productId: pl.productId});
        new QRCode(el, { text, width: 140, height: 140 });
      });

      document.getElementById('btn-print').onclick = () => { window.print(); };
      document.getElementById('btn-download-png').onclick = () => {
        document.querySelectorAll('#qr-grid canvas').forEach((c, i) => {
          const a = document.createElement('a');
          a.href = c.toDataURL('image/png');
          a.download = `etiqueta_${i+1}.png`;
          a.click();
        });
      };
    }

    // ======= ROTEAMENTO =======
    window.addEventListener('hashchange', rerenderCurrentPage);

    // Inicial
    if (!location.hash) location.hash = '#home';
    rerenderCurrentPage();

    // Sincronização opcional periódica
    setInterval(() => { /* offline-first; opcional puxar */ }, 30000);

  }); // DOMContentLoaded
  </script>
</body>
</html>

                  
