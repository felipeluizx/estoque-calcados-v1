<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Estoque - Indústria de Calçados</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Scanner QR -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Gerador de QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
    .menu-item.active { background-color: #1d4ed8; color: white; }
    .modal-backdrop { background-color: rgba(0,0,0,0.5); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    select:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .map-card-position { transition: all 0.2s ease-in-out; }

    /* Estilos para o novo modo de movimentação */
    .move-mode-active .map-card-position {
        background-color: #cceeff;
        cursor: copy;
        animation: pulse-blue 1.5s infinite;
    }
     .move-mode-active .map-card-position.move-source {
        background-color: #fdd835;
        opacity: 1;
        cursor: not-allowed;
    }

    @keyframes pulse-blue {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }

    /* Estilo para a área de leitura do QR Code */
    #reader {
        position: relative;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }
    #reader__scan_region {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #reader__scan_region::after {
        content: '';
        position: absolute;
        width: 250px;
        height: 250px;
        border: 4px solid rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        box-shadow: 0 0 0 4000px rgba(0,0,0,0.4);
        animation: scan-glow 2s infinite ease-in-out;
    }
    @keyframes scan-glow {
        0%, 100% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.4), 0 0 10px 2px #4ade80; }
        50% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.4), 0 0 10px 2px #16a34a; }
    }
    
    @media print {
      body * {
        visibility: hidden;
      }
      #printable-area, #printable-area * {
        visibility: visible;
      }
      #printable-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      nav, aside, header, .modal-backdrop > div:not(#printable-area-container) {
          display: none !important;
      }
      .modal-backdrop {
        background-color: white !important;
        justify-content: flex-start;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body class="antialiased text-gray-800">

  <div id="app" class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar (desktop) -->
    <aside class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
      <div class="flex items-center justify-center h-16 border-b border-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
        <span class="ml-2 text-lg font-bold">Estoque Calçados</span>
      </div>
      <nav class="flex-1 px-2 py-4 space-y-2">
        <a href="#home" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard h-5 w-5 mr-3"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          Dashboard
        </a>
        <a href="#entrada" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-square h-5 w-5 mr-3 text-green-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          Entrada
        </a>
        <a href="#saida" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-square h-5 w-5 mr-3 text-red-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          Saída
        </a>
        <a href="#mapa" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map h-5 w-5 mr-3"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          Mapa do Estoque
        </a>
        <a href="#relatorios" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text h-5 w-5 mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          Relatórios
        </a>
        <a href="#historico" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history h-5 w-5 mr-3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
          Histórico
        </a>
        <a href="#admin" class="menu-item flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check h-5 w-5 mr-3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <div class="flex-1 flex flex-col">
      <!-- Mobile Header -->
      <header class="md:hidden flex items-center justify-between bg-gray-800 text-white p-4 shadow-md sticky top-0 z-10">
        <div class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
          <span id="header-title" class="ml-2 text-lg font-bold">Dashboard</span>
        </div>
        <a href="#admin" class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 text-white text-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Admin
        </a>
      </header>

      <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="page-home" class="page"></div>
        <div id="page-entrada" class="page hidden"></div>
        <div id="page-saida" class="page hidden"></div>
        <div id="page-mapa" class="page hidden"></div>
        <div id="page-produtos" class="page hidden"></div>
        <div id="page-relatorios" class="page hidden"></div>
        <div id="page-etiquetas" class="page hidden"></div>
        <div id="page-historico" class="page hidden"></div>
        <div id="page-admin" class="page hidden"></div>
      </main>

      <!-- Bottom Nav (mobile) -->
      <nav class="md:hidden grid grid-cols-5 gap-1 p-2 bg-gray-800 text-white border-t border-gray-700 sticky bottom-0">
        <a href="#home" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard h-6 w-6 mb-1"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          <span class="text-xs">Dashboard</span>
        </a>
        <a href="#entrada" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-square h-6 w-6 mb-1 text-green-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="m8 12 4 4 4-4"/></svg>
          <span class="text-xs">Entrada</span>
        </a>
        <a href="#saida" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-square h-6 w-6 mb-1 text-red-400"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 16V8"/><path d="m8 12 4-4 4 4"/></svg>
          <span class="text-xs">Saída</span>
        </a>
        <a href="#mapa" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map h-6 w-6 mb-1"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
          <span class="text-xs">Mapa</span>
        </a>
        <a href="#relatorios" class="menu-item flex flex-col items-center text-center p-2 rounded-lg">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text h-6 w-6 mb-1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
          <span class="text-xs">Relatórios</span>
        </a>
      </nav>
    </div>
  </div>

  <!-- Modals -->
  <div id="modal-container" class="hidden"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {

    // --- DADOS DO SISTEMA ---
    let productList = [];
    let inventory = [];
    let history = [];
    let isSyncing = false;

    // --- LÓGICA DE DADOS E SINCRONIZAÇÃO ---
    async function loadAllDataFromServer() {
        if (isSyncing) return;
        isSyncing = true;
        try {
            const [estoqueRes, produtosRes] = await Promise.all([
                fetch('/api/estoque'),
                fetch('/api/produtos')
            ]);

            if (!estoqueRes.ok) throw new Error(`HTTP error! status: ${estoqueRes.status}`);
            if (!produtosRes.ok) throw new Error(`HTTP error! status: ${produtosRes.status}`);
            
            const estoqueData = await estoqueRes.json();
            const produtosData = await produtosRes.json();

            const serverInventory = Array.isArray(estoqueData.inventory) ? estoqueData.inventory : [];
            const serverHistory = Array.isArray(estoqueData.history) ? estoqueData.history : [];
            const serverProducts = Array.isArray(produtosData) ? produtosData.map(p => ({ ...p, nomeCompleto: `${p.modelo} ${p.grade} ${p.material} ${p.variacao}` })) : [];

            if (JSON.stringify(inventory) !== JSON.stringify(serverInventory) || 
                JSON.stringify(history) !== JSON.stringify(serverHistory) ||
                JSON.stringify(productList) !== JSON.stringify(serverProducts)) {
                
                inventory = serverInventory;
                history = serverHistory;
                productList = serverProducts;
                
                rerenderCurrentPage();
            }
        } catch (error) {
            console.error("Falha ao buscar dados do servidor:", error);
            showToast('Erro de conexão ao buscar dados.', 'error');
        } finally {
            isSyncing = false;
        }
    }

    async function persistInventory() {
      try {
        const isReset = inventory.length === 0 && history[0]?.type === 'RESET';
        if (isReset) {
            const r = await fetch('/api/estoque?op=reset', { method: 'POST' });
            if (!r.ok) throw new Error('Falha ao resetar o estoque no servidor.');
            const d = await r.json();
            history = d.history || history;
            return;
        }
        
        const res = await fetch('/api/estoque', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inventory, history }),
        });
        if (!res.ok) throw new Error('Falha ao persistir inventário no servidor.');
      } catch (error) {
        console.error("Falha ao persistir inventário:", error);
        showToast('Erro de conexão ao salvar inventário.', 'error');
      }
    }

    async function persistProducts() {
        try {
            const res = await fetch('/api/produtos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productList.map(({nomeCompleto, ...rest}) => rest))
            });
            if (!res.ok) throw new Error('Falha ao salvar produtos no servidor.');
        } catch (error) {
            console.error("Falha ao persistir produtos:", error);
            showToast('Erro de conexão ao salvar produtos.', 'error');
        }
    }

    const mapLayout = { locations: ['A','B','C','D','E','F','G','H','I','J','K','L'], positions: ['FUNDO','MEIO','FRENTE'] };
    const adminPassword = '123';
    let adminAuthenticated = false;
    let lastVisitedHash = '#home';

    let moveOperation = null; 

    const pages = document.querySelectorAll('.page');
    const menuItems = document.querySelectorAll('.menu-item');
    const headerTitle = document.getElementById('header-title');

    // ======= SCANNER / QR =======
    let preselectedLocation = null;
    let activeScanner = null;

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === 'suspended') { ctx.resume(); }
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.connect(gain);
        gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime + 0.02);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.15);
      } catch (e) { console.error("Erro no 'beep':", e); }
    }

    function parseScannedPayload(text) {
      try {
        const j = JSON.parse(text);
        if(j.type === 'location' && j.location) return { type: 'location', location: j.location };
        if(j.productId) return { type: 'product', productId: j.productId };
      } catch(_) {
        const n = Number(text.trim());
        if (!Number.isNaN(n)) return { type: 'product', productId: n };
      }
      return { type: 'unknown' };
    }

    async function stopActiveScanner() {
        if (activeScanner && activeScanner.getState() === Html5QrcodeScannerState.SCANNING) {
            try { await activeScanner.stop(); } catch (err) { /* ignore */ }
        }
        activeScanner = null;
    }

    async function showGenericScanner(title, onSuccess) {
        const content = `
            <div class="p-4 relative">
            <button id="scan-close" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h3 class="text-lg font-bold mb-3 text-center">${title}</h3>
            <div id="reader" class="w-full"></div>
            <div id="scan-feedback" class="hidden mt-3 px-3 py-2 rounded-md bg-green-100 text-green-800 text-sm font-medium">Código lido! Processando...</div>
            <p class="text-xs text-gray-500 mt-3 text-center">Se solicitado, permita o acesso à câmera.</p>
            </div>`;
        showModal(content);

        let isHandlingScan = false;
        const onScanSuccessWrapper = (decodedText) => {
            if (isHandlingScan) return;
            isHandlingScan = true;
            document.getElementById('scan-feedback')?.classList.remove('hidden');
            beep();
            setTimeout(async () => {
                await stopActiveScanner();
                onSuccess(decodedText);
            }, 1500);
        };
        
        document.getElementById('scan-close').onclick = async () => {
            await stopActiveScanner();
            closeModal();
        };

        const html5Qrcode = new Html5Qrcode("reader");
        activeScanner = html5Qrcode;
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        try {
            const devices = await Html5Qrcode.getCameras();
            if (devices && devices.length) {
                const cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id;
                await html5Qrcode.start(
                    cameraId,
                    config,
                    onScanSuccessWrapper,
                    (errorMessage) => { /* ignore errors during scan */ }
                );
            } else {
                showToast('Nenhuma câmera encontrada.', 'error');
                closeModal();
            }
        } catch (err) {
            showToast(`Erro ao iniciar a câmera: ${err}`, 'error');
            console.error("Erro ao iniciar a câmera:", err);
            closeModal();
        }
    }

    // ======= FIM SCANNER =======

    const renderDashboard = () => {
      document.body.classList.remove('move-mode-active'); 
      moveOperation = null;
      const container = document.getElementById('page-home');
      const totalBoxes = inventory.reduce((s, i) => s + i.quantity, 0);
      const occupiedSlots = new Set(inventory.map(i => i.locationId)).size;
      const totalSlots = mapLayout.locations.length * mapLayout.positions.length;

      const productCounts = inventory.reduce((acc, i) => {
        const p = productList.find(pp => pp.id === i.productId);
        if (p) acc[p.modelo] = (acc[p.modelo] || 0) + i.quantity;
        return acc;
      }, {});
      const topProduct = Object.entries(productCounts).sort((a,b)=>b[1]-a[1])[0];

      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Caixas em Estoque</h3><p class="text-3xl font-bold mt-2">${totalBoxes.toLocaleString('pt-BR')}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Posições Ocupadas</h3><p class="text-3xl font-bold mt-2">${occupiedSlots} / ${totalSlots}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Modelo com Mais Estoque</h3><p class="text-2xl font-bold mt-2 truncate">${topProduct ? topProduct[0] : 'N/A'}</p><p class="text-gray-500">${topProduct ? `${topProduct[1].toLocaleString('pt-BR')} caixas` : ''}</p></div>
          <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500 text-sm font-medium">Produtos Cadastrados</h3><p class="text-3xl font-bold mt-2">${productList.length}</p></div>
        </div>
        <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
          <h3 class="text-xl font-bold mb-4">Movimentações Recentes</h3>
          <ul class="space-y-3">
            ${history.slice(0,5).map(h=>`
              <li class="flex items-start">
                <span class="text-sm text-gray-500 w-28">${new Date(h.date).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
                <span class="font-semibold ${h.type==='ENTRADA'?'text-green-600':h.type==='SAÍDA'?'text-red-600':h.type === 'MOVIMENTAÇÃO' ? 'text-blue-600':'text-yellow-500'}">${h.type}</span>
                <span class="ml-4 text-gray-700">${h.details}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    };

    const renderEntrada = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-entrada');
      const modelos = [...new Set(productList.map(p => p.modelo))].sort();
      
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6 text-green-700">Registrar Entrada</h1>
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="space-y-4">
                 <button type="button" id="entrada-scan-process-btn" class="w-full bg-gray-700 text-white hover:bg-gray-800 px-4 py-3 rounded-md text-lg font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-line"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                    Iniciar Entrada por Leitura
                </button>
                <div class="text-center text-gray-500">ou preencha manualmente:</div>
            </div>
            <form id="entrada-form" class="mt-4 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700">1. Modelo</label>
                <select id="entrada-modelo" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                <option value="" disabled selected>Selecione o modelo</option>
                ${modelos.map(m=>`<option value="${m}">${m}</option>`).join('')}
                </select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">2. Grade</label>
                <select id="entrada-grade" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">3. Material</label>
                <select id="entrada-material" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div><label class="block text-sm font-medium text-gray-700">4. Variação / Cor</label>
                <select id="entrada-variacao" required disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="">--</option></select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">5. Quantidade</label>
                <input type="number" id="entrada-quantidade" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div><label class="block text-sm font-medium text-gray-700">6. Localização</label>
                <select id="entrada-location" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option value="" disabled selected>Selecione a posição</option>
                    ${mapLayout.locations.flatMap(loc => mapLayout.positions.map(pos => `${loc}-${pos}`)).map(l => `<option value="${l}">${l}</option>`).join('')}
                </select>
                </div>
            </div>
            <button type="submit" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 font-bold text-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle h-6 w-6 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                Confirmar Entrada Manual
            </button>
            </form>
        </div>
      `;
      setupEntradaFormListeners();
    };

    const renderSaida = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-saida');
      if (!inventory.length) {
        container.innerHTML = `
          <h1 class="text-3xl font-bold mb-6 text-red-700">Registrar Saída</h1>
          <div class="bg-white p-6 rounded-lg shadow-md text-center"><p class="text-gray-600">Não há itens no estoque para registrar saída.</p></div>
        `;
        return;
      }
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6 text-red-700">Registrar Saída</h1>
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="space-y-4">
                 <button type="button" id="saida-scan-process-btn" class="w-full bg-gray-700 text-white hover:bg-gray-800 px-4 py-3 rounded-md text-lg font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scan-line"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                    Iniciar Saída por Leitura
                </button>
                <div class="text-center text-gray-500">ou preencha manually:</div>
            </div>
            <form id="saida-form" class="mt-4 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">1. Item em Estoque</label>
                <select id="saida-item" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                  <option value="" disabled selected>Selecione um item para dar baixa</option>
                  ${
                    inventory.map((it, idx) => {
                      const p = productList.find(pp=>pp.id===it.productId);
                      return { idx, locationId: it.locationId, label: `(${it.locationId}) ${p?.nomeCompleto || 'Produto desconhecido'} - ${it.quantity} caixas` };
                    })
                    .sort((a,b)=>a.locationId.localeCompare(b.locationId))
                    .map(r=>`<option value="${r.idx}">${r.label}</option>`).join('')
                  }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">2. Quantidade a Retirar</label>
                <input type="number" id="saida-quantidade" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Máx: 0">
              </div>
              <button type="submit" class="w-full bg-red-600 text-white px-4 py-3 rounded-md hover:bg-red-700 font-bold text-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 mr-2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>
                Confirmar Saída Manual
              </button>
            </form>
        </div>
      `;
      setupSaidaFormListeners();
    };

    const renderMap = () => {
      const container = document.getElementById('page-mapa');
      const locationsHtml = mapLayout.locations.map(loc => {
        const positionsHtml = mapLayout.positions.map(pos => {
          const positionId = `${loc}-${pos}`;
          const itemsInPosition = inventory.filter(i => i.locationId === positionId);
          const qtyInPosition = itemsInPosition.reduce((sum, item) => sum + item.quantity, 0);
          const hasItems = qtyInPosition > 0;
          let positionClass = hasItems ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
          
          return `
            <div id="map-cell-${positionId}" data-location-id="${positionId}" class="map-card-position cursor-pointer p-3 rounded-md font-semibold ${positionClass}">
              ${pos} ${qtyInPosition > 0 ? `(${qtyInPosition})` : ''}
            </div>
          `;
        }).join('');
    
        return `
          <div class="bg-white rounded-lg shadow-md p-2 flex flex-col gap-2 text-center select-none">
            <div class="font-bold text-gray-700 border-b pb-1 text-lg">${loc}</div>
            ${positionsHtml}
          </div>
        `;
      }).join('');
    
      container.innerHTML = `
          <h1 class="text-3xl font-bold mb-2">Mapa do Estoque</h1>
          <p class="text-gray-600 mb-6">Clique em uma posição para ver detalhes ou use a busca para encontrar um produto.</p>
          <div class="mb-4">
               <input type="text" id="map-search" placeholder="Buscar produto no mapa..." class="w-full max-w-md p-2 border rounded-md">
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
              ${locationsHtml}
          </div>
      `;
      document.querySelectorAll('.map-card-position').forEach(cell => {
          cell.addEventListener('click', () => {
              const locationId = cell.dataset.locationId;
              
              if(moveOperation) {
                  handleMoveSelection(locationId);
              } else {
                  const items = inventory.filter(i => i.locationId === locationId);
                  showMapCellModal(locationId, items);
              }
          });
      });
      document.getElementById('map-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('.map-card-position').forEach(cell => {
              cell.parentElement.classList.remove('opacity-25');
              cell.classList.remove('ring-4', 'ring-yellow-400');
              
              const parentCard = cell.parentElement;
              const hasMatchInCard = Array.from(parentCard.querySelectorAll('.map-card-position')).some(pos => {
                  const locationId = pos.dataset.locationId;
                  const itemsInPos = inventory.filter(i => i.locationId === locationId);
                  return itemsInPos.some(item => {
                    const product = productList.find(p => p.id === item.productId);
                    return product && product.nomeCompleto.toLowerCase().includes(searchTerm);
                  });
              });
    
              if (searchTerm && !hasMatchInCard) {
                  parentCard.classList.add('opacity-25');
              } else if (searchTerm && hasMatchInCard) {
                  const locationId = cell.dataset.locationId;
                  const items = inventory.filter(i => i.locationId === locationId);
                  const cellHasMatch = items.some(item => {
                      const product = productList.find(p => p.id === item.productId);
                      return product && product.nomeCompleto.toLowerCase().includes(searchTerm);
                  });
                  if (cellHasMatch) {
                    cell.classList.add('ring-4', 'ring-yellow-400');
                  }
              }
          });
      });
    };
     
    const renderProdutos = () => {
        const container = document.getElementById('page-produtos');
        container.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold">Gestão de Produtos</h1>
                <div class="flex gap-2">
                    <button id="print-products-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 font-semibold flex items-center gap-2 disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                        Imprimir/Baixar
                    </button>
                    <button id="add-product-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                        Novo Produto
                    </button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left"><input type="checkbox" id="select-all-products"></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variação/Cor</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${productList.sort((a,b) => a.id - b.id).map(p => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap"><input type="checkbox" class="product-checkbox" data-product-id="${p.id}"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.id}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.modelo}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.grade}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.material}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.variacao}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        document.getElementById('add-product-btn').addEventListener('click', showAddProductModal);
        
        const printBtn = document.getElementById('print-products-btn');
        const selectAllCheckbox = document.getElementById('select-all-products');
        const checkboxes = document.querySelectorAll('.product-checkbox');

        const togglePrintButton = () => {
            const anyChecked = [...checkboxes].some(c => c.checked);
            printBtn.disabled = !anyChecked;
        };

        selectAllCheckbox.addEventListener('change', (e) => {
            checkboxes.forEach(c => c.checked = e.target.checked);
            togglePrintButton();
        });

        checkboxes.forEach(c => c.addEventListener('change', togglePrintButton));
        
        printBtn.addEventListener('click', () => {
            const selectedIds = [...checkboxes].filter(c => c.checked).map(c => parseInt(c.dataset.productId));
            const selectedProducts = productList.filter(p => selectedIds.includes(p.id));
            showPrintProductsModal(selectedProducts);
        });
    };

    const populateSelect = (elementId, options, selectedValues) => {
      const select = document.getElementById(elementId);
      select.innerHTML = options.map(opt => 
        `<option value="${opt}" ${selectedValues.includes(opt) ? 'selected' : ''}>${opt}</option>`
      ).join('');
    };

    const updateReportFilters = () => {
      const getSelectedValues = (id) => Array.from(document.getElementById(id).selectedOptions).map(opt => opt.value);

      const selectedModelos = getSelectedValues('filter-modelo');
      const selectedGrades = getSelectedValues('filter-grade');
      const selectedMateriais = getSelectedValues('filter-material');
      const selectedVariacoes = getSelectedValues('filter-variacao');

      let listForGrades = productList;
      if(selectedModelos.length) listForGrades = listForGrades.filter(p => selectedModelos.includes(p.modelo));
      const availableGrades = [...new Set(listForGrades.map(p => p.grade))].sort();

      let listForMateriais = listForGrades;
      if(selectedGrades.length) listForMateriais = listForMateriais.filter(p => selectedGrades.includes(p.grade));
      const availableMateriais = [...new Set(listForMateriais.map(p => p.material))].sort();

      let listForVariacoes = listForMateriais;
      if(selectedMateriais.length) listForVariacoes = listForVariacoes.filter(p => selectedMateriais.includes(p.material));
      const availableVariacoes = [...new Set(listForVariacoes.map(p => p.variacao))].sort();
      
      const availableModelos = [...new Set(productList.map(p => p.modelo))].sort();

      populateSelect('filter-modelo', availableModelos, selectedModelos);
      populateSelect('filter-grade', availableGrades, selectedGrades);
      populateSelect('filter-material', availableMateriais, selectedMateriais);
      populateSelect('filter-variacao', availableVariacoes, selectedVariacoes);
    };

    const getFilteredReportRows = () => {
      const getSelectedValues = (elementId) => Array.from(document.getElementById(elementId).selectedOptions).map(option => option.value);
      const modelosSel = getSelectedValues('filter-modelo');
      const gradesSel = getSelectedValues('filter-grade');
      const materiaisSel = getSelectedValues('filter-material');
      const variacoesSel = getSelectedValues('filter-variacao');
      
      let rows = inventory.map(i => ({ ...i, product: productList.find(p => p.id === i.productId) }));
      
      if (modelosSel.length > 0) rows = rows.filter(r => r.product && modelosSel.includes(r.product.modelo));
      if (gradesSel.length > 0) rows = rows.filter(r => r.product && gradesSel.includes(r.product.grade));
      if (materiaisSel.length > 0) rows = rows.filter(r => r.product && materiaisSel.includes(r.product.material));
      if (variacoesSel.length > 0) rows = rows.filter(r => r.product && variacoesSel.includes(r.product.variacao));

      return rows.filter(r => r.product);
    };

    const generateSummaryReport = () => {
      const rows = getFilteredReportRows();
      const result = document.getElementById('report-result');
      const printBtn = document.getElementById('print-report-btn');
      const exportBtn = document.getElementById('export-csv-btn');

      if (!rows.length) {
        result.innerHTML = `<p class="text-gray-600 mt-4">Nenhum item encontrado com os filtros selecionados.</p>`;
        printBtn.disabled = true;
        exportBtn.disabled = true;
        return;
      }

      const summary = rows.reduce((acc, item) => {
        if (!acc[item.productId]) {
          acc[item.productId] = {
            product: item.product,
            totalQuantity: 0,
          };
        }
        acc[item.productId].totalQuantity += item.quantity;
        return acc;
      }, {});

      const summaryRows = Object.values(summary).sort((a, b) => a.product.nomeCompleto.localeCompare(b.product.nomeCompleto));

      result.innerHTML = `
        <h3 class="text-xl font-semibold mb-2">Relatório Quantitativo</h3>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full divide-y divide-gray-200" id="report-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade Total</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${summaryRows.map(r => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${r.product.nomeCompleto}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${r.totalQuantity} caixas</td>
                  </tr>`).join('')
              }
            </tbody>
          </table>
        </div>
      `;
      printBtn.disabled = false;
      exportBtn.disabled = false;
    };

    const generateDetailedReport = () => {
      const rows = getFilteredReportRows();
      const result = document.getElementById('report-result');
      const printBtn = document.getElementById('print-report-btn');
      const exportBtn = document.getElementById('export-csv-btn');
      
      if (!rows.length) {
        result.innerHTML = `<p class="text-gray-600 mt-4">Nenhum item encontrado com os filtros selecionados.</p>`;
        printBtn.disabled = true;
        exportBtn.disabled = true;
        return;
      }

      result.innerHTML = `
        <h3 class="text-xl font-semibold mb-2">Relatório Detalhado</h3>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full divide-y divide-gray-200" id="report-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localização</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${rows.sort((a,b)=>a.product.nomeCompleto.localeCompare(b.product.nomeCompleto)).map(r=>`
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${r.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.locationId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${r.product.nomeCompleto}</td>
                  </tr>`).join('')
              }
            </tbody>
          </table>
        </div>
      `;
      printBtn.disabled = false;
      exportBtn.disabled = false;
    };

    const renderReports = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-relatorios');

      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Gerador de Relatórios</h1>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> 
            <div>
                <label class="block text-sm font-medium text-gray-700">Modelo</label>
                <select id="filter-modelo" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                <p class="text-xs text-gray-500 mt-1">Use Ctrl/Cmd para múltiplos.</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Grade</label>
                <select id="filter-grade" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Material</label>
                <select id="filter-material" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Variação / Cor</label>
                <select id="filter-variacao" multiple size="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
            </div>
          </div>
          <div class="flex flex-col md:flex-row gap-3">
            <button id="generate-summary-report-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold">Gerar Quantitativo</button>
            <button id="generate-detailed-report-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 font-semibold">Gerar Detalhado (com Local)</button>
            <button id="print-report-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed font-semibold" disabled>Imprimir</button>
            <button id="export-csv-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed font-semibold" disabled>Exportar CSV</button>
          </div>
          <div id="report-result" class="mt-6"></div>
        </div>
      `;

      document.getElementById('filter-modelo').addEventListener('change', updateReportFilters);
      document.getElementById('filter-grade').addEventListener('change', updateReportFilters);
      document.getElementById('filter-material').addEventListener('change', updateReportFilters);
      document.getElementById('filter-variacao').addEventListener('change', updateReportFilters);

      document.getElementById('generate-summary-report-btn').addEventListener('click', generateSummaryReport);
      document.getElementById('generate-detailed-report-btn').addEventListener('click', generateDetailedReport);
      document.getElementById('print-report-btn').addEventListener('click', handlePrintReport);
      document.getElementById('export-csv-btn').addEventListener('click', handleExportCSV);
      
      updateReportFilters();
    };

    const renderEtiquetas = () => {
        const container = document.getElementById('page-etiquetas');
        const locationsHtml = mapLayout.locations.map(loc => `
            <div class="bg-white rounded-lg shadow-md p-4 flex flex-col items-center gap-2 text-center break-inside-avoid">
                <div class="font-bold text-gray-800 text-2xl">POSIÇÃO ${loc}</div>
                <div id="qr-code-${loc}" class="p-2 border rounded-md"></div>
            </div>
        `).join('');

        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Etiquetas de Posição</h1>
                <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                    Imprimir Etiquetas
                </button>
            </div>
            <p class="text-gray-600 mb-6">Imprima esta página e cole os QR Codes em suas respectivas prateleiras.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="printable-area">
                ${locationsHtml}
            </div>
        `;

        mapLayout.locations.forEach(loc => {
            new QRCode(document.getElementById(`qr-code-${loc}`), {
                text: JSON.stringify({ type: "location", location: loc }),
                width: 128,
                height: 128,
            });
        });
    };

    const renderHistory = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-historico');
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Histórico de Movimentações</h1>
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <ul class="divide-y divide-gray-200">
            ${history.map(h=>`
              <li class="p-4">
                <div class="flex items-center justify-between">
                   <span class="font-semibold text-lg ${h.type==='ENTRADA'?'text-green-600':h.type==='SAÍDA'?'text-red-600':h.type === 'MOVIMENTAÇÃO' ? 'text-blue-600':'text-yellow-500'}">${h.type}</span>
                  <span class="text-sm text-gray-500">${new Date(h.date).toLocaleString('pt-BR')}</span>
                </div>
                <p class="mt-2 text-gray-700">${h.details}</p>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    };
  
    const renderAdmin = () => {
      document.body.classList.remove('move-mode-active');
      moveOperation = null;
      const container = document.getElementById('page-admin');
      if (!adminAuthenticated) { 
          showAdminLoginModal(); 
          container.innerHTML = `<p class="text-center text-gray-600">Por favor, autentique-se para acessar o painel de administração.</p>`; 
          return; 
      }
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-6">Painel de Administração</h1>
        <div class="space-y-6">

          <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <h2 class="text-xl font-bold mb-3">Gestão</h2>
            <div class="flex flex-wrap gap-3">
                <a href="#produtos" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-plus h-5 w-5"><path d="M16.5 9.4a4 4 0 1 1-8 0"/><path d="M12 15H6a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-3.5"/><path d="M15 6h6"/><path d="M18 3v6"/></svg>
                    Gerenciar Produtos
                </a>
                <a href="#etiquetas" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-qr-code h-5 w-5"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>
                    Imprimir Etiquetas de Posição
                </a>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
            <h2 class="text-xl font-bold mb-2">Ações Reversíveis</h2>
            <p class="text-gray-600 mb-4">Cuidado: afeta o histórico.</p>
            <button id="undo-last-action-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 ${history.length ? '' : 'opacity-50 cursor-not-allowed'}" ${history.length ? '' : 'disabled'}>Desfazer Última Ação</button>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
            <h2 class="text-xl font-bold mb-2">Ações Perigosas</h2>
            <p class="text-gray-600 mb-4">Irreversíveis e apagam dados permanentemente.</p>
            <button id="reset-stock-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Resetar Estoque Completo</button>
          </div>
        </div>
      `;
      document.getElementById('undo-last-action-btn')?.addEventListener('click', handleUndoLastAction);
      document.getElementById('reset-stock-btn')?.addEventListener('click', handleResetStock);
    };

    function setupEntradaFormListeners() {
      document.getElementById('entrada-scan-process-btn').addEventListener('click', () => startScanWorkflow('ENTRADA'));
      const modeloSelect = document.getElementById('entrada-modelo');
      const gradeSelect = document.getElementById('entrada-grade');
      const materialSelect = document.getElementById('entrada-material');
      const variacaoSelect = document.getElementById('entrada-variacao');
      const locationSelect = document.getElementById('entrada-location');

      if (preselectedLocation) {
        locationSelect.value = preselectedLocation;
        preselectedLocation = null;
      }
      
      const resetSelect = (el, ph='--') => { el.innerHTML = `<option value="">${ph}</option>`; el.disabled = true; };

      modeloSelect.addEventListener('change', () => {
        resetSelect(gradeSelect,'Selecione a grade'); resetSelect(materialSelect); resetSelect(variacaoSelect);
        const grades = [...new Set(productList.filter(p => p.modelo === modeloSelect.value).map(p => p.grade))];
        gradeSelect.innerHTML = `<option value="" disabled selected>Selecione a grade</option>` + grades.sort().map(g=>`<option value="${g}">${g}</option>`).join('');
        gradeSelect.disabled = false;
      });
      gradeSelect.addEventListener('change', () => {
        resetSelect(materialSelect,'Selecione o material'); resetSelect(variacaoSelect);
        const mats = [...new Set(productList.filter(p => p.modelo === modeloSelect.value && p.grade === gradeSelect.value).map(p => p.material))];
        materialSelect.innerHTML = `<option value="" disabled selected>Selecione o material</option>` + mats.sort().map(m=>`<option value="${m}">${m}</option>`).join('');
        materialSelect.disabled = false;
      });
      materialSelect.addEventListener('change', () => {
        resetSelect(variacaoSelect,'Selecione a variação');
        const vars = [...new Set(productList.filter(p => p.modelo === modeloSelect.value && p.grade === gradeSelect.value && p.material === materialSelect.value).map(p => p.variacao))];
        variacaoSelect.innerHTML = `<option value="" disabled selected>Selecione a variação</option>` + vars.sort().map(v=>`<option value="${v}">${v}</option>`).join('');
        variacaoSelect.disabled = false;
      });

      document.getElementById('entrada-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const modelo = modeloSelect.value;
        const grade = gradeSelect.value;
        const material = materialSelect.value;
        const variacao = variacaoSelect.value;
        const qty = parseInt(document.getElementById('entrada-quantidade').value);
        const location = locationSelect.value;

        const product = productList.find(p => p.modelo===modelo && p.grade===grade && p.material===material && p.variacao===variacao);
        if (!product || !qty || !location) return showToast('Preencha todos os campos.', 'error');

        await registerEntry(product, qty, location);
      });
    }

    function setupSaidaFormListeners() {
      document.getElementById('saida-scan-process-btn').addEventListener('click', () => startScanWorkflow('SAIDA'));
      const itemSelect = document.getElementById('saida-item');
      const qtdInput = document.getElementById('saida-quantidade');

      const setMax = () => {
        const idx = parseInt(itemSelect.value);
        if (Number.isNaN(idx)) { qtdInput.placeholder='Máx: 0'; qtdInput.max=0; return; }
        const it = inventory[idx]; if (it) { qtdInput.placeholder=`Máx: ${it.quantity}`; qtdInput.max=it.quantity; }
      };
      itemSelect.addEventListener('change', setMax); setMax();

      document.getElementById('saida-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await registerExit(parseInt(itemSelect.value), parseInt(qtdInput.value));
      });
    }

    const addHistory = (type, details) => {
        history.unshift({ date: new Date().toISOString(), type, details });
    };
    
    const handlePrintReport = () => {
        const tableHtml = document.getElementById('report-table')?.outerHTML;
        if (!tableHtml) return;
        const content = `<div id="printable-area">${tableHtml}</div>`;
        const modalContent = document.getElementById('modal-content');
        if (modalContent) modalContent.innerHTML = content;
        else showModal(content);
        window.print();
    };

    const handleExportCSV = () => {
        const table = document.getElementById('report-table');
        if (!table) return;
        let csv = [];
        const rows = table.querySelectorAll('tr');
        for (const row of rows) {
            const cols = row.querySelectorAll('td, th');
            const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
            csv.push(rowData.join(','));
        }
        const csvFile = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(csvFile);
        link.download = `relatorio-estoque-${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
    };

    const handleUndoLastAction = () => {
      showCustomConfirm('Tem certeza que deseja desfazer a última ação? Esta operação não pode ser revertida.', async () => {
        if (history.length > 1) { 
            history.shift();
            await persistInventory();
            showToast(`Última ação foi desfeita (no histórico).`);
            rerenderCurrentPage();
        }
      });
    };

   const handleResetStock = () => {
      showCustomConfirm('ATENÇÃO! Apagar TODO o estoque é IRREVERSÍVEL.', () => {
        showCustomConfirm('CONFIRMAÇÃO FINAL: Apagar todo o estoque e histórico?', async () => {
          inventory = [];
          addHistory('RESET', 'O estoque foi completamente zerado.');
          await persistInventory();
          showToast('Estoque resetado com sucesso.', 'error');
          rerenderCurrentPage();
        });
      });
    };


    const showModal = (content, maxWidth = 'max-w-md') => {
      const mc = document.getElementById('modal-container');
      mc.innerHTML = `<div class="modal-backdrop fixed inset-0 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full ${maxWidth} max-h-full overflow-y-auto relative" id="modal-content">${content}</div>
      </div>`;
      mc.classList.remove('hidden');
      mc.querySelector('.modal-backdrop').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    };

    const closeModal = async () => {
        await stopActiveScanner();
        const mc = document.getElementById('modal-container');
        mc.classList.add('hidden');
        mc.innerHTML = '';
    };

    const showMapCellModal = (locationId, items) => {
        const hasItems = items && items.length > 0;

        const itemsHtml = hasItems ? `
            <ul class="divide-y divide-gray-200 -mx-6 px-6 mb-4 max-h-60 overflow-y-auto">
                ${items.map((item) => {
                    const product = productList.find(p => p.id === item.productId);
                    const inventoryIndex = inventory.findIndex(invItem => invItem.locationId === locationId && invItem.productId === item.productId);
                    return `<li class="py-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${product?.nomeCompleto || 'Produto desconhecido'}</p>
                                <p class="text-sm text-gray-600"><strong>Quantidade:</strong> ${item.quantity} caixas</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-inventory-index="${inventoryIndex}" class="exit-item-btn bg-red-100 text-red-800 hover:bg-red-200 px-3 py-1 rounded-md text-sm font-semibold">Saída</button>
                                <button data-inventory-index="${inventoryIndex}" class="move-item-btn bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-1 rounded-md text-sm font-semibold">Mover</button>
                            </div>
                        </div>
                    </li>`;
                }).join('')}
            </ul>` : '<p class="text-gray-600 mb-4">Esta posição está livre.</p>';

        const content = `
            <div class="p-6">
                <div class="flex justify-between items-start">
                     <h2 class="text-2xl font-bold mb-4">Posição: ${locationId}</h2>
                     <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 -mt-2 -mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                     </button>
                </div>
                ${itemsHtml}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 border-t pt-4 -mx-6 px-6">
                    <button id="map-add-here" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Adicionar aqui</button>
                    <button id="map-scan-here" class="w-full bg-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-800">Ler e Adicionar</button>
                </div>
            </div>`;
        
        showModal(content);

        document.querySelectorAll('.move-item-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const inventoryIndex = parseInt(btn.dataset.inventoryIndex);
                if(inventoryIndex < 0 || inventoryIndex >= inventory.length) return;
                const itemToMove = inventory[inventoryIndex];
                enterMoveMode(itemToMove);
            });
        });

        document.querySelectorAll('.exit-item-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const inventoryIndex = parseInt(btn.dataset.inventoryIndex);
                showExitFromMapModal(inventoryIndex);
            });
        });

        document.getElementById('map-add-here')?.addEventListener('click', () => {
            preselectedLocation = locationId;
            closeModal();
            goTo('#entrada');
        });
        
        document.getElementById('map-scan-here')?.addEventListener('click', async () => {
            await closeModal();
            startScanWorkflow('ENTRADA', { location: locationId.split('-')[0] });
        });
    };

    function enterMoveMode(itemToMove) {
        moveOperation = { itemToMove };
        closeModal();
        document.body.classList.add('move-mode-active');
        document.getElementById(`map-cell-${itemToMove.locationId}`).classList.add('move-source');
        showToast('Modo de Movimentação: Selecione o destino.', 'info');
    }

    function handleMoveSelection(destinationLocationId) {
        if (!moveOperation) return;
        const { itemToMove } = moveOperation;

        if (destinationLocationId === itemToMove.locationId) {
            showToast('Origem e destino não podem ser os mesmos.', 'error');
            return;
        }
        
        const product = productList.find(p => p.id === itemToMove.productId);

        const content = `
            <div class="p-6">
                <h3 class="text-xl font-bold mb-2">Confirmar Movimentação</h3>
                <p class="text-sm text-gray-500 mb-1">De: <strong>${itemToMove.locationId}</strong></p>
                <p class="text-sm text-gray-500 mb-4">Para: <strong>${destinationLocationId}</strong></p>
                <p class="mb-4">${product?.nomeCompleto || 'Produto desconhecido'}</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade a Mover</label>
                    <input type="number" id="move-quantity" value="${itemToMove.quantity}" min="1" max="${itemToMove.quantity}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button id="move-cancel" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button id="move-confirm" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Confirmar</button>
                </div>
            </div>`;
        showModal(content);

        document.getElementById('move-confirm').onclick = async () => {
            const quantityToMove = parseInt(document.getElementById('move-quantity').value);
            await executeMove(destinationLocationId, quantityToMove);
        };
        document.getElementById('move-cancel').onclick = () => {
            document.body.classList.remove('move-mode-active');
            moveOperation = null;
            closeModal();
            rerenderCurrentPage();
        };
    }
    
    async function executeMove(destinationLocationId, quantityToMove) {
        const { itemToMove } = moveOperation;
        const product = productList.find(p => p.id === itemToMove.productId);

        if (quantityToMove <= 0 || quantityToMove > itemToMove.quantity) {
            showToast('Quantidade inválida.', 'error'); return;
        }

        const sourceItemIndex = inventory.findIndex(i => i.locationId === itemToMove.locationId && i.productId === itemToMove.productId);
        if(sourceItemIndex === -1) {
            showToast('Erro: item de origem não encontrado.', 'error'); return;
        }

        if (inventory[sourceItemIndex].quantity === quantityToMove) {
            inventory.splice(sourceItemIndex, 1);
        } else {
            inventory[sourceItemIndex].quantity -= quantityToMove;
        }

        const destItemIndex = inventory.findIndex(i => i.locationId === destinationLocationId && i.productId === itemToMove.productId);
        if (destItemIndex > -1) {
            inventory[destItemIndex].quantity += quantityToMove;
        } else {
            inventory.push({ locationId: destinationLocationId, productId: itemToMove.productId, quantity: quantityToMove });
        }

        addHistory('MOVIMENTAÇÃO', `${quantityToMove} cx de ${product?.nomeCompleto || 'Produto desconhecido'} de ${itemToMove.locationId} → ${destinationLocationId}`);
        await persistInventory();
        
        showToast('Item movido com sucesso!');
        document.body.classList.remove('move-mode-active');
        moveOperation = null;
        closeModal();
        rerenderCurrentPage();
    }

    async function registerEntry(product, quantity, locationId) {
        if (!product || !quantity || !locationId) return;
        
        const existingItemIndex = inventory.findIndex(item => item.locationId === locationId && item.productId === product.id);

        if (existingItemIndex > -1) {
            inventory[existingItemIndex].quantity += quantity;
        } else {
            inventory.push({ locationId: locationId, productId: product.id, quantity: quantity });
        }

        addHistory('ENTRADA', `+${quantity} caixas de ${product.nomeCompleto} em ${locationId}`);
        await persistInventory();
        showToast('Entrada registrada com sucesso!');
        preselectedLocation = null;
        if(window.location.hash !== '#mapa') goTo('#mapa');
        else rerenderCurrentPage();
    }
    
    async function registerExit(inventoryIndex, quantityToRemove) {
        if (inventoryIndex === null || isNaN(inventoryIndex) || !inventory[inventoryIndex] || isNaN(quantityToRemove) || quantityToRemove <= 0) {
            showToast('Dados de saída inválidos.', 'error');
            return;
        }

        const item = inventory[inventoryIndex];
        const product = productList.find(p => p.id === item.productId);

        if (quantityToRemove > item.quantity) {
            showToast('A quantidade de saída não pode ser maior que a em estoque.', 'error');
            return;
        }

        if (quantityToRemove === item.quantity) {
            inventory.splice(inventoryIndex, 1);
        } else {
            item.quantity -= quantityToRemove;
        }
        
        addHistory('SAÍDA', `-${quantityToRemove} caixas de ${product?.nomeCompleto || 'Produto desconhecido'} de ${item.locationId}`);
        await persistInventory();
        showToast('Saída registrada com sucesso!');
        goTo('#mapa');
    }

    function startScanWorkflow(operation, initialState = {}) {
        let state = {
            operation,
            product: initialState.product || null,
            location: initialState.location || null,
        };

        const processScan = (decodedText) => {
            const payload = parseScannedPayload(decodedText);
            
            if (payload.type === 'product' && !state.product) {
                const product = productList.find(p => p.id === payload.productId);
                if (product) {
                    state.product = product;
                } else {
                    showToast('Produto não encontrado.', 'error');
                }
            } else if (payload.type === 'location' && !state.location) {
                state.location = payload.location;
            } else {
                showToast('Código inválido ou já escaneado.', 'error');
            }
            runStateMachine();
        };

        const runStateMachine = () => {
            closeModal().then(() => {
                if (state.product && state.location) {
                    showFinalModal();
                } else if (!state.product) {
                    showGenericScanner('Leia o código do PRODUTO', processScan);
                } else { // Implies !state.location
                    showGenericScanner('Leia o código da POSIÇÃO (A, B...)', processScan);
                }
            });
        };

        const showFinalModal = () => {
            if (state.operation === 'ENTRADA') {
                showEntryFinalModal(state.product, state.location);
            } else if (state.operation === 'SAIDA') {
                showExitFinalModal(state.product, state.location);
            }
        };

        runStateMachine();
    }
    
    function showEntryFinalModal(product, baseLocation) {
        const content = `
            <form id="scan-final-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Confirmar Entrada</h3>
                <div class="bg-gray-100 p-3 rounded-md">
                    <p class="font-semibold">${product.nomeCompleto}</p>
                    <p class="text-sm text-gray-600">Em Posição: ${baseLocation}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Posição Detalhada</label>
                    <div id="scan-final-position-buttons" class="mt-2 grid grid-cols-3 gap-2">
                        ${mapLayout.positions.map((p, index) => `
                            <button type="button" data-position="${p}" class="position-selector-btn p-3 rounded-md border-2 font-semibold transition-colors ${index === 0 ? 'border-blue-500 bg-blue-100 text-blue-800' : 'border-gray-200 bg-gray-50 text-gray-600 hover:bg-gray-100'}">${p}</button>
                        `).join('')}
                    </div>
                    <input type="hidden" id="scan-final-position" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="scan-final-quantity" value="1" min="1" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700">Confirmar</button>
                </div>
            </form>
        `;
        showModal(content);
        
        const positionButtons = document.querySelectorAll('.position-selector-btn');
        const hiddenPositionInput = document.getElementById('scan-final-position');

        hiddenPositionInput.value = positionButtons[0].dataset.position;

        positionButtons.forEach(button => {
            button.addEventListener('click', () => {
                hiddenPositionInput.value = button.dataset.position;
                positionButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-100', 'text-blue-800');
                    btn.classList.add('border-gray-200', 'bg-gray-50', 'text-gray-600', 'hover:bg-gray-100');
                });
                button.classList.add('border-blue-500', 'bg-blue-100', 'text-blue-800');
                button.classList.remove('border-gray-200', 'bg-gray-50', 'text-gray-600', 'hover:bg-gray-100');
            });
        });

        document.getElementById('scan-final-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const position = document.getElementById('scan-final-position').value;
            const quantity = parseInt(document.getElementById('scan-final-quantity').value);
            const finalLocationId = `${baseLocation}-${position}`;
            
            await registerEntry(product, quantity, finalLocationId);
            closeModal();
        });
    }

    function showExitFinalModal(product, baseLocation) {
        const itemsInBaseLocation = inventory
            .map((item, index) => ({...item, index}))
            .filter(item => item.locationId.startsWith(`${baseLocation}-`) && item.productId === product.id);
        
        if(itemsInBaseLocation.length === 0) {
            showToast(`Produto ${product.nomeCompleto} não encontrado na posição ${baseLocation}.`, 'error');
            closeModal();
            return;
        }

        const content = `
            <form id="scan-final-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Confirmar Saída</h3>
                <div class="bg-gray-100 p-3 rounded-md">
                    <p class="font-semibold">${product.nomeCompleto}</p>
                    <p class="text-sm text-gray-600">Da Posição: ${baseLocation}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Lote Específico</label>
                    <select id="scan-final-item" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        ${itemsInBaseLocation.map(item => `<option value="${item.index}">(${item.locationId}) - ${item.quantity} caixas</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade a Retirar</label>
                    <input type="number" id="scan-final-quantity" value="1" min="1" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirmar Saída</button>
                </div>
            </form>
        `;
        showModal(content);

        const itemSelect = document.getElementById('scan-final-item');
        const quantityInput = document.getElementById('scan-final-quantity');
        const updateMax = () => {
            const selectedItem = inventory[itemSelect.value];
            if(selectedItem) quantityInput.max = selectedItem.quantity;
        };
        itemSelect.addEventListener('change', updateMax);
        updateMax();

        document.getElementById('scan-final-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inventoryIndex = parseInt(itemSelect.value);
            const quantity = parseInt(quantityInput.value);
            
            await registerExit(inventoryIndex, quantity);
            closeModal();
        });
    }

    function showExitFromMapModal(inventoryIndex) {
        const item = inventory[inventoryIndex];
        if(!item) return;
        const product = productList.find(p => p.id === item.productId);

        const content = `
            <form id="map-exit-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Registrar Saída Rápida</h3>
                 <div class="bg-gray-100 p-3 rounded-md">
                    <p class="font-semibold">${product?.nomeCompleto || 'Produto desconhecido'}</p>
                    <p class="text-sm text-gray-600">De: ${item.locationId}</p>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Quantidade a Retirar</label>
                    <input type="number" id="map-exit-quantity" value="1" min="1" max="${item.quantity}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirmar Saída</button>
                </div>
            </form>
        `;
        showModal(content);
        document.getElementById('map-exit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const quantity = parseInt(document.getElementById('map-exit-quantity').value);
            await registerExit(inventoryIndex, quantity);
            closeModal();
        });
    }

    function showAddProductModal() {
        const content = `
            <form id="add-product-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold mb-2">Cadastrar Novo Produto</h3>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Modelo</label>
                    <input type="text" id="new-prod-modelo" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Grade</label>
                    <input type="text" id="new-prod-grade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Material</label>
                    <input type="text" id="new-prod-material" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Variação / Cor</label>
                    <input type="text" id="new-prod-variacao" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="add-prod-cancel" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Salvar Produto</button>
                </div>
            </form>
        `;
        showModal(content);
        document.getElementById('add-prod-cancel').onclick = closeModal;
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProduct = {
                id: productList.length ? Math.max(...productList.map(p => p.id)) + 1 : 1,
                modelo: document.getElementById('new-prod-modelo').value.trim(),
                grade: document.getElementById('new-prod-grade').value.trim(),
                material: document.getElementById('new-prod-material').value.trim(),
                variacao: document.getElementById('new-prod-variacao').value.trim(),
            };
            
            if(!newProduct.modelo || !newProduct.grade || !newProduct.material || !newProduct.variacao) {
                showToast('Todos os campos são obrigatórios.', 'error');
                return;
            }

            productList.push({ ...newProduct, nomeCompleto: `${newProduct.modelo} ${newProduct.grade} ${newProduct.material} ${newProduct.variacao}` });
            await persistProducts();
            showToast('Produto cadastrado com sucesso!');
            closeModal();
            rerenderCurrentPage();
        });
    }
    
    function showPrintProductsModal(products) {
        const labelsHtml = products.map(p => `
            <div class="p-2 border border-gray-300 rounded-lg flex flex-col items-center gap-2 break-inside-avoid">
                <div id="print-qr-${p.id}"></div>
                <p class="text-center text-xs font-semibold">${p.nomeCompleto} {productId:${p.id}}</p>
            </div>
        `).join('');

        const content = `
            <div class="p-6" id="printable-area-container">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Etiquetas de Produto</h3>
                    <div>
                         <button id="download-labels-btn" class="px-3 py-1 rounded-md bg-green-600 text-white hover:bg-green-700 text-sm mr-2">Baixar</button>
                         <button id="print-labels-btn" class="px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700 text-sm">Imprimir</button>
                    </div>
                </div>
                <div id="printable-area" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${labelsHtml}
                </div>
            </div>
        `;
        showModal(content, 'max-w-4xl');

        products.forEach(p => {
            new QRCode(document.getElementById(`print-qr-${p.id}`), {
                text: JSON.stringify({ productId: p.id }),
                width: 128,
                height: 128,
            });
        });

        document.getElementById('print-labels-btn').onclick = () => window.print();
        document.getElementById('download-labels-btn').onclick = async () => {
            for(const p of products) {
                const qrEl = document.getElementById(`print-qr-${p.id}`);
                const canvas = qrEl.querySelector('canvas');
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `produto-${p.id}-${p.modelo}-${p.variacao}.png`;
                link.href = dataUrl;
                link.click();
                await new Promise(r => setTimeout(r, 100));
            }
        };
    }

    const showAdminLoginModal = () => {
      const content = `
        <form id="admin-login-form" class="p-6 space-y-4 relative">
            <button type="button" id="admin-login-close" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 class="text-2xl font-bold">Acesso Restrito</h2>
            <p class="text-sm text-gray-600">Insira a senha de administrador.</p>
            <div>
                <label class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="password" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Entrar</button>
        </form>`;
      showModal(content);
      document.getElementById('admin-login-form').addEventListener('submit', e => {
        e.preventDefault();
        const pw = document.getElementById('password').value;
        if (pw === adminPassword) { adminAuthenticated = true; closeModal(); renderAdmin(); }
        else showToast('Senha incorreta!', 'error');
      });
      document.getElementById('admin-login-close').addEventListener('click', () => {
          closeModal();
          goTo(lastVisitedHash);
      });
    };

    const showCustomConfirm = (msg, onConfirm) => {
        const content = `
        <div class="p-6">
          <h3 class="text-lg font-bold mb-4">Confirmação Necessária</h3>
          <p class="text-gray-700 mb-6">${msg}</p>
          <div class="flex justify-end gap-3">
            <button id="confirm-cancel" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Cancelar</button>
            <button id="confirm-ok" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirmar</button>
          </div>
        </div>`;
      showModal(content);
      document.getElementById('confirm-ok').onclick = () => { closeModal(); onConfirm(); };
      document.getElementById('confirm-cancel').onclick = closeModal;
    };

    const showToast = (message, type='success') => {
      const toast = document.createElement('div');
      let bgColor = 'bg-green-500';
      if (type === 'error') bgColor = 'bg-red-500';
      if (type === 'info') bgColor = 'bg-blue-500';
      
      toast.className = `fixed bottom-24 md:bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg ${bgColor} z-50`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    };

    // --- NAVEGAÇÃO E INICIALIZAÇÃO ---
    const goTo = (hash) => {
        if (window.location.hash === hash) {
            rerenderCurrentPage();
        } else {
            window.location.hash = hash;
        }
    };
    
    const navigate = () => {
      const hash = window.location.hash || '#home';
      if (hash !== '#admin' && hash !== '#produtos' && hash !== '#etiquetas') {
          lastVisitedHash = hash;
      }
      
      const pageId = `page-${hash.substring(1)}`;
      
      if((hash === '#produtos' || hash === '#etiquetas') && !adminAuthenticated) {
          goTo('#admin');
          return;
      }

      pages.forEach(p => p.classList.toggle('hidden', p.id !== pageId));
      menuItems.forEach(i => i.classList.toggle('active', i.getAttribute('href') === hash));
      rerenderCurrentPage();
    };
    
    const rerenderCurrentPage = () => {
      const hash = window.location.hash || '#home';
      let title = 'Dashboard';
      switch (hash) {
        case '#home': renderDashboard(); break;
        case '#entrada': title='Entrada'; renderEntrada(); break;
        case '#saida': title='Saída'; renderSaida(); break;
        case '#mapa': title='Mapa'; renderMap(); break;
        case '#produtos': title='Produtos'; renderProdutos(); break;
        case '#relatorios': title='Relatórios'; renderReports(); break;
        case '#etiquetas': title='Etiquetas de Posição'; renderEtiquetas(); break;
        case '#historico': title='Histórico'; renderHistory(); break;
        case '#admin': title='Admin'; renderAdmin(); break;
      }
      if (headerTitle) headerTitle.textContent = title;
    };

    window.addEventListener('hashchange', navigate);
    window.closeModal = closeModal;
    
    (async () => {
        await loadAllDataFromServer();
        navigate();
        setInterval(loadAllDataFromServer, 5000);
    })();

  });
  </script>
</body>
</html>

